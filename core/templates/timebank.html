<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HIVE | Time Bank</title>
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* SweetAlert2 z-index override - sidebar'dan y√ºksek olmalƒ± */
    .swal2-container {
      z-index: 10000 !important;
    }
    .swal2-container.swal2-backdrop-show {
      z-index: 10000 !important;
    }
    :root{
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg: #f3f4f6; --text: #1f2937;
    }
    *{box-sizing:border-box;margin:0;padding:0;outline:none;font-family:'Segoe UI',sans-serif}
    body{background:var(--primary);min-height:100vh;padding:20px;color:var(--text)}
    .hidden{display:none !important}
    .app{max-width:1100px;margin:0 auto;padding-bottom:100px;position:relative}

    header{background:#fff;border-radius:24px;padding:16px 24px;margin-bottom:24px;display:flex;justify-content:space-between;box-shadow:0 10px 40px rgba(0,0,0,0.15);position:relative;z-index:50}
    .logo{font-size:26px;font-weight:900;background:var(--primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:8px}
    .actions{display:flex;align-items:center;gap:12px;position:relative}
    
    .pill{background:#f3f4f6;padding:8px 16px;border-radius:99px;font-weight:700;color:#555;font-size:14px}
    .icon-btn{width:44px;height:44px;border-radius:50%;border:0;cursor:pointer;background:#f3f4f6;font-size:18px;display:grid;place-items:center;position:relative;transition:0.2s}
    .icon-btn:hover{background:#e5e7eb;transform:translateY(-2px)}
    .profile-btn{background:var(--primary);color:#fff;font-weight:700;font-size:14px;border:2px solid #fff}
    .notif-badge{position:absolute;top:-2px;right:-2px;background:#ef4444;color:#fff;width:18px;height:18px;border-radius:50%;font-size:10px;font-weight:800;display:grid;place-items:center;opacity:0;transform:scale(0);transition:0.2s}
    .notif-badge.show{opacity:1;transform:scale(1)}

    .profile-menu{position:absolute;top:70px;right:0;width:220px;background:#fff;border-radius:16px;padding:16px;box-shadow:0 15px 50px rgba(0,0,0,0.2);z-index:100;display:none;flex-direction:column;gap:10px}
    .profile-menu.show{display:flex}
    .pm-btn{background:#fee2e2;color:#dc2626;border:0;padding:10px;border-radius:10px;font-weight:700;cursor:pointer;width:100%}
    .pm-btn:hover{background:#fecaca}
    .notifications-dropdown{position:absolute;top:70px;right:0;width:420px;max-height:600px;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.15);z-index:5000;display:none;flex-direction:column;overflow:hidden}
    .notifications-dropdown.show{display:flex}
    .notif-header{padding:20px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;background:#fff;position:sticky;top:0;z-index:10}
    .notif-header h3{margin:0;font-size:18px;font-weight:800;color:#1f2937}
    .notif-close-btn{width:32px;height:32px;border-radius:50%;border:0;background:#f3f4f6;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#666;transition:all .2s;font-size:16px}
    .notif-close-btn:hover{background:#e5e7eb;color:#333}
    .notif-body{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .notif-card{background:#fff;border:1px solid #f0f0f0;border-radius:16px;padding:16px;display:flex;gap:14px;transition:all .2s;cursor:pointer;position:relative}
    .notif-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateY(-2px);border-color:#e5e7eb}
    .notif-card.unread{background:#f8fafc;border-color:#e0f2fe}
    .notif-icon-box{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
    .notif-icon-box.accepted{background:#d1fae5;color:#059669}
    .notif-icon-box.message{background:#dbeafe;color:#2563eb}
    .notif-icon-box.time-credit{background:#fed7aa;color:#ea580c}
    .notif-icon-box.warning{background:#fef3c7;color:#d97706}
    .notif-icon-box.pending{background:#e0e7ff;color:#6366f1}
    .notif-content{flex:1;min-width:0}
    .notif-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;gap:12px}
    .notif-title{font-weight:700;font-size:15px;color:#1f2937;margin:0;flex:1}
    .notif-date{font-size:11px;color:#9ca3af;font-weight:500;white-space:nowrap}
    .notif-message{font-size:14px;color:#4b5563;line-height:1.5;margin:0;margin-top:4px}
    .notif-empty{padding:40px 20px;text-align:center;color:#9ca3af;font-size:14px}
    .notifications-dropdown{position:absolute;top:70px;right:0;width:420px;max-height:600px;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.15);z-index:5000;display:none;flex-direction:column;overflow:hidden}
    .notifications-dropdown.show{display:flex}
    .notif-header{padding:20px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;background:#fff;position:sticky;top:0;z-index:10}
    .notif-header h3{margin:0;font-size:18px;font-weight:800;color:#1f2937}
    .notif-close-btn{width:32px;height:32px;border-radius:50%;border:0;background:#f3f4f6;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#666;transition:all .2s;font-size:16px}
    .notif-close-btn:hover{background:#e5e7eb;color:#333}
    .notif-body{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .notif-card{background:#fff;border:1px solid #f0f0f0;border-radius:16px;padding:16px;display:flex;gap:14px;transition:all .2s;cursor:pointer;position:relative}
    .notif-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateY(-2px);border-color:#e5e7eb}
    .notif-card.unread{background:#f8fafc;border-color:#e0f2fe}
    .notif-icon-box{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
    .notif-icon-box.accepted{background:#d1fae5;color:#059669}
    .notif-icon-box.message{background:#dbeafe;color:#2563eb}
    .notif-icon-box.time-credit{background:#fed7aa;color:#ea580c}
    .notif-icon-box.warning{background:#fef3c7;color:#d97706}
    .notif-icon-box.pending{background:#e0e7ff;color:#6366f1}
    .notif-content{flex:1;min-width:0}
    .notif-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;gap:12px}
    .notif-title{font-weight:700;font-size:15px;color:#1f2937;margin:0;flex:1}
    .notif-date{font-size:11px;color:#9ca3af;font-weight:500;white-space:nowrap}
    .notif-message{font-size:14px;color:#4b5563;line-height:1.5;margin:0;margin-top:4px}
    .notif-empty{padding:40px 20px;text-align:center;color:#9ca3af;font-size:14px}

    .hero{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
    .cta{background:#fff;padding:24px;border-radius:20px;display:flex;align-items:center;justify-content:center;gap:12px;font-weight:800;font-size:18px;color:#333;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.06);transition:transform .2s;text-decoration:none}
    .cta:hover{transform:translateY(-3px)}
    .cta.primary{background:var(--primary);color:#fff}

    /* TABS FIX: Centered & width:auto */
    .tabs-container{display:flex;justify-content:center;margin-bottom:24px}
    .tabs{background:#fff;padding:6px;border-radius:99px;display:inline-flex;gap:6px;box-shadow:0 8px 24px rgba(0,0,0,0.08);width:auto}
    .tab{padding:10px 24px;border-radius:99px;border:0;background:transparent;font-weight:700;color:#6b7280;cursor:pointer;transition:0.2s;font-size:14px;white-space:nowrap}
    .tab.active{background:var(--primary);color:#fff}
    .search-container{background:#fff;border-radius:16px;padding:16px;margin-bottom:24px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .search-box{width:100%;padding:14px 20px;border-radius:12px;border:2px solid #e5e7eb;font-size:15px;outline:none;transition:border-color .2s}
    .search-box:focus{border-color:#667eea}
    .search-box::placeholder{color:#9ca3af}
    
    .sub-tabs{display:flex;gap:10px;margin-bottom:16px;padding:0 4px}
    .sub-tab{padding:8px 16px;border-radius:12px;border:0;background:rgba(255,255,255,0.2);color:#fff;font-weight:700;cursor:pointer;font-size:13px}
    .sub-tab.active{background:#fff;color:#667eea;box-shadow:0 4px 10px rgba(0,0,0,0.1)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:20px}
    .card{background:#fff;border-radius:20px;padding:22px;box-shadow:0 4px 12px rgba(0,0,0,0.05);position:relative;display:flex;flex-direction:column;transition:transform .2s;z-index:1}
    .card:hover{transform:translateY(-4px); box-shadow:0 12px 30px rgba(0,0,0,0.1)}
    .card-cat{position:absolute;top:20px;right:20px;font-size:11px;font-weight:800;background:#ede9fe;color:#7c3aed;padding:5px 10px;border-radius:99px}
    .card h3{font-size:20px;margin-bottom:8px;padding-right:60px;font-weight:800}
    .card p{color:#666;font-size:14px;line-height:1.5;margin-bottom:16px;flex:1}
    .card-meta{display:flex;justify-content:space-between;align-items:center;font-size:13px;font-weight:700;color:#888;border-top:1px solid #f0f0f0;padding-top:14px;margin-top:auto}
    
    .action-btn{width:100%;margin-top:16px;padding:12px;border:0;border-radius:12px;background:#f3f4f6;font-weight:800;cursor:pointer;color:#333;transition:background .2s;position:relative;z-index:10}
    .action-btn:hover{background:#e5e7eb}
    .action-btn.disabled{opacity:0.6;cursor:not-allowed;background:#eee}

    .inbox-list{display:flex;flex-direction:column;gap:12px}
    .inbox-item{background:#fff;padding:16px;border-radius:18px;display:flex;gap:16px;cursor:pointer;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.04);transition:transform .2s}
    .inbox-item:hover{transform:translateX(5px)}
    .inbox-icon{width:50px;height:50px;border-radius:14px;background:#eef2ff;display:grid;place-items:center;font-size:24px}
    .inbox-info{flex:1}
    .delete-listing-btn{width:36px;height:36px;border-radius:10px;border:0;background:#fee2e2;color:#dc2626;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0}
    .delete-listing-btn:hover{background:#fecaca;transform:scale(1.1)}
    .status-badge{font-size:10px;padding:4px 8px;border-radius:6px;font-weight:800;text-transform:uppercase}
    .st-pending{background:#fff7ed;color:#c2410c}
    .st-accepted{background:#ecfdf5;color:#047857}
    .st-date_proposed{background:#eff6ff;color:#1d4ed8}
    .st-scheduled{background:#f0f9ff;color:#0369a1}
    .st-completed{background:#eef2ff;color:#4338ca}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
    .modal-overlay.open{display:flex}
    .sheet{position:fixed;top:0;right:-100%;width:100%;max-width:480px;height:100%;background:#fff;z-index:1500;transition:right .3s;box-shadow:-10px 0 60px rgba(0,0,0,0.2);display:flex;flex-direction:column}
    .sheet.open{right:0}
    .sheet-head{padding:20px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:16px}
    .sheet-body{flex:1;overflow-y:auto;padding:20px;background:#f9fafb}

    /* FORM STYLE (FIXED) */
    .form-style .field{margin-bottom:16px}
    .form-style .label{display:block;margin-bottom:8px;font-weight:700;font-size:14px;color:#4b5563}
    .form-style .input{width:100%;padding:14px;border-radius:12px;border:2px solid #e5e7eb;font-size:15px;background:#fff;font-family:inherit;color:inherit;line-height:1.5}
    .form-style .btn{width:100%;padding:14px;border-radius:12px;border:0;font-weight:800;background:var(--primary);color:#fff;cursor:pointer;font-size:15px;display:block}
    .map-container{width:100%;height:300px;border-radius:12px;border:2px solid #e5e7eb;margin-bottom:16px;overflow:hidden}
    .map-search{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;margin-bottom:12px;font-size:14px}
    .search-results{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:none;margin-top:4px}
    .search-result-item{padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s}
    .search-result-item:hover{background:#f9fafb}
    .search-result-item:last-child{border-bottom:0}
    .search-result-title{font-weight:700;font-size:14px;color:#1f2937;margin-bottom:4px}
    .search-result-details{font-size:12px;color:#6b7280}
    .search-container-relative{position:relative}
    .image-upload-area{width:100%;min-height:200px;border:2px dashed #e5e7eb;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#f9fafb;transition:all .2s;position:relative;overflow:hidden}
    .image-upload-area:hover{border-color:#667eea;background:#f0f4ff}
    .image-upload-area.has-image{border-style:solid;border-color:#667eea;padding:0}
    .image-upload-area.has-image:hover{border-color:#764ba2}
    .image-upload-placeholder{text-align:center;padding:20px;color:#6b7280;font-size:14px}
    .image-upload-placeholder strong{display:block;margin-bottom:8px;color:#4b5563;font-size:16px}
    .image-preview{width:100%;height:100%;object-fit:cover;display:none}
    .image-preview.show{display:block}
    .image-remove-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.6);color:#fff;border:0;border-radius:50%;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;z-index:10;transition:background .2s}
    .image-remove-btn:hover{background:rgba(0,0,0,0.8)}
    .main-map-container{width:100%;height:500px;border-radius:20px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,0.06);margin-bottom:24px;background:#fff}
    .detail-sidebar{position:fixed;top:0;right:-100%;width:100%;max-width:420px;height:100%;background:#fff;z-index:1600;transition:right .3s;box-shadow:-10px 0 60px rgba(0,0,0,0.2);display:flex;flex-direction:column;overflow-y:auto}
    .detail-sidebar.open{right:0}
    .detail-sidebar-header{padding:20px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;background:#fff;position:sticky;top:0;z-index:10}
    .detail-sidebar-body{padding:20px;flex:1}
    .detail-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:800;text-transform:uppercase;margin-bottom:12px;letter-spacing:0.5px}
    .detail-badge.offer{background:#667eea;color:#fff}
    .detail-badge.request{background:#10b981;color:#fff}
    .detail-image{width:100%;height:200px;object-fit:cover;border-radius:12px;margin-bottom:16px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#999;font-size:14px}
    .detail-image img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .detail-title{font-size:24px;font-weight:800;margin-bottom:8px;color:#1f2937}
    .detail-meta{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .detail-meta-item{display:flex;align-items:center;gap:6px;font-size:14px;color:#666}
    .detail-description{color:#4b5563;line-height:1.6;margin-bottom:20px;font-size:15px}
    .detail-address{background:#f9fafb;padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;color:#666}
    .detail-actions{display:flex;gap:10px;margin-top:20px}
    .detail-btn{flex:1;padding:12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;font-size:14px;transition:transform .2s;display:flex;align-items:center;justify-content:center;gap:8px}
    .detail-btn:hover{transform:translateY(-2px)}
    .detail-btn.primary{background:var(--primary);color:#fff}
    .detail-btn.secondary{background:#f3f4f6;color:#333}
    .detail-btn.danger{background:#fee2e2;color:#dc2626}
    .detail-btn.danger:hover{background:#fecaca}

    .chat-area{flex:1;display:flex;flex-direction:column;gap:12px;padding:20px;padding-bottom:30px}
    .chat-bubble{max-width:80%;padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.5;box-shadow:0 2px 5px rgba(0,0,0,0.03)}
    .chat-bubble.me{align-self:flex-end;background:var(--primary);color:#fff;border-bottom-right-radius:4px}
    .chat-bubble.them{align-self:flex-start;background:#fff;color:#333;border:1px solid #eee;border-bottom-left-radius:4px}
    .chat-footer{padding:16px;background:#fff;border-top:1px solid #eee;display:flex;gap:10px;align-items:center}
    .chat-input{flex:1;padding:12px 16px;border-radius:99px;border:2px solid #e5e7eb;outline:none}
    
    .action-bar-modern{margin:-20px -20px 10px -20px;padding:20px;background:#fff;border-bottom:1px solid #eee;display:flex;flex-direction:column;gap:12px}
    .ab-header{display:flex;justify-content:space-between;align-items:center}
    .ab-title{font-weight:800;font-size:16px;color:#1f2937}
    .ab-content{background:#f0f9ff;border:1px solid #e0f2fe;padding:14px;border-radius:12px;font-size:14px;color:#0c4a6e;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .ab-content.success{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .ab-btn{padding:8px 16px;border-radius:8px;border:0;font-weight:700;cursor:pointer;color:#fff;font-size:13px;white-space:nowrap}
    .green{background:#10b981} .red{background:#ef4444} .blue{background:#3b82f6}

    .toast{position:fixed;bottom:30px;right:30px;background:#1f2937;color:#fff;padding:12px 24px;border-radius:12px;font-weight:700;z-index:3000;box-shadow:0 10px 30px rgba(0,0,0,0.2);animation:slideUp .3s}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.hero{grid-template-columns:1fr}.sheet{width:100%}}
  </style>
</head>
<body>

  <div class="modal-overlay" id="authModal">
    <div style="background:#fff;width:100%;max-width:400px;border-radius:24px;padding:36px;box-shadow:0 25px 50px rgba(0,0,0,0.25)" class="form-style">
      <h2 style="text-align:center;margin-bottom:24px;font-size:32px;background:var(--primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900">üöÄ HIVE</h2>
      <div style="display:flex;gap:10px;background:#f3f4f6;padding:5px;border-radius:14px;margin-bottom:24px">
        <button id="tabLogin" class="tab active" style="text-align:center;flex:1">Login</button>
        <button id="tabSignup" class="tab" style="text-align:center;flex:1">Sign Up</button>
      </div>
      <form id="loginForm">
        <div class="field"><label class="label">Username</label><input class="input" name="username" required></div>
        <div class="field"><label class="label">Password</label><input class="input" type="password" name="password" required></div>
        <button type="submit" class="btn">Login</button>
      </form>
      <form id="signupForm" class="hidden">
        <div class="field"><label class="label">Username</label><input class="input" name="username" required></div>
        <div class="field"><label class="label">Email</label><input class="input" name="email" required></div>
        <div class="field"><label class="label">Password</label><input class="input" type="password" name="password" required></div>
        <div class="field"><label class="label">Confirm</label><input class="input" type="password" name="confirm" required></div>
        <button type="submit" class="btn">Create Account</button>
      </form>
    </div>
  </div>

  <div class="app hidden" id="app">
    <header>
      <div class="logo">‚è∞ HIVE</div>
      <div class="actions">
        <div class="pill balance">‚è±Ô∏è <span id="balanceDisplay">0h</span></div>
        <button class="icon-btn" id="notifBtn" title="Notifications" style="position:relative">
          <i class="fas fa-bell"></i>
          <span class="notif-badge" id="notifBadge">0</span>
        </button>
        <button class="icon-btn" onclick="loadView('inbox')" title="Inbox">üí¨</button>
        <button class="icon-btn profile-btn" id="headerProfileBtn">JD</button>
        <div class="profile-menu" id="profileMenu">
          <div class="pm-info"><b id="menuUsername" style="font-size:16px">User</b></div>
          <button class="pm-btn" id="logoutBtn">Logout</button>
        </div>
        <div class="notifications-dropdown" id="notificationsDropdown">
          <div class="notif-header">
            <h3>Notifications</h3>
            <button class="notif-close-btn" onclick="closeNotifications()" title="Close">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="notif-body" id="notificationsBody">
            <div class="notif-empty">Loading notifications...</div>
          </div>
        </div>
      </div>
    </header>

    <div class="hero">
      <div class="cta primary" id="btnOffer"><span style="font-size:22px">‚ûï</span> Offer Service</div>
      <div class="cta" id="btnRequest"><span style="font-size:22px">üîé</span> Request Help</div>
    </div>

    <div class="main-map-container" id="mainMapContainer">
      <div id="mainMap" style="width:100%;height:100%"></div>
    </div>

    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" data-view="all">ALL</button>
        <button class="tab" data-view="offers">Offers</button>
        <button class="tab" data-view="requests">Requests</button>
        <button class="tab" data-view="inbox">Inbox</button>
      </div>
    </div>

    <div id="mainContent">
      <div class="search-container" id="searchContainer" style="display:none">
        <input type="text" class="search-box" id="searchInput" placeholder="üîç Search listings by title, description, user, location, category...">
      </div>
      <div class="grid" id="gridView"></div>
      
      <div class="hidden" id="inboxContainer">
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="loadInboxSub('chats')">üí¨ Chats</button>
            <button class="sub-tab" onclick="loadInboxSub('listings')">üìã My Listings</button>
        </div>
        <div class="inbox-list" id="inboxContent"></div>
      </div>
    </div>
  </div>

  <aside class="sheet form-style" id="listingSheet">
    <div class="sheet-head"><button onclick="closeSheet('listingSheet')" style="border:0;background:none;font-size:24px;cursor:pointer;color:#666">√ó</button><h3>New Listing</h3></div>
    <div class="sheet-body">
      <form id="listingForm">
        <input type="hidden" id="listingType" value="offer">
        <input type="hidden" id="inpLat" value="">
        <input type="hidden" id="inpLng" value="">
        <div class="field"><label class="label">Title</label><input class="input" id="inpTitle" required placeholder="e.g. Guitar Lessons"></div>
        <div class="field"><label class="label">Category</label><select class="input" id="inpCat"><option>Education</option><option>Tech</option><option>Home</option><option>Art</option><option>Sports</option></select></div>
        <div class="field"><label class="label">Duration (Hours)</label><input type="number" class="input" id="inpDur" value="1" min="1" step="1"></div>
        <div class="field"><label class="label">Description</label><textarea class="input" id="inpDesc" rows="5" required placeholder="Details..."></textarea></div>
        <div class="field">
          <label class="label">Image (Optional)</label>
          <div class="image-upload-area" id="imageUploadArea" tabindex="0">
            <div class="image-upload-placeholder" id="imagePlaceholder">
              <strong>üì∑ Click or Paste Image</strong>
              <div>Press Ctrl+V to paste from clipboard</div>
            </div>
            <img id="imagePreview" class="image-preview" alt="Preview">
            <button type="button" class="image-remove-btn" id="imageRemoveBtn" onclick="removeImage()" style="display:none">√ó</button>
          </div>
          <input type="file" id="imageFileInput" accept="image/*" style="display:none">
        </div>
        <div class="field">
          <label class="label">Location</label>
          <div class="search-container-relative">
            <input type="text" class="map-search" id="locationSearch" placeholder="Search address or click on map..." autocomplete="off">
            <div id="searchResults" class="search-results"></div>
          </div>
          <div id="locationMap" class="map-container"></div>
          <input type="text" class="input" id="inpAddress" placeholder="Selected address will appear here" readonly style="margin-top:8px">
        </div>
        <button type="submit" class="btn">Post Listing</button>
      </form>
    </div>
  </aside>

  <aside class="sheet" id="chatSheet">
    <div class="sheet-head"><button onclick="closeSheet('chatSheet')" style="border:0;background:none;font-size:24px;cursor:pointer">‚Üê</button><h3>Chat</h3></div>
    <div class="sheet-body" style="padding:0">
      <div id="actionBar" class="action-bar-modern" style="display:none"></div>
      <div class="chat-area" id="msgArea"></div>
      <form class="chat-footer" id="msgForm">
        <input class="chat-input" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="send-btn" style="width:46px;height:46px;border-radius:50%;border:0;background:var(--primary);color:#fff;cursor:pointer">‚û§</button>
      </form>
    </div>
  </aside>

  <aside class="detail-sidebar" id="detailSidebar">
    <div class="detail-sidebar-header">
      <h3 style="margin:0;font-size:20px;font-weight:800">Listing Details</h3>
      <button onclick="closeDetailSidebar()" style="border:0;background:none;font-size:24px;cursor:pointer;color:#666;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">√ó</button>
    </div>
    <div class="detail-sidebar-body" id="detailSidebarBody">
      <!-- ƒ∞√ßerik dinamik olarak doldurulacak -->
    </div>
  </aside>

  <script>
    const API = '/api';
    let TOKEN = localStorage.getItem('token');
    let USER = JSON.parse(localStorage.getItem('user') || '{}');
    let CURRENT_VIEW = 'offers';
    let CURRENT_INBOX_SUB = 'chats'; 
    let ACTIVE_CHAT_ID = null;
    let POLLER = null;
    let LAST_RENDER_KEY = "";
    let USER_BALANCE = 0;
    
    // Arama deƒüi≈ükenleri (en √ºstte tanƒ±mla - hoisting sorununu √∂nlemek i√ßin)
    let allListings = [];
    let currentListingType = 'offers';
    let listingsData = null;

    const $ = s => document.querySelector(s);
    const toast = m => { const d=document.createElement('div');d.className='toast';d.innerText=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000) };

    if(TOKEN) initApp(); else $('#authModal').classList.add('open');

    $('#loginForm').onsubmit = e => { e.preventDefault(); authReq('/login/', {username:e.target.username.value, password:e.target.password.value}); };
    $('#signupForm').onsubmit = e => { 
      e.preventDefault(); 
      if(e.target.password.value!==e.target.confirm.value){
        Swal.fire({
          icon: 'error',
          title: 'Password Mismatch',
          text: 'Passwords do not match',
          confirmButtonColor: '#3085d6',
          timer: 3000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        return;
      }
      authReq('/register/', {username:e.target.username.value, email:e.target.email.value, password:e.target.password.value}, true); 
    };
    
    async function authReq(url, body, isSign=false){
      const res = await fetch(API+url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      const data = await res.json();
      if(res.ok){
        if(isSign){ 
        Swal.fire({
          icon: 'success',
          title: 'Account Created!',
          text: 'Please login now.',
          timer: 3000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
          $('#tabLogin').click(); 
        }
        else { localStorage.setItem('token',data.access); localStorage.setItem('user',JSON.stringify({username:body.username})); TOKEN=data.access; USER={username:body.username}; initApp(); }
      } else {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.error || 'An error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    function initApp(){
      $('#authModal').classList.remove('open'); $('#app').classList.remove('hidden');
      $('#headerProfileBtn').innerText = USER.username.substring(0,2).toUpperCase();
      $('#menuUsername').innerText = USER.username;
      fetchProfile(); loadView('all'); checkNotifications();
      // Ana haritayƒ± ba≈ülat - biraz gecikme ile (DOM hazƒ±r olsun)
      setTimeout(() => initMainMap(), 100);
      setInterval(() => { if(!ACTIVE_CHAT_ID) { fetchProfile(); checkNotifications(); } }, 5000); 
      setupPasteHandlers();
    }
    
    // Paste event handler - Yapƒ±≈ütƒ±rƒ±lan i√ßeriƒüi uygulama stillerine uyarla
    function setupPasteHandlers() {
      // Form alanlarƒ± i√ßin paste handler
      const formFields = ['#inpTitle', '#inpDesc', '#msgInput'];
      
      formFields.forEach(selector => {
        const element = $(selector);
        if(element) {
          element.addEventListener('paste', function(e) {
            e.preventDefault();
            
            // Clipboard'dan plain text al
            const pastedText = (e.clipboardData || window.clipboardData).getData('text/plain');
            
            // Mevcut se√ßili metni al
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const currentValue = this.value;
            
            // Yeni deƒüeri olu≈ütur (se√ßili metni yapƒ±≈ütƒ±rƒ±lan metinle deƒüi≈ütir)
            const newValue = currentValue.substring(0, start) + pastedText + currentValue.substring(end);
            
            // Deƒüeri ayarla
            this.value = newValue;
            
            // Cursor pozisyonunu ayarla
            const newCursorPos = start + pastedText.length;
            this.setSelectionRange(newCursorPos, newCursorPos);
            
            // Input event'ini tetikle (form validation i√ßin)
            this.dispatchEvent(new Event('input', { bubbles: true }));
          });
        }
      });
    }

    function initMainMap(){
      if(mainMap) return;
      
      const mapEl = $('#mainMap');
      if(!mapEl) {
        console.error('Main map container not found');
        return;
      }
      
      try {
        mainMap = L.map('mainMap').setView([39.9334, 32.8597], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(mainMap);
        loadMapMarkers();
      } catch(err) {
        console.error('Error initializing main map:', err);
      }
    }

    async function loadMapMarkers(){
      if(!mainMap) return;
      
      // Mevcut marker'larƒ± temizle
      mainMapMarkers.forEach(m => mainMap.removeLayer(m));
      mainMapMarkers = [];

      // T√ºm aktif ilanlarƒ± getir
      const offers = await req('/service-offers/');
      const requests = await req('/service-requests/');

      // Offer marker'larƒ± (mavi)
      offers.forEach(item => {
        if(item.latitude && item.longitude) {
          const marker = L.marker([parseFloat(item.latitude), parseFloat(item.longitude)], {
            icon: L.divIcon({
              className: 'custom-marker offer-marker',
              html: '<div style="background:#667eea;width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></div>',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          }).addTo(mainMap);
          marker.on('click', () => openDetailSidebar(item, 'offer'));
          mainMapMarkers.push(marker);
        }
      });

      // Request marker'larƒ± (ye≈üil)
      requests.forEach(item => {
        if(item.latitude && item.longitude) {
          const marker = L.marker([parseFloat(item.latitude), parseFloat(item.longitude)], {
            icon: L.divIcon({
              className: 'custom-marker request-marker',
              html: '<div style="background:#10b981;width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></div>',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          }).addTo(mainMap);
          marker.on('click', () => openDetailSidebar(item, 'request'));
          mainMapMarkers.push(marker);
        }
      });
    }
    
    // Haritayƒ± yenile (marker'larƒ± g√ºncelle)
    function updateMapMarkers() {
      if(mainMap) {
        loadMapMarkers();
      }
    }
    
    window.updateMapMarkers = updateMapMarkers;

    function openDetailSidebar(item, type) {
      currentDetailItem = {item, type};
      const body = $('#detailSidebarBody');
      const isOwn = item.user_info.username === USER.username;
      
      // Badge HTML
      const badgeClass = type === 'offer' ? 'offer' : 'request';
      const badgeText = type === 'offer' ? 'OFFER' : 'REQUEST';
      
      // Resim HTML - sadece resim varsa g√∂ster
      const imageHtml = item.image_url ? 
        `<div class="detail-image"><img src="${item.image_url}" alt="${item.title}"></div>` : '';
      
      body.innerHTML = `
        <span class="detail-badge ${badgeClass}">${badgeText}</span>
        ${imageHtml}
        <h2 class="detail-title">${item.title}</h2>
        <div class="detail-meta">
          <div class="detail-meta-item"><span>üë§</span> <span>${item.user_info.username}</span></div>
          <div class="detail-meta-item"><span>‚è±Ô∏è</span> <span>${item.duration}h</span></div>
          <div class="detail-meta-item"><span>üìÇ</span> <span>${item.category}</span></div>
          <div class="detail-meta-item"><span>üìÖ</span> <span>${formatDate(item.created_at)}</span></div>
        </div>
        <div class="detail-description">${item.description}</div>
        ${item.address ? `<div class="detail-address">üìç ${item.address}</div>` : ''}
        ${!isOwn ? `
          <div class="detail-actions">
            <button class="detail-btn primary" onclick="startChatFromDetail(${item.id}, '${type}')">Contact</button>
            <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
          </div>
        ` : `
          <div class="detail-actions">
            <button class="detail-btn danger" onclick="deleteListingFromDetail(${item.id}, '${type}')">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
            <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
          </div>
        `}
      `;
      $('#detailSidebar').classList.add('open');
    }

    function closeDetailSidebar() {
      $('#detailSidebar').classList.remove('open');
      currentDetailItem = null;
    }

    window.closeDetailSidebar = closeDetailSidebar;

    function startChatFromDetail(id, type) {
      closeDetailSidebar();
      startChat(id, type);
    }
    
    // Detail sidebar'dan silme
    async function deleteListingFromDetail(id, type) {
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
      });
      
      if(!result.isConfirmed) {
        return;
      }
      
      try {
        const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
        const deleteResult = await req(endpoint, 'DELETE');
        if(deleteResult.error) {
          await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: deleteResult.error,
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        
        Swal.fire({
          icon: 'success',
          title: 'Deleted!',
          text: 'Listing deleted successfully!',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        
        closeDetailSidebar();
        // Listeleri yenile
        if(currentListingType) {
          fetchListings(currentListingType);
        }
        fetchMyListings();
        // Haritayƒ± da yenile
        if(window.mainMap) {
          updateMapMarkers();
        }
      } catch(err) {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Unknown error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    window.deleteListingFromDetail = deleteListingFromDetail;

    $('#headerProfileBtn').onclick = e => { e.stopPropagation(); $('#profileMenu').classList.toggle('show'); };
    document.onclick = e => { if(!e.target.closest('.actions')) $('#profileMenu').classList.remove('show'); };
    $('#logoutBtn').onclick = () => { localStorage.clear(); location.reload(); };

    $('#tabLogin').onclick = () => { $('#loginForm').classList.remove('hidden'); $('#signupForm').classList.add('hidden'); $('#tabLogin').classList.add('active'); $('#tabSignup').classList.remove('active'); };
    $('#tabSignup').onclick = () => { $('#signupForm').classList.remove('hidden'); $('#loginForm').classList.add('hidden'); $('#tabSignup').classList.add('active'); $('#tabLogin').classList.remove('active'); };

    document.querySelectorAll('.tab[data-view]').forEach(b => b.onclick = () => loadView(b.dataset.view));

    function loadView(view){
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.view===view));
      if(view === 'inbox') {
        $('#gridView').classList.add('hidden');
        $('#inboxContainer').classList.remove('hidden');
        $('#searchContainer').style.display = 'none';
        loadInboxSub('chats');
      } else {
        $('#gridView').classList.remove('hidden');
        $('#inboxContainer').classList.add('hidden');
        $('#searchContainer').style.display = 'block';
        // Arama kutusunu sƒ±fƒ±rla
        $('#searchInput').value = '';
        fetchListings(view);
      }
    }

    window.loadInboxSub = function(sub){
        CURRENT_INBOX_SUB = sub;
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.toggle('active', t.innerText.toLowerCase().includes(sub)));
        sub==='chats' ? fetchChats() : fetchMyListings();
    }

    // Tarih formatlama fonksiyonu
    function formatDate(dateString) {
      if(!dateString) return '';
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if(diffMins < 1) return 'Just now';
      if(diffMins < 60) return `${diffMins}m ago`;
      if(diffHours < 24) return `${diffHours}h ago`;
      if(diffDays < 7) return `${diffDays}d ago`;
      
      // Daha eski tarihler i√ßin tam format
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined }) + 
             ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Arama fonksiyonu
    function filterListings(searchTerm) {
      if(!searchTerm || searchTerm.trim() === '') {
        // Arama terimi yoksa t√ºm ilanlarƒ± g√∂ster
        renderListings(allListings);
        return;
      }
      
      // allListings bo≈üsa, √∂nce fetch et
      if(!allListings || allListings.length === 0) {
        const type = currentListingType || 'all';
        fetchListings(type);
        return;
      }
      
      const term = searchTerm.toLowerCase().trim();
      const filtered = allListings.filter(item => {
        // Ba≈ülƒ±kta ara
        if(item.title && item.title.toLowerCase().includes(term)) return true;
        // A√ßƒ±klamada ara
        if(item.description && item.description.toLowerCase().includes(term)) return true;
        // Kullanƒ±cƒ± adƒ±nda ara
        if(item.user_info && item.user_info.username && item.user_info.username.toLowerCase().includes(term)) return true;
        // Konumda ara
        if(item.address && item.address.toLowerCase().includes(term)) return true;
        // Kategoride ara
        if(item.category && item.category.toLowerCase().includes(term)) return true;
        return false;
      });
      
      renderListings(filtered);
    }
    
    // Listeleri render et
    function renderListings(listings) {
      const gridEl = $('#gridView');
      
      if(!listings || listings.length === 0) {
        gridEl.innerHTML = '<div style="padding:20px;color:#fff;text-align:center;grid-column:1/-1">No listings found.</div>';
        return;
      }
      
      // currentListingType'ƒ± tekil forma √ßevir (offers -> offer, requests -> request, all -> item._type kullan)
      let singularType = 'offer';
      if(currentListingType === 'offers') {
        singularType = 'offer';
      } else if(currentListingType === 'requests') {
        singularType = 'request';
      }
      // all durumunda item._type kullanƒ±lacak
      
      gridEl.innerHTML = listings.map((i, idx)=> {
        // Eƒüer all view'ƒ±ndaysak, item'ƒ±n _type'ƒ±nƒ± kullan
        const itemType = currentListingType === 'all' ? (i._type || 'offer') : singularType;
        const buttonType = currentListingType === 'all' ? (i._type === 'request' ? 'requests' : 'offers') : currentListingType;
        
        return `
        <div class="card" data-item-id="${i.id}" data-item-type="${itemType}" data-item-index="${idx}" style="cursor:pointer">
          <span class="card-cat">${i.category}</span><h3>${i.title}</h3><p>${i.description}</p>
          <div class="card-meta">
            <div class="user-tag"><div class="u-avatar">${i.user_info.username[0].toUpperCase()}</div>${i.user_info.username}</div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
              <div>‚è±Ô∏è ${i.duration}h</div>
              <div style="font-size:11px;color:#999;font-weight:500">${formatDate(i.created_at)}</div>
            </div>
          </div>
          ${getButtonHtml(i, buttonType)}
        </div>`;
      }).join('');
      
      // Her karta click event ekle
      gridEl.querySelectorAll('.card').forEach(card => {
        card.onclick = function(e) {
          // Eƒüer butona tƒ±klandƒ±ysa, butonun i≈ülevini √ßalƒ±≈ütƒ±r (sidebar a√ßma)
          if(e.target.closest('.action-btn')) {
            return; // Butonun kendi onclick'i √ßalƒ±≈üsƒ±n
          }
          const itemId = parseInt(this.dataset.itemId);
          const itemType = this.dataset.itemType; // Bu artƒ±k 'offer' veya 'request' olacak
          const itemIndex = parseInt(this.dataset.itemIndex);
          const item = listings[itemIndex];
          if(item) {
            openDetailSidebar(item, itemType);
          }
        };
      });
    }

    async function req(ep, m='GET', b, isFormData=false){
      try{
        const headers = {'Authorization':`Bearer ${TOKEN}`};
        if(!isFormData && m !== 'DELETE') headers['Content-Type'] = 'application/json';
        
        const fetchOptions = {
          method: m,
          headers: headers
        };
        
        // DELETE i√ßin body g√∂nderme
        if(m !== 'DELETE' && b) {
          fetchOptions.body = isFormData ? b : JSON.stringify(b);
        }
        
        const r = await fetch(API+ep, fetchOptions);
        if(r.status===401){ localStorage.clear(); location.reload(); }
        // DELETE i√ßin bo≈ü response olabilir
        if(r.status === 204 || (m === 'DELETE' && r.status === 200)) {
          return {success: true};
        }
        const data = await r.json();
        return data;
      }catch(err){ 
        console.error('Request failed:', err);
        return {error: err.message || 'Request failed'}; 
      }
    }

    async function fetchProfile(){ const d=await req('/profile/'); if(d) { $('#balanceDisplay').innerText=d.balance+'h'; USER_BALANCE = d.balance; } }
    async function checkNotifications(){ 
      const d=await req('/notifications/count/'); 
      $('#notifBadge').innerText=d.count; 
      $('#notifBadge').classList.toggle('show', d.count>0); 
    }
    
    // Bildirim dropdown fonksiyonlarƒ±
    $('#notifBtn').onclick = function(e) {
      e.stopPropagation();
      const dropdown = $('#notificationsDropdown');
      dropdown.classList.toggle('show');
      if(dropdown.classList.contains('show')) {
        loadNotifications();
      }
    };
    
    // Dƒ±≈üarƒ± tƒ±klandƒ±ƒüƒ±nda kapat
    document.addEventListener('click', function(e) {
      if(!e.target.closest('#notifBtn') && !e.target.closest('#notificationsDropdown')) {
        $('#notificationsDropdown').classList.remove('show');
      }
    });
    
    function closeNotifications() {
      $('#notificationsDropdown').classList.remove('show');
    }
    
    window.closeNotifications = closeNotifications;
    
    // Bildirim t√ºr√ºne g√∂re ikon ve renk belirleme
    function getNotificationIcon(status, type) {
      if(status === 'accepted') {
        return { icon: 'fa-check-circle', class: 'accepted' };
      } else if(status === 'completed') {
        return { icon: 'fa-clock', class: 'time-credit' };
      } else if(status === 'pending') {
        return { icon: 'fa-comment', class: 'message' };
      } else if(status === 'declined' || status === 'cancelled') {
        return { icon: 'fa-exclamation-triangle', class: 'warning' };
      } else {
        return { icon: 'fa-bell', class: 'message' };
      }
    }
    
    // Bildirim ba≈ülƒ±ƒüƒ± olu≈ütur
    function getNotificationTitle(notification) {
      const sender = notification.sender_username;
      const status = notification.status;
      
      if(status === 'pending') {
        return `${sender} sent a request`;
      } else if(status === 'accepted') {
        return `Request accepted`;
      } else if(status === 'completed') {
        return `Transaction completed`;
      } else if(status === 'declined') {
        return `Request declined`;
      } else if(status === 'date_proposed') {
        return `Date proposed`;
      } else if(status === 'scheduled') {
        return `Event scheduled`;
      }
      return `New notification`;
    }
    
    // Bildirim mesajƒ± olu≈ütur
    function getNotificationMessage(notification) {
      const status = notification.status;
      const listingTitle = notification.title || 'Listing';
      
      if(status === 'pending') {
        return `New request for "${listingTitle}"`;
      } else if(status === 'accepted') {
        return `Your request for "${listingTitle}" has been accepted`;
      } else if(status === 'completed') {
        return `Transaction for "${listingTitle}" completed successfully`;
      } else if(notification.message) {
        return notification.message;
      }
      return `Update on "${listingTitle}"`;
    }
    
    // Bildirimleri y√ºkle
    async function loadNotifications() {
      const data = await req('/notifications/list/');
      const notifications = data.notifications || [];
      const body = $('#notificationsBody');
      
      if(notifications.length === 0) {
        body.innerHTML = '<div class="notif-empty"><i class="fas fa-bell-slash" style="font-size:32px;margin-bottom:12px;opacity:0.3"></i><div>No notifications</div></div>';
        return;
      }
      
      body.innerHTML = notifications.map(notif => {
        const iconInfo = getNotificationIcon(notif.status, notif.type);
        const isUnread = notif.status === 'pending';
        const title = getNotificationTitle(notif);
        const message = getNotificationMessage(notif);
        const date = formatDate(notif.created_at);
        
        return `
          <div class="notif-card ${isUnread ? 'unread' : ''}" onclick="handleNotificationClick(${notif.id}, '${notif.status}')">
            <div class="notif-icon-box ${iconInfo.class}">
              <i class="fas ${iconInfo.icon}"></i>
            </div>
            <div class="notif-content">
              <div class="notif-header-row">
                <div class="notif-title">${title}</div>
                <div class="notif-date">${date}</div>
              </div>
              <div class="notif-message">${message}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Bildirime tƒ±klandƒ±ƒüƒ±nda
    function handleNotificationClick(interactionId, status) {
      closeNotifications();
      // Eƒüer pending veya accepted ise chat'e y√∂nlendir
      if(status === 'pending' || status === 'accepted' || status === 'date_proposed' || status === 'scheduled') {
        openChat(interactionId);
      } else {
        loadView('inbox');
      }
    }
    
    window.handleNotificationClick = handleNotificationClick;

    async function fetchListings(type){
      currentListingType = type;
      
      let d = [];
      
      // Eƒüer "all" ise hem offer hem request getir
      if(type === 'all') {
        try {
          const [offers, requests] = await Promise.all([
            req('/service-offers/'),
            req('/service-requests/')
          ]);
          
          const offersList = Array.isArray(offers) ? offers : [];
          const requestsList = Array.isArray(requests) ? requests : [];
          
          // Her iki listeye de type ekle
          offersList.forEach(item => item._type = 'offer');
          requestsList.forEach(item => item._type = 'request');
          
          // Birle≈ütir ve created_at'e g√∂re sƒ±rala (en yeniden en eskiye)
          d = [...offersList, ...requestsList].sort((a, b) => {
            const dateA = new Date(a.created_at || 0);
            const dateB = new Date(b.created_at || 0);
            return dateB - dateA; // B√ºy√ºkten k√º√ß√ºƒüe (en yeni √∂nce)
          });
          
          console.log('ALL view - Offers:', offersList.length, 'Requests:', requestsList.length, 'Total:', d.length);
        } catch(err) {
          console.error('Error fetching all listings:', err);
          d = [];
        }
      } else {
        d = await req(type==='offers'?'/service-offers/':'/service-requests/');
        // Backend'den zaten sƒ±ralƒ± geliyor ama emin olmak i√ßin tekrar sƒ±rala
        if(Array.isArray(d)) {
          d = d.sort((a, b) => {
            const dateA = new Date(a.created_at || 0);
            const dateB = new Date(b.created_at || 0);
            return dateB - dateA; // B√ºy√ºkten k√º√ß√ºƒüe (en yeni √∂nce)
          });
        }
      }
      
      // T√ºm ilanlarƒ± sakla (arama i√ßin) - eƒüer d bir array deƒüilse bo≈ü array kullan
      if(Array.isArray(d)) {
        allListings = d;
      } else {
        allListings = [];
      }
      listingsData = d;
      
      // Arama kutusunu kontrol et
      const searchInput = $('#searchInput');
      const searchTerm = searchInput ? searchInput.value.trim() : '';
      
      // Her zaman render et - arama terimi varsa filtrele, yoksa t√ºm√ºn√º g√∂ster
      if(searchTerm && searchTerm !== '') {
        filterListings(searchTerm);
      } else {
        // T√ºm ilanlarƒ± g√∂ster - allListings'i direkt kullan
        console.log('Rendering listings:', allListings.length, 'Type:', type);
        renderListings(allListings);
      }
      
      // Harita marker'larƒ±nƒ± g√ºncelle
      if(mainMap) loadMapMarkers();
    }
    
    // Arama kutusu event handler
    $('#searchInput').oninput = function() {
      filterListings(this.value);
    };
    
    // Enter tu≈üu ile arama
    $('#searchInput').onkeypress = function(e) {
      if(e.key === 'Enter') {
        e.preventDefault();
        filterListings(this.value);
      }
    };

    function getButtonHtml(item, type){
        if(item.user_info.username === USER.username) return ''; 
        if(type === 'offers'){
            if(USER_BALANCE < item.duration) return `<button class="action-btn disabled" disabled>Insufficient Balance</button>`;
            return `<button class="action-btn" onclick="startChat(${item.id}, 'offer')">Contact / Request</button>`;
        } 
        return `<button class="action-btn" onclick="startChat(${item.id}, 'request')">Offer Help</button>`;
    }

    async function startChat(id, type){
      const result = await Swal.fire({
        title: 'Start conversation?',
        text: 'Send a message to start chatting',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, start!',
        cancelButtonText: 'Cancel'
      });
      
      if(result.isConfirmed){
        const r = await req('/interaction/create/', 'POST', {id, type, message:'Hi!'});
        if(r.success){ 
          Swal.fire({
            icon: 'success',
            title: 'Sent!',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          loadView('inbox'); 
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.error || 'Error',
            confirmButtonColor: '#3085d6'
          });
        }
      }
    }

    async function fetchChats(){
      const d = await req('/interactions/');
      $('#inboxContent').innerHTML = d.map(i=>`
        <div class="inbox-item" onclick="openChat(${i.id})">
          <div class="inbox-icon">${i.sender_username===USER.username?'üì§':'üì•'}</div>
          <div class="inbox-info"><div class="inbox-title">${i.title}</div><span class="status-badge st-${i.status.toLowerCase()}">${i.status.replace('_',' ')}</span></div>
          <div style="font-size:13px;color:#666">With: ${i.sender_username===USER.username?i.receiver_username:i.sender_username}</div>
        </div>`).join('') || '<div style="padding:20px;text-align:center;color:#eee">No conversations.</div>';
    }

    // My listings verilerini sakla
    let myListingsData = [];

    async function fetchMyListings(){
        const d = await req('/my-listings/');
        myListingsData = d; // Veriyi sakla
        $('#inboxContent').innerHTML = d.map(i=>`
            <div class="inbox-item" style="cursor:pointer;position:relative" onclick="openMyListingDetail(${i.id}, '${i.type}')">
                <div class="inbox-icon" style="background:#f3f4f6">üìù</div>
                <div class="inbox-info" style="flex:1"><div class="inbox-title">${i.title}</div><div style="font-size:13px;color:#666">${i.type.toUpperCase()} ‚Ä¢ ${i.duration}h</div></div>
                <button class="delete-listing-btn" onclick="event.stopPropagation(); deleteListing(${i.id}, '${i.type}')" title="Delete listing">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>`).join('') || '<div style="padding:20px;text-align:center;color:#eee">You have no listings.</div>';
    }
    
    // My Listings'ten detay a√ßma
    function openMyListingDetail(id, type) {
      // √ñnce saklanan veriden bul
      const item = myListingsData.find(i => i.id === id && i.type === type);
      
      if(item) {
        // Veriyi openDetailSidebar formatƒ±na √ßevir
        const detailItem = {
          id: item.id,
          title: item.title,
          description: item.description || '',
          category: item.category || '',
          duration: item.duration,
          latitude: item.latitude,
          longitude: item.longitude,
          address: item.address || '',
          image_url: item.image_url || null,
          created_at: item.created_at,
          user_info: {
            id: item.user_info?.id || USER.id,
            username: item.user_info?.username || USER.username
          }
        };
        openDetailSidebar(detailItem, type);
      } else {
        // Eƒüer saklanan veride yoksa API'den √ßek (fallback)
        (async () => {
          try {
            const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
            const apiItem = await req(endpoint);
            if(apiItem && apiItem.id) {
              openDetailSidebar(apiItem, type);
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Could not load listing details',
                confirmButtonColor: '#3085d6'
              });
            }
          } catch(err) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: err.message || 'Unknown error occurred',
              confirmButtonColor: '#3085d6'
            });
          }
        })();
      }
    }
    
    window.openMyListingDetail = openMyListingDetail;
    
    // ƒ∞lan silme fonksiyonu
    async function deleteListing(id, type) {
        const result = await Swal.fire({
          title: 'Are you sure?',
          text: "You won't be able to revert this!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'Cancel'
        });
        
        if(!result.isConfirmed) {
            return;
        }
        
        try {
            const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
            const deleteResult = await req(endpoint, 'DELETE');
            if(deleteResult.error) {
                await Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: deleteResult.error,
                  confirmButtonColor: '#3085d6'
                });
                return;
            }
            
            Swal.fire({
              icon: 'success',
              title: 'Deleted!',
              text: 'Listing deleted successfully!',
              timer: 2000,
              showConfirmButton: false,
              position: 'top-end',
              toast: true
            });
            
            fetchMyListings(); // Listeyi yenile
            // Ana sayfadaki listeyi de yenile
            if(currentListingType) {
                fetchListings(currentListingType);
            }
            // Haritayƒ± da yenile
            if(window.mainMap) {
                updateMapMarkers();
            }
        } catch(err) {
            await Swal.fire({
              icon: 'error',
              title: 'Error',
              text: err.message || 'Unknown error occurred',
              confirmButtonColor: '#3085d6'
            });
        }
    }
    
    window.deleteListing = deleteListing;

    async function openChat(id){ 
        ACTIVE_CHAT_ID=id; LAST_RENDER_KEY=""; 
        $('#chatSheet').classList.add('open'); 
        if(POLLER) clearInterval(POLLER);
        loadChatMessages();
        POLLER = setInterval(loadChatMessages, 3000);
    }

    window.closeSheet = id => { 
      $('#'+id).classList.remove('open'); 
      if(id==='chatSheet'){ 
        ACTIVE_CHAT_ID=null; 
        clearInterval(POLLER); 
        checkNotifications(); 
      } else if(id==='listingSheet') {
        // Harita ve marker'ƒ± temizle
        if(locationMap) {
          locationMap.remove();
          locationMap = null;
          locationMarker = null;
        }
        // Form alanlarƒ±nƒ± temizle
        $('#inpLat').value = '';
        $('#inpLng').value = '';
        $('#inpAddress').value = '';
        $('#locationSearch').value = '';
        $('#locationMap').innerHTML = '';
      }
    };

    async function loadChatMessages(){
      if(!ACTIVE_CHAT_ID) return;
      const all = await req('/interactions/');
      const chat = all.find(x => x.id === ACTIVE_CHAT_ID);
      const key = chat.status + (chat.appointment_date||'') + chat.is_completed_by_provider + chat.date_proposed_by_username;
      if(key!==LAST_RENDER_KEY) { updateBar(chat); LAST_RENDER_KEY=key; }
      
      const msgs = await req(`/interaction/${ACTIVE_CHAT_ID}/messages/`);
      const area = $('#msgArea');
      area.innerHTML = msgs.map(m=>`<div class="chat-bubble ${m.sender_username === USER.username ? 'me' : 'them'}">${m.content}</div>`).join('');
      area.scrollTop = area.scrollHeight;
    }

    $('#msgForm').onsubmit = async e => {
      e.preventDefault(); const inp = $('#msgInput'); const val = inp.value.trim(); if(!val) return;
      await req(`/interaction/${ACTIVE_CHAT_ID}/messages/`, 'POST', {content: val});
      inp.value = ''; loadChatMessages();
    };

    function updateBar(d){
      const imSender = d.sender_username === USER.username; 
      const bar = $('#actionBar');
      let html = ''; let title = '';

      if(d.status==='pending'){
        title = "New Request";
        if(d.receiver_username === USER.username) html = `<span>Accept?</span> <div><button class="ab-btn green" onclick="act('accept')">Accept</button> <button class="ab-btn red" onclick="act('decline')">Decline</button></div>`;
        else { title="Request Sent"; html = `Waiting for provider response...`; }
      }
      else if(d.status==='accepted'){
        title = "Request Accepted";
        html = `<span>Schedule a date:</span> <div><input type="datetime-local" id="dp" style="padding:6px;border:1px solid #ddd;border-radius:6px"> <button class="ab-btn blue" onclick="act('schedule')">Propose</button></div>`;
      }
      else if(d.status==='date_proposed'){
        title = "Date Proposed";
        const date = new Date(d.appointment_date).toLocaleString();
        const imProposer = d.date_proposed_by_username === USER.username;
        if(imProposer) html = `You proposed <b>${date}</b>. Waiting.`;
        else html = `<span>Proposed: <b>${date}</b></span> <button class="ab-btn green" onclick="act('accept_date')">Confirm Date</button>`;
      }
      else if(d.status==='scheduled'){
        title = "Scheduled";
        const date = new Date(d.appointment_date).toLocaleString();
        const isProvider = (d.type === 'offer' && d.receiver_username === USER.username) || (d.type === 'request' && d.sender_username === USER.username);
        
        if(isProvider && !d.is_completed_by_provider) html=`<span>Date: <b>${date}</b></span> <button class="ab-btn green" onclick="act('complete')">Mark Complete</button>`;
        else if(d.is_completed_by_provider && !d.is_confirmed_by_receiver){
            title = "Job Done!";
            if(!isProvider) html=`<span>Confirm & Pay?</span> <button class="ab-btn green" onclick="act('confirm')">Pay (${d.duration}h)</button>`;
            else html=`Waiting for payment...`;
        } else html=`Event: <b>${date}</b>`;
      }
      else if(d.status==='completed'){ title = "Completed"; html = `Transaction successful.`; }

      bar.innerHTML = `<div class="ab-header"><span class="ab-title">${title}</span> <span class="status-badge st-${d.status}">${d.status.replace('_',' ')}</span></div>` + (html ? `<div class="ab-content ${d.status==='completed'?'success':''}">${html}</div>` : '');
      bar.style.display = 'flex';
    }

    async function act(a){
      let p={}; 
      if(a==='schedule'){ 
        const v=$('#dp').value; 
        if(!v){
          await Swal.fire({
            icon: 'warning',
            title: 'Date Required',
            text: 'Please select a date',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        p={date:v}; 
      }
      const r = await req(`/interaction/${ACTIVE_CHAT_ID}/${a}/`, 'POST', p);
      if(r.status){ 
        Swal.fire({
          icon: 'success',
          title: 'Updated!',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        LAST_RENDER_KEY=""; 
        loadChatMessages(); 
        fetchProfile(); 
      } else {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: r.error || 'An error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    // Harita deƒüi≈ükenleri
    let locationMap = null;
    let locationMarker = null;
    let geocoder = null;
    let mainMap = null;
    let mainMapMarkers = [];
    let currentDetailItem = null;
    
    // Resim y√ºkleme deƒüi≈ükenleri
    let selectedImageFile = null;

    $('#btnOffer').onclick = () => openSheet('offer');
    $('#btnRequest').onclick = () => openSheet('request');
    
    function openSheet(type){ 
      $('#listingSheet').classList.add('open'); 
      $('#listingType').value = type;
      // Resim y√ºkleme alanƒ±nƒ± sƒ±fƒ±rla
      removeImage();
      // Haritayƒ± ba≈ülat - sidebar a√ßƒ±ldƒ±ktan sonra biraz bekle
      setTimeout(() => {
        initLocationMap();
        // Harita ba≈ülatƒ±ldƒ±ktan sonra invalidateSize √ßaƒüƒ±r (g√∂r√ºn√ºrl√ºk deƒüi≈ütiƒüi i√ßin)
        if(locationMap) {
          setTimeout(() => locationMap.invalidateSize(), 200);
        }
      }, 150);
    }

    // Resim y√ºkleme fonksiyonlarƒ±
    function handleImageFile(file) {
      if(!file || !file.type.startsWith('image/')) {
        Swal.fire({
          icon: 'warning',
          title: 'Invalid File',
          text: 'Please select an image file',
          confirmButtonColor: '#3085d6',
          timer: 3000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        return;
      }
      
      selectedImageFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        $('#imagePreview').src = e.target.result;
        $('#imagePreview').classList.add('show');
        $('#imagePlaceholder').style.display = 'none';
        $('#imageRemoveBtn').style.display = 'flex';
        $('#imageUploadArea').classList.add('has-image');
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      selectedImageFile = null;
      $('#imagePreview').src = '';
      $('#imagePreview').classList.remove('show');
      $('#imagePlaceholder').style.display = 'block';
      $('#imageRemoveBtn').style.display = 'none';
      $('#imageUploadArea').classList.remove('has-image');
      $('#imageFileInput').value = '';
    }

    window.removeImage = removeImage;

    // Copy/Paste event handler
    document.addEventListener('paste', function(e) {
      const activeElement = document.activeElement;
      if(activeElement && (activeElement.id === 'imageUploadArea' || activeElement.closest('#listingSheet'))) {
        e.preventDefault();
        const items = e.clipboardData.items;
        for(let i = 0; i < items.length; i++) {
          if(items[i].type.indexOf('image') !== -1) {
            const file = items[i].getAsFile();
            handleImageFile(file);
            break;
          }
        }
      }
    });

    // Image upload area click handler
    $('#imageUploadArea').onclick = function(e) {
      if(e.target !== $('#imageRemoveBtn')) {
        $('#imageFileInput').click();
      }
    };

    // File input change handler
    $('#imageFileInput').onchange = function(e) {
      if(e.target.files && e.target.files[0]) {
        handleImageFile(e.target.files[0]);
      }
    };

    function initLocationMap(){
      const mapEl = $('#locationMap');
      if(!mapEl) {
        console.error('Location map container not found');
        return;
      }
      
      // Eƒüer harita zaten ba≈ülatƒ±lmƒ±≈üsa, √∂nce temizle
      if(locationMap) {
        try {
          locationMap.remove();
        } catch(e) {
          console.warn('Error removing old map:', e);
        }
        locationMap = null;
        locationMarker = null;
      }
      
      // Container'ƒ±n innerHTML'ini temizle (eƒüer √∂nceki harita kalƒ±ntƒ±larƒ± varsa)
      if(mapEl.innerHTML.trim()) {
        mapEl.innerHTML = '';
      }
      
      try {
        // Haritayƒ± ba≈ülat (T√ºrkiye merkezli)
        locationMap = L.map('locationMap').setView([39.9334, 32.8597], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(locationMap);

        // Marker olu≈ütur
        locationMarker = L.marker([39.9334, 32.8597], {draggable: true}).addTo(locationMap);
        
        // Marker s√ºr√ºklendiƒüinde
        locationMarker.on('dragend', function(e) {
          const pos = e.target.getLatLng();
          updateLocationFields(pos.lat, pos.lng);
          reverseGeocode(pos.lat, pos.lng);
        });

        // Haritaya tƒ±klandƒ±ƒüƒ±nda
        locationMap.on('click', function(e) {
          locationMarker.setLatLng(e.latlng);
          updateLocationFields(e.latlng.lat, e.latlng.lng);
          reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        // Adres arama (iyile≈ütirilmi≈ü geocoding - Nominatim kullanarak)
        let searchTimeout = null;
        $('#locationSearch').oninput = async function() {
          const query = this.value.trim();
          const resultsDiv = $('#searchResults');
          
          // √ñnceki timeout'u iptal et
          if(searchTimeout) clearTimeout(searchTimeout);
          
          if(!query || query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
          }
          
          // Debounce - 300ms bekle
          searchTimeout = setTimeout(async () => {
            try {
              // ƒ∞stanbul b√∂lgesine √∂ncelik ver (t√ºm d√ºnyadan sonu√ßlar)
              const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&viewbox=28.5,41.0,29.2,41.2&bounded=0&addressdetails=1`;
              const response = await fetch(url, {
                headers: {
                  'User-Agent': 'HIVE TimeBank App'
                }
              });
              const data = await response.json();
              
              if(data.length > 0) {
                // Sonu√ßlarƒ± g√∂ster
                resultsDiv.innerHTML = data.map((item, idx) => `
                  <div class="search-result-item" onclick="selectSearchResult(${parseFloat(item.lat)}, ${parseFloat(item.lon)}, '${item.display_name.replace(/'/g, "\\'")}')">
                    <div class="search-result-title">${item.display_name.split(',')[0]}</div>
                    <div class="search-result-details">${item.display_name}</div>
                  </div>
                `).join('');
                resultsDiv.style.display = 'block';
              } else {
                resultsDiv.innerHTML = '<div class="search-result-item" style="cursor:default;color:#999">No results found</div>';
                resultsDiv.style.display = 'block';
              }
            } catch(err) {
              console.error('Search error:', err);
              resultsDiv.style.display = 'none';
            }
          }, 300);
        };
        
        // Enter tu≈üu ile ilk sonucu se√ß
        $('#locationSearch').onkeypress = async function(e) {
          if(e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim();
            if(!query) return;
            
            const resultsDiv = $('#searchResults');
            const firstResult = resultsDiv.querySelector('.search-result-item');
            if(firstResult && !firstResult.textContent.includes('No results')) {
              firstResult.click();
            } else {
              // Eƒüer sonu√ß yoksa, direkt arama yap
              try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&viewbox=28.5,41.0,29.2,41.2&bounded=0`;
                const response = await fetch(url, {
                  headers: {
                    'User-Agent': 'HIVE TimeBank App'
                  }
                });
                const data = await response.json();
                if(data.length > 0) {
                  selectSearchResult(parseFloat(data[0].lat), parseFloat(data[0].lon), data[0].display_name);
                } else {
                  Swal.fire({
                    icon: 'warning',
                    title: 'Location Not Found',
                    text: 'Please try a different search term',
                    confirmButtonColor: '#3085d6',
                    timer: 3000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                  });
                }
              } catch(err) {
                Swal.fire({
                  icon: 'error',
                  title: 'Search Error',
                  text: 'An error occurred while searching',
                  confirmButtonColor: '#3085d6',
                  timer: 3000,
                  showConfirmButton: false,
                  position: 'top-end',
                  toast: true
                });
              }
            }
          }
        };
        
        // Sonu√ß se√ßme fonksiyonu
        window.selectSearchResult = function(lat, lng, address) {
          locationMap.setView([lat, lng], 13);
          locationMarker.setLatLng([lat, lng]);
          updateLocationFields(lat, lng);
          $('#inpAddress').value = address;
          $('#locationSearch').value = address.split(',')[0]; // Sadece ilk kƒ±smƒ± g√∂ster
          $('#searchResults').style.display = 'none';
        };
        
        // Dƒ±≈üarƒ± tƒ±klandƒ±ƒüƒ±nda sonu√ßlarƒ± gizle
        document.addEventListener('click', function(e) {
          if(!e.target.closest('.search-container-relative')) {
            $('#searchResults').style.display = 'none';
          }
        });
      } catch(err) {
        console.error('Error initializing location map:', err);
        Swal.fire({
          icon: 'error',
          title: 'Map Error',
          text: 'Failed to load map. Please refresh the page.',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    function updateLocationFields(lat, lng) {
      $('#inpLat').value = lat;
      $('#inpLng').value = lng;
    }

    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        if(data.display_name) {
          $('#inpAddress').value = data.display_name;
        }
      } catch(err) {
        console.error('Geocoding error:', err);
      }
    }

    $('#listingForm').onsubmit = async e => {
      e.preventDefault();
      const t=$('#listingType').value;
      
      // Latitude ve longitude'u parse et - ge√ßersizse null g√∂nder
      // DecimalField i√ßin string olarak g√∂nder (max_digits=9, decimal_places=6)
      // Bu y√ºzden 6 ondalƒ±k basamaƒüa yuvarlamalƒ±yƒ±z
      const latVal = $('#inpLat').value.trim();
      const lngVal = $('#inpLng').value.trim();
      
      function roundTo6Decimals(val) {
        if(!val || isNaN(parseFloat(val))) return null;
        return parseFloat(val).toFixed(6);
      }
      
      const latitude = roundTo6Decimals(latVal);
      const longitude = roundTo6Decimals(lngVal);
      
      // FormData kullan (resim varsa)
      const formData = new FormData();
      formData.append('title', $('#inpTitle').value);
      formData.append('category', $('#inpCat').value);
      formData.append('duration', parseInt($('#inpDur').value));
      formData.append('description', $('#inpDesc').value);
      
      // Sadece deƒüer varsa ekle
      if(latitude !== null) formData.append('latitude', latitude);
      if(longitude !== null) formData.append('longitude', longitude);
      const addr = $('#inpAddress').value.trim();
      if(addr) formData.append('address', addr);
      
      // Resim varsa ekle
      if(selectedImageFile) {
        formData.append('image', selectedImageFile);
      }
      
      console.log('Sending data with FormData');
      
      try {
        const r = await req(t==='offer'?'/service-offers/':'/service-requests/','POST',formData, true);
        console.log('Response:', r);
        
        if(r && r.id){ 
          Swal.fire({
            icon: 'success',
            title: 'Listing Created!',
            timer: 3000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          closeSheet('listingSheet'); 
          e.target.reset(); 
          removeImage();
          locationMap = null; 
          locationMarker = null; 
          $('#locationMap').innerHTML = ''; 
          loadView(t+'s'); 
        } else {
          // Django REST Framework hata formatƒ±nƒ± parse et
          let errorMsg = 'Error creating listing';
          if(r) {
            if(r.detail) errorMsg = r.detail;
            else if(r.error) errorMsg = r.error;
            else if(r.non_field_errors) errorMsg = r.non_field_errors.join(', ');
            else if(typeof r === 'object') {
              const fieldErrors = Object.keys(r).map(key => `${key}: ${Array.isArray(r[key]) ? r[key].join(', ') : r[key]}`).join('; ');
              if(fieldErrors) errorMsg = fieldErrors;
            }
          }
          console.error('Error response:', r);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: errorMsg,
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        console.error('Request error:', err);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: err.message || 'Network error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    };

  </script>
</body>
</html>