<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TimeBank | Time Bank</title>
  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Z-INDEX FIX: UI elementlerini haritanƒ±n √ºzerine √ßƒ±kar */
    /* Haritanƒ±n z-index'ini kontrol altƒ±nda tut */
    #mainMap, #map, .leaflet-container, .leaflet-pane {
      z-index: 1 !important;
    }
    .leaflet-top, .leaflet-bottom {
      z-index: 2 !important;
    }
    
    /* Navbar ve dropdown'lar haritanƒ±n √ºzerinde */
    header, .navbar {
      z-index: 10000 !important;
      position: relative;
    }
    .actions {
      z-index: 10001 !important;
      position: relative;
    }
    .dropdown-menu, .profile-menu {
      z-index: 10001 !important;
    }
    .notifications-dropdown {
      z-index: 10001 !important;
    }
    
    /* SweetAlert2 z-index override - sidebar'dan y√ºksek olmalƒ± */
    .swal2-container {
      z-index: 10002 !important;
    }
    .swal2-container.swal2-backdrop-show {
      z-index: 10002 !important;
    }
    
    /* Toast container y√ºksek z-index */
    .toast-container {
      z-index: 10002 !important;
    }
    .toast {
      z-index: 10002 !important;
    }
    :root{
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg: #f3f4f6; --text: #1f2937;
    }
    *{box-sizing:border-box;margin:0;padding:0;outline:none;font-family:'Segoe UI',sans-serif}
    body{background:var(--primary);min-height:100vh;padding:20px;color:var(--text)}
    .hidden{display:none !important}
    .app{max-width:1100px;margin:0 auto;padding-bottom:100px;position:relative}

    header{background:#fff;border-radius:24px;padding:12px 24px;margin-bottom:24px;display:flex;justify-content:space-between;box-shadow:0 10px 40px rgba(0,0,0,0.15);position:relative;z-index:1000 !important;height:60px;align-items:center}
    .logo{font-size:26px;font-weight:900;background:var(--primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:8px}
    .actions{display:flex;align-items:center;gap:12px;position:relative;z-index:10001}
    
    /* Navbar profil hizalamasƒ± */
    .navbar-profile-section {
      display: flex;
      align-items: center; /* Dikeyde tam ortala */
      gap: 10px; /* Resim ve yazƒ± arasƒ± bo≈üluk */
    }
    .navbar-profile-section img {
      object-fit: cover; /* Resim bozulmasƒ±n */
    }
    .navbar-profile-section span {
      line-height: 1; /* Yazƒ± satƒ±r bo≈üluƒüunu sƒ±fƒ±rla */
      margin: 0;
    }
    .profile-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    
    .pill{background:#f3f4f6;padding:8px 16px;border-radius:99px;font-weight:700;color:#555;font-size:14px}
    .icon-btn{width:44px;height:44px;border-radius:50%;border:0;cursor:pointer;background:#f3f4f6;font-size:18px;display:grid;place-items:center;position:relative;transition:0.2s}
    .icon-btn:hover{background:#e5e7eb;transform:translateY(-2px)}
    .profile-btn{background:var(--primary);color:#fff;font-weight:700;font-size:14px;border:2px solid #fff}
    .notif-badge{position:absolute;top:-2px;right:-2px;background:#ef4444;color:#fff;width:18px;height:18px;border-radius:50%;font-size:10px;font-weight:800;display:grid;place-items:center;opacity:0;transform:scale(0);transition:0.2s}
    .notif-badge.show{opacity:1;transform:scale(1)}

    .profile-menu{position:absolute;top:70px;right:0;width:220px;background:#fff;border-radius:16px;padding:16px;box-shadow:0 15px 50px rgba(0,0,0,0.2);z-index:10001;display:none;flex-direction:column;gap:10px}
    .profile-menu.show{display:flex}
    .pm-btn{background:#fee2e2;color:#dc2626;border:0;padding:10px;border-radius:10px;font-weight:700;cursor:pointer;width:100%}
    .pm-btn:hover{background:#fecaca}
    .notifications-dropdown{position:absolute;top:70px;right:0;width:420px;max-height:600px;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.15);z-index:10001;display:none;flex-direction:column;overflow:hidden}
    .notifications-dropdown.show{display:flex}
    .notif-header{padding:20px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;background:#fff;position:sticky;top:0;z-index:10}
    .notif-header h3{margin:0;font-size:18px;font-weight:800;color:#1f2937}
    .notif-close-btn{width:32px;height:32px;border-radius:50%;border:0;background:#f3f4f6;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#666;transition:all .2s;font-size:16px}
    .notif-close-btn:hover{background:#e5e7eb;color:#333}
    .notif-body{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .notif-card{background:#fff;border:1px solid #f0f0f0;border-radius:16px;padding:16px;display:flex;gap:14px;transition:all .2s;cursor:pointer;position:relative}
    .notif-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateY(-2px);border-color:#e5e7eb}
    .notif-card.unread{background:#f8fafc;border-color:#e0f2fe}
    .notif-icon-box{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
    .notif-icon-box.accepted{background:#d1fae5;color:#059669}
    .notif-icon-box.message{background:#dbeafe;color:#2563eb}
    .notif-icon-box.time-credit{background:#fed7aa;color:#ea580c}
    .notif-icon-box.warning{background:#fef3c7;color:#d97706}
    .notif-icon-box.pending{background:#e0e7ff;color:#6366f1}
    .notif-content{flex:1;min-width:0}
    .notif-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;gap:12px}
    .notif-title{font-weight:700;font-size:15px;color:#1f2937;margin:0;flex:1}
    .notif-date{font-size:11px;color:#9ca3af;font-weight:500;white-space:nowrap}
    .notif-message{font-size:14px;color:#4b5563;line-height:1.5;margin:0;margin-top:4px}
    .notif-empty{padding:40px 20px;text-align:center;color:#9ca3af;font-size:14px}
    .notifications-dropdown{position:absolute;top:70px;right:0;width:420px;max-height:600px;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.15);z-index:10001;display:none;flex-direction:column;overflow:hidden}
    .notifications-dropdown.show{display:flex}
    .notif-header{padding:20px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;background:#fff;position:sticky;top:0;z-index:10}
    .notif-header h3{margin:0;font-size:18px;font-weight:800;color:#1f2937}
    .notif-close-btn{width:32px;height:32px;border-radius:50%;border:0;background:#f3f4f6;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#666;transition:all .2s;font-size:16px}
    .notif-close-btn:hover{background:#e5e7eb;color:#333}
    .notif-body{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .notif-card{background:#fff;border:1px solid #f0f0f0;border-radius:16px;padding:16px;display:flex;gap:14px;transition:all .2s;cursor:pointer;position:relative}
    .notif-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08);transform:translateY(-2px);border-color:#e5e7eb}
    .notif-card.unread{background:#f8fafc;border-color:#e0f2fe}
    .notif-icon-box{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
    .notif-icon-box.accepted{background:#d1fae5;color:#059669}
    .notif-icon-box.message{background:#dbeafe;color:#2563eb}
    .notif-icon-box.time-credit{background:#fed7aa;color:#ea580c}
    .notif-icon-box.warning{background:#fef3c7;color:#d97706}
    .notif-icon-box.pending{background:#e0e7ff;color:#6366f1}
    .notif-content{flex:1;min-width:0}
    .notif-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;gap:12px}
    .notif-title{font-weight:700;font-size:15px;color:#1f2937;margin:0;flex:1}
    .notif-date{font-size:11px;color:#9ca3af;font-weight:500;white-space:nowrap}
    .notif-message{font-size:14px;color:#4b5563;line-height:1.5;margin:0;margin-top:4px}
    .notif-empty{padding:40px 20px;text-align:center;color:#9ca3af;font-size:14px}

    .hero{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
    .cta{background:#fff;padding:24px;border-radius:20px;display:flex;align-items:center;justify-content:center;gap:12px;font-weight:800;font-size:18px;color:#333;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.06);transition:transform .2s;text-decoration:none}
    .cta:hover{transform:translateY(-3px)}
    .cta.primary{background:var(--primary);color:#fff}

    /* TABS FIX: Centered & width:auto */
    .tabs-container{display:flex;justify-content:center;margin-bottom:24px}
    .tabs{background:#fff;padding:6px;border-radius:99px;display:inline-flex;gap:6px;box-shadow:0 8px 24px rgba(0,0,0,0.08);width:auto}
    .tab{padding:10px 24px;border-radius:99px;border:0;background:transparent;font-weight:700;color:#6b7280;cursor:pointer;transition:0.2s;font-size:14px;white-space:nowrap}
    .tab.active{background:var(--primary);color:#fff}
    .search-container{background:#fff;border-radius:16px;padding:16px;margin-bottom:24px;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .search-box{width:100%;padding:14px 20px;border-radius:12px;border:2px solid #e5e7eb;font-size:15px;outline:none;transition:border-color .2s}
    .search-box:focus{border-color:#667eea}
    .search-box::placeholder{color:#9ca3af}
    
    .sub-tabs{display:flex;gap:10px;margin-bottom:16px;padding:0 4px}
    .sub-tab{padding:8px 16px;border-radius:12px;border:0;background:rgba(255,255,255,0.2);color:#fff;font-weight:700;cursor:pointer;font-size:13px}
    .sub-tab.active{background:#fff;color:#667eea;box-shadow:0 4px 10px rgba(0,0,0,0.1)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:20px}
    .card{background:#fff;border-radius:20px;padding:22px;box-shadow:0 4px 12px rgba(0,0,0,0.05);position:relative;display:flex;flex-direction:column;transition:transform .2s;z-index:1}
    .card:hover{transform:translateY(-4px); box-shadow:0 12px 30px rgba(0,0,0,0.1)}
    .card-header-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;width:100%}
    .card-type-badge{font-size:10px;font-weight:800;padding:5px 10px;border-radius:99px;text-transform:uppercase;letter-spacing:0.5px;display:inline-block}
    .card-cat{font-size:11px;font-weight:800;background:#ede9fe;color:#7c3aed;padding:5px 10px;border-radius:99px;display:inline-block}
    .card h3{font-size:20px;margin-bottom:8px;margin-top:0;font-weight:800;word-wrap:break-word;line-height:1.3}
    .card p{color:#666;font-size:14px;line-height:1.5;margin-bottom:16px;flex:1}
    .card-meta{display:flex;justify-content:space-between;align-items:center;font-size:13px;font-weight:700;color:#888;border-top:1px solid #f0f0f0;padding-top:14px;margin-top:auto}
    
    .action-btn{width:100%;margin-top:16px;padding:12px;border:0;border-radius:12px;background:#f3f4f6;font-weight:800;cursor:pointer;color:#333;transition:background .2s;position:relative;z-index:10}
    .action-btn:hover{background:#e5e7eb}
    .action-btn.disabled{opacity:0.6;cursor:not-allowed;background:#eee}

    .inbox-list{display:flex;flex-direction:column;gap:12px}
    .inbox-item{background:#fff;padding:16px;border-radius:18px;display:flex;gap:16px;cursor:pointer;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.04);transition:transform .2s}
    .inbox-item:hover{transform:translateX(5px)}
    .inbox-icon{width:50px;height:50px;border-radius:14px;background:#eef2ff;display:grid;place-items:center;font-size:24px}
    .inbox-info{flex:1}
    .delete-listing-btn{width:36px;height:36px;border-radius:10px;border:0;background:#fee2e2;color:#dc2626;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0}
    .delete-listing-btn:hover{background:#fecaca;transform:scale(1.1)}
    .status-badge{font-size:10px;padding:4px 8px;border-radius:6px;font-weight:800;text-transform:uppercase}
    .st-pending{background:#fff7ed;color:#c2410c}
    .st-accepted{background:#ecfdf5;color:#047857}
    .st-date_proposed{background:#eff6ff;color:#1d4ed8}
    .st-scheduled{background:#f0f9ff;color:#0369a1}
    .st-completed{background:#eef2ff;color:#4338ca}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
    .modal-overlay.open{display:flex}
    /* Review modal sidebar'ƒ±n √ºst√ºnde olmalƒ± */
    #reviewModal{z-index:100000 !important}
    .sheet{position:fixed !important;top:0 !important;right:-100%;width:100%;max-width:480px;height:100vh !important;background:#fff;z-index:99999 !important;transition:right .3s;box-shadow:-10px 0 60px rgba(0,0,0,0.2);display:flex;flex-direction:column;padding-top:0 !important}
    .sheet.open{right:0}
    .sheet-head{padding:20px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:16px}
    .sheet-body{flex:1;overflow-y:auto;padding:20px;background:#f9fafb}

    /* FORM STYLE (FIXED) */
    .form-style .field{margin-bottom:16px}
    .form-style .label{display:block;margin-bottom:8px;font-weight:700;font-size:14px;color:#4b5563}
    .form-style .input{width:100%;padding:14px;border-radius:12px;border:2px solid #e5e7eb;font-size:15px;background:#fff;font-family:inherit;color:inherit;line-height:1.5}
    .form-style .btn{width:100%;padding:14px;border-radius:12px;border:0;font-weight:800;background:var(--primary);color:#fff;cursor:pointer;font-size:15px;display:block}
    .map-container{width:100%;height:300px;border-radius:12px;border:2px solid #e5e7eb;margin-bottom:16px;overflow:hidden}
    .map-search{width:100%;padding:10px;border-radius:8px;border:2px solid #e5e7eb;margin-bottom:12px;font-size:14px}
    .search-results{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:none;margin-top:4px}
    .search-result-item{padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background .2s}
    .search-result-item:hover{background:#f9fafb}
    .search-result-item:last-child{border-bottom:0}
    .search-result-title{font-weight:700;font-size:14px;color:#1f2937;margin-bottom:4px}
    .search-result-details{font-size:12px;color:#6b7280}
    .search-container-relative{position:relative}
    .image-upload-area{width:100%;min-height:200px;border:2px dashed #e5e7eb;border-radius:12px;margin-bottom:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#f9fafb;transition:all .2s;position:relative;overflow:hidden}
    .image-upload-area:hover{border-color:#667eea;background:#f0f4ff}
    .image-upload-area.has-image{border-style:solid;border-color:#667eea;padding:0}
    .image-upload-area.has-image:hover{border-color:#764ba2}
    .image-upload-placeholder{text-align:center;padding:20px;color:#6b7280;font-size:14px}
    .image-upload-placeholder strong{display:block;margin-bottom:8px;color:#4b5563;font-size:16px}
    .image-preview{width:100%;height:100%;object-fit:cover;display:none}
    .image-preview.show{display:block}
    .image-remove-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.6);color:#fff;border:0;border-radius:50%;width:32px;height:32px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;z-index:10;transition:background .2s}
    .image-remove-btn:hover{background:rgba(0,0,0,0.8)}
    .main-map-container{width:100%;height:500px;border-radius:20px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,0.06);margin-bottom:24px;background:#fff}
    .detail-sidebar{position:fixed !important;top:0 !important;right:-100%;width:100%;max-width:420px;height:100vh !important;background:#fff;z-index:99999 !important;transition:right .3s;box-shadow:-10px 0 60px rgba(0,0,0,0.2);display:flex;flex-direction:column;overflow-y:auto;padding-top:0 !important}
    .detail-sidebar.open{right:0}
    .detail-sidebar-header{padding:20px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;background:#fff;position:sticky;top:0;z-index:10}
    .detail-sidebar-body{padding:20px;flex:1}
    .detail-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:800;text-transform:uppercase;margin-bottom:12px;letter-spacing:0.5px}
    .detail-badge.offer{background:#667eea;color:#fff}
    .detail-badge.request{background:#10b981;color:#fff}
    .detail-image{width:100%;height:200px;object-fit:cover;border-radius:12px;margin-bottom:16px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#999;font-size:14px}
    .detail-image img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .detail-title{font-size:24px;font-weight:800;margin-bottom:8px;color:#1f2937}
    .detail-meta{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .detail-meta-item{display:flex;align-items:center;gap:6px;font-size:14px;color:#666}
    .detail-description{color:#4b5563;line-height:1.6;margin-bottom:20px;font-size:15px}
    .detail-address{background:#f9fafb;padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;color:#666}
    .detail-actions{display:flex;gap:10px;margin-top:20px}
    .detail-btn{flex:1;padding:12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;font-size:14px;transition:transform .2s;display:flex;align-items:center;justify-content:center;gap:8px}
    .detail-btn:hover{transform:translateY(-2px)}
    .detail-btn.primary{background:var(--primary);color:#fff}
    .detail-btn.secondary{background:#f3f4f6;color:#333}
    .detail-btn.danger{background:#fee2e2;color:#dc2626}
    .detail-btn.danger:hover{background:#fecaca}

    .chat-area{flex:1;display:flex;flex-direction:column;gap:12px;padding:20px;padding-bottom:30px}
    .chat-bubble{max-width:70%;padding:8px 12px;border-radius:16px;font-size:13px;line-height:1.4;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin:4px 0;word-wrap:break-word}
    .chat-bubble.me{align-self:flex-end;background:var(--primary);color:#fff;border-bottom-right-radius:4px;margin-left:auto}
    .chat-bubble.them{align-self:flex-start;background:#fff;color:#333;border:1px solid #e5e7eb;border-bottom-left-radius:4px;margin-right:auto}
    .chat-bubble-sender{font-size:11px;font-weight:600;margin-bottom:3px;opacity:0.85}
    .chat-bubble-time{font-size:10px;opacity:0.65;margin-top:4px;text-align:right}
    .chat-bubble.them .chat-bubble-time{text-align:left}
    .chat-footer{padding:16px;background:#fff;border-top:1px solid #eee;display:flex;gap:10px;align-items:center}
    .chat-input{flex:1;padding:12px 16px;border-radius:99px;border:2px solid #e5e7eb;outline:none}
    
    .action-bar-modern{margin:-20px -20px 10px -20px;padding:20px;background:#fff;border-bottom:1px solid #eee;display:flex;flex-direction:column;gap:12px}
    .ab-header{display:flex;justify-content:space-between;align-items:center}
    .ab-title{font-weight:800;font-size:16px;color:#1f2937}
    .ab-content{background:#f0f9ff;border:1px solid #e0f2fe;padding:14px;border-radius:12px;font-size:14px;color:#0c4a6e;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .ab-content.success{background:#ecfdf5;border-color:#d1fae5;color:#065f46}
    .ab-btn{padding:8px 16px;border-radius:8px;border:0;font-weight:700;cursor:pointer;color:#fff;font-size:13px;white-space:nowrap}
    .green{background:#10b981} .red{background:#ef4444} .blue{background:#3b82f6}

    .toast{position:fixed;top:20px;right:20px;background:#1f2937;color:#fff;padding:12px 24px;border-radius:12px;font-weight:700;z-index:10002;box-shadow:0 10px 30px rgba(0,0,0,0.2);animation:slideUp .3s}
    .toast-container{position:fixed;top:20px;right:20px;z-index:10002;display:flex;flex-direction:column;gap:10px}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.hero{grid-template-columns:1fr}.sheet{width:100%}}
    
    /* Admin Dashboard Styles */
    .admin-tab-btn.active {
      background: #fff !important;
      border-bottom: 3px solid #667eea !important;
      color: #667eea !important;
    }
    .admin-tab-content {
      min-height: 400px;
    }
    .admin-tab-content table {
      font-size: 14px;
    }
    .admin-tab-content table th {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .admin-tab-content table td {
      vertical-align: middle;
    }
    .admin-tab-content table tr:hover {
      background: #f9fafb;
    }
  </style>
</head>
<body>

  <div class="modal-overlay" id="authModal">
    <div style="background:#fff;width:100%;max-width:400px;border-radius:24px;padding:36px;box-shadow:0 25px 50px rgba(0,0,0,0.25)" class="form-style">
      <h2 style="text-align:center;margin-bottom:24px;font-size:32px;background:var(--primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900">üöÄ TimeBank</h2>
      <div style="display:flex;gap:10px;background:#f3f4f6;padding:5px;border-radius:14px;margin-bottom:24px">
        <button id="tabLogin" class="tab active" style="text-align:center;flex:1">Login</button>
        <button id="tabSignup" class="tab" style="text-align:center;flex:1">Sign Up</button>
      </div>
      <form id="loginForm">
        <div class="field"><label class="label">Username</label><input class="input" name="username" required oninvalid="this.setCustomValidity('Please enter your username')" oninput="this.setCustomValidity('')"></div>
        <div class="field"><label class="label">Password</label><input class="input" type="password" name="password" required oninvalid="this.setCustomValidity('Please enter your password')" oninput="this.setCustomValidity('')"></div>
        <button type="submit" class="btn">Login</button>
      </form>
      <form id="signupForm" class="hidden">
        <div class="field"><label class="label">Username</label><input class="input" name="username" required oninvalid="this.setCustomValidity('Please enter a username')" oninput="this.setCustomValidity('')"></div>
        <div class="field"><label class="label">Email</label><input class="input" type="email" name="email" required oninvalid="this.setCustomValidity('Please enter a valid email address')" oninput="this.setCustomValidity('')"></div>
        <div class="field"><label class="label">Password</label><input class="input" type="password" name="password" required oninvalid="this.setCustomValidity('Please enter a password')" oninput="this.setCustomValidity('')"></div>
        <div class="field"><label class="label">Confirm</label><input class="input" type="password" name="confirm" required oninvalid="this.setCustomValidity('Please confirm your password')" oninput="this.setCustomValidity('')"></div>
        <button type="submit" class="btn">Create Account</button>
      </form>
    </div>
  </div>

  <div class="app hidden" id="app">
    <header>
      <div class="logo">‚è∞ TimeBank</div>
      <div class="actions">
        <div class="pill balance">‚è±Ô∏è <span id="balanceDisplay">0h</span></div>
        <button class="icon-btn" id="notifBtn" title="Notifications" style="position:relative">
          <i class="fas fa-bell"></i>
          <span class="notif-badge" id="notifBadge">0</span>
        </button>
        <button class="icon-btn" onclick="loadView('inbox')" title="Inbox">üí¨</button>
        <button class="icon-btn profile-btn" id="headerProfileBtn">JD</button>
        <div class="profile-menu" id="profileMenu">
          <div class="pm-info"><b id="menuUsername" style="font-size:16px">User</b></div>
          <button class="pm-btn" id="viewProfileBtn" style="background:#dbeafe;color:#2563eb;margin-bottom:8px">View Profile</button>
          <button class="pm-btn" id="logoutBtn">Logout</button>
        </div>
        <div class="notifications-dropdown" id="notificationsDropdown">
          <div class="notif-header">
            <h3>Notifications</h3>
            <button class="notif-close-btn" onclick="closeNotifications()" title="Close">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="notif-body" id="notificationsBody">
            <div class="notif-empty">Loading notifications...</div>
          </div>
        </div>
      </div>
    </header>

    <div class="hero">
      <div class="cta primary" id="btnOffer"><span style="font-size:22px">‚ûï</span> Offer Service</div>
      <div class="cta" id="btnRequest"><span style="font-size:22px">üîé</span> Request Help</div>
    </div>

    <div class="main-map-container" id="mainMapContainer">
      <div id="mainMap" style="width:100%;height:100%"></div>
    </div>

    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" data-view="all">ALL</button>
        <button class="tab" data-view="offers">Offers</button>
        <button class="tab" data-view="requests">Requests</button>
        <button class="tab" data-view="forum">Forum</button>
        <button class="tab" data-view="inbox">Inbox</button>
        <button class="tab" data-view="admin" style="display:none">üëë Admin Panel</button>
      </div>
    </div>

    <div id="mainContent">
      <div class="search-container" id="searchContainer" style="display:none">
        <input type="text" class="search-box" id="searchInput" placeholder="üîç Search listings by title, description, user, location, category...">
      </div>
      <div class="grid" id="gridView"></div>
      
      <div class="hidden" id="forumContainer">
        <div id="forumView"></div>
      </div>
      
      <div class="hidden" id="adminContainer">
        <div id="adminView"></div>
      </div>
      
      <div class="hidden" id="inboxContainer">
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="loadInboxSub('chats')">üí¨ Chats</button>
            <button class="sub-tab" onclick="loadInboxSub('pending')">‚è≥ Pending Requests</button>
            <button class="sub-tab" onclick="loadInboxSub('listings')">üìã My Listings</button>
        </div>
        <div class="inbox-list" id="inboxContent"></div>
      </div>
    </div>
  </div>

  <aside class="sheet form-style" id="listingSheet">
    <div class="sheet-head"><button onclick="closeSheet('listingSheet')" style="border:0;background:none;font-size:24px;cursor:pointer;color:#666">√ó</button><h3>New Listing</h3></div>
    <div class="sheet-body">
      <form id="listingForm">
        <input type="hidden" id="listingType" value="offer">
        <input type="hidden" id="inpLat" value="">
        <input type="hidden" id="inpLng" value="">
        <div class="field"><label class="label">Title</label><input class="input" id="inpTitle" required oninvalid="this.setCustomValidity('Please enter a title')" oninput="this.setCustomValidity('')" placeholder="e.g. Guitar Lessons"></div>
        <div class="field"><label class="label">Category</label><select class="input" id="inpCat" required oninvalid="this.setCustomValidity('Please select a category')" oninput="this.setCustomValidity('')">
          <option value="" disabled selected>Please select a category</option>
          <option value="Education">Education</option>
          <option value="Tech">Tech</option>
          <option value="Home">Home</option>
          <option value="Art">Art</option>
          <option value="Sports">Sports</option>
          <option value="Health">Health</option>
          <option value="Music">Music</option>
          <option value="Language">Language</option>
          <option value="Cooking">Cooking</option>
          <option value="Photography">Photography</option>
          <option value="Writing">Writing</option>
          <option value="Design">Design</option>
          <option value="Business">Business</option>
          <option value="Other">Other</option>
        </select></div>
        <div class="field" id="customCategoryField" style="display:none"><label class="label">Custom Category</label><input type="text" class="input" id="inpCustomCat" oninvalid="this.setCustomValidity('Please enter a custom category')" oninput="this.setCustomValidity('')" placeholder="Enter your custom category"></div>
        <div class="field">
          <label class="label">Tags (Optional - Search Wikidata)</label>
          <div style="position:relative">
            <input type="text" class="input" id="tagSearchInput" placeholder="Search for tags (e.g., 'guitar', 'cooking')..." autocomplete="off" style="margin-bottom:8px">
            <div id="tagSuggestions" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.1)"></div>
          </div>
          <div id="selectedTags" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;min-height:32px"></div>
        </div>
        <div class="field"><label class="label">Duration (Hours)</label><input type="number" class="input" id="inpDur" value="1" min="1" step="1"></div>
        <div class="field" id="capacityField" style="display:none"><label class="label">Capacity (Number of Spots)</label><input type="number" class="input" id="inpCapacity" value="1" min="1" step="1" placeholder="How many people can join?"></div>
        <div class="field"><label class="label">Description</label><textarea class="input" id="inpDesc" rows="5" required oninvalid="this.setCustomValidity('Please enter a description')" oninput="this.setCustomValidity('')" placeholder="Details..."></textarea></div>
        <div class="field">
          <label class="label">Image (Optional)</label>
          <div class="image-upload-area" id="imageUploadArea" tabindex="0">
            <div class="image-upload-placeholder" id="imagePlaceholder">
              <strong>üì∑ Click or Paste Image</strong>
              <div>Press Ctrl+V to paste from clipboard</div>
            </div>
            <img id="imagePreview" class="image-preview" alt="Preview">
            <button type="button" class="image-remove-btn" id="imageRemoveBtn" onclick="removeImage()" style="display:none">√ó</button>
          </div>
          <input type="file" id="imageFileInput" accept="image/*" style="display:none">
        </div>
        <div class="field">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="inpIsOnline" style="width:18px;height:18px;cursor:pointer">
            <span>This service is Online / Remote (Location not required)</span>
          </label>
        </div>
        <div class="field" id="locationField">
          <label class="label">Location</label>
          <div class="search-container-relative">
            <input type="text" class="map-search" id="locationSearch" placeholder="Search address or click on map..." autocomplete="off">
            <div id="searchResults" class="search-results"></div>
          </div>
          <div id="locationMap" class="map-container"></div>
          <input type="text" class="input" id="inpAddress" placeholder="Selected address will appear here" readonly style="margin-top:8px">
        </div>
        <button type="submit" class="btn">Post Listing</button>
      </form>
    </div>
  </aside>

  <aside class="sheet" id="chatSheet">
    <div class="sheet-head"><button onclick="closeSheet('chatSheet')" style="border:0;background:none;font-size:24px;cursor:pointer">‚Üê</button><h3>Chat</h3></div>
    <div class="sheet-body" style="padding:0">
      <div id="actionBar" class="action-bar-modern" style="display:none"></div>
      <div class="chat-area" id="msgArea"></div>
      <form class="chat-footer" id="msgForm">
        <input class="chat-input" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="send-btn" style="width:46px;height:46px;border-radius:50%;border:0;background:var(--primary);color:#fff;cursor:pointer">‚û§</button>
      </form>
    </div>
  </aside>

  <!-- Review Modal -->
  <div class="modal-overlay" id="reviewModal">
    <div class="modal-content" style="background:#fff;border-radius:20px;padding:30px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
        <h3 style="margin:0;font-size:22px;font-weight:800">Leave a Review</h3>
        <button onclick="closeReviewModal()" style="border:0;background:none;font-size:28px;cursor:pointer;color:#666;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">√ó</button>
      </div>
      
      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:12px;font-weight:700;font-size:14px;color:#4b5563">Rating *</label>
        <div class="star-rating" id="starRating" style="display:flex;gap:8px;font-size:32px;cursor:pointer">
          <span class="star" data-rating="1" style="color:#e5e7eb;transition:color .2s">‚òÖ</span>
          <span class="star" data-rating="2" style="color:#e5e7eb;transition:color .2s">‚òÖ</span>
          <span class="star" data-rating="3" style="color:#e5e7eb;transition:color .2s">‚òÖ</span>
          <span class="star" data-rating="4" style="color:#e5e7eb;transition:color .2s">‚òÖ</span>
          <span class="star" data-rating="5" style="color:#e5e7eb;transition:color .2s">‚òÖ</span>
        </div>
        <input type="hidden" id="reviewRating" value="0">
      </div>
      
      <div style="margin-bottom:24px">
        <label style="display:block;margin-bottom:12px;font-weight:700;font-size:14px;color:#4b5563">Comment (Optional)</label>
        <textarea id="reviewComment" placeholder="Share your experience..." style="width:100%;min-height:120px;padding:12px;border-radius:12px;border:2px solid #e5e7eb;font-size:15px;font-family:inherit;resize:vertical" rows="4"></textarea>
      </div>
      
      <div style="display:flex;gap:12px">
        <button onclick="closeReviewModal()" style="flex:1;padding:14px;border-radius:12px;border:2px solid #e5e7eb;background:#fff;color:#4b5563;font-weight:700;cursor:pointer;transition:all .2s" onmouseover="this.style.borderColor='#d1d5db'" onmouseout="this.style.borderColor='#e5e7eb'">Cancel</button>
        <button onclick="submitReview()" style="flex:1;padding:14px;border-radius:12px;border:0;background:var(--primary);color:#fff;font-weight:800;cursor:pointer;transition:all .2s" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Submit Review</button>
      </div>
    </div>
  </div>

  <aside class="detail-sidebar" id="detailSidebar">
    <div class="detail-sidebar-header">
      <h3 style="margin:0;font-size:20px;font-weight:800">Listing Details</h3>
      <button onclick="closeDetailSidebar()" style="border:0;background:none;font-size:24px;cursor:pointer;color:#666;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">√ó</button>
    </div>
    <div class="detail-sidebar-body" id="detailSidebarBody">
      <!-- ƒ∞√ßerik dinamik olarak doldurulacak -->
    </div>
  </aside>

  <script>
    const API = '/api';
    let TOKEN = localStorage.getItem('token');
    let USER = JSON.parse(localStorage.getItem('user') || '{}');
    let CURRENT_VIEW = 'offers';
    let CURRENT_INBOX_SUB = 'chats'; 
    let ACTIVE_CHAT_ID = null;
    let POLLER = null;
    let LAST_RENDER_KEY = "";
    let USER_BALANCE = 0;
    
    // Arama deƒüi≈ükenleri (en √ºstte tanƒ±mla - hoisting sorununu √∂nlemek i√ßin)
    let allListings = [];
    let currentListingType = 'offers';
    let listingsData = null;

    const $ = s => document.querySelector(s);
    const toast = m => { const d=document.createElement('div');d.className='toast';d.innerText=m;document.body.appendChild(d);setTimeout(()=>d.remove(),3000) };

    if(TOKEN) initApp(); else $('#authModal').classList.add('open');

    $('#loginForm').onsubmit = e => { e.preventDefault(); authReq('/login/', {username:e.target.username.value, password:e.target.password.value}); };
    $('#signupForm').onsubmit = e => { 
      e.preventDefault(); 
      if(e.target.password.value!==e.target.confirm.value){
        Swal.fire({
          icon: 'error',
          title: 'Password Mismatch',
          text: 'Passwords do not match',
          confirmButtonColor: '#3085d6',
          timer: 3000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        return;
      }
      authReq('/register/', {username:e.target.username.value, email:e.target.email.value, password:e.target.password.value}, true); 
    };
    
    async function authReq(url, body, isSign=false){
      const res = await fetch(API+url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      const data = await res.json();
      if(res.ok){
        if(isSign){ 
        Swal.fire({
          icon: 'success',
          title: 'Account Created!',
          text: 'Please login now.',
          timer: 3000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
          $('#tabLogin').click(); 
        }
        else { localStorage.setItem('token',data.access); localStorage.setItem('user',JSON.stringify({username:body.username})); TOKEN=data.access; USER={username:body.username}; initApp(); }
      } else {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.error || 'An error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    function initApp(){
      $('#authModal').classList.remove('open'); $('#app').classList.remove('hidden');
      $('#headerProfileBtn').innerText = USER.username.substring(0,2).toUpperCase();
      $('#menuUsername').innerText = USER.username;
      fetchProfile(); loadView('all'); checkNotifications();
      // Ana haritayƒ± ba≈ülat - biraz gecikme ile (DOM hazƒ±r olsun)
      setTimeout(() => initMainMap(), 100);
      setInterval(() => { if(!ACTIVE_CHAT_ID) { fetchProfile(); checkNotifications(); } }, 5000); 
      setupPasteHandlers();
    }
    
    // Paste event handler - Yapƒ±≈ütƒ±rƒ±lan i√ßeriƒüi uygulama stillerine uyarla
    function setupPasteHandlers() {
      // Form alanlarƒ± i√ßin paste handler
      const formFields = ['#inpTitle', '#inpDesc', '#msgInput'];
      
      formFields.forEach(selector => {
        const element = $(selector);
        if(element) {
          element.addEventListener('paste', function(e) {
            e.preventDefault();
            
            // Clipboard'dan plain text al
            const pastedText = (e.clipboardData || window.clipboardData).getData('text/plain');
            
            // Mevcut se√ßili metni al
            const start = this.selectionStart;
            const end = this.selectionEnd;
            const currentValue = this.value;
            
            // Yeni deƒüeri olu≈ütur (se√ßili metni yapƒ±≈ütƒ±rƒ±lan metinle deƒüi≈ütir)
            const newValue = currentValue.substring(0, start) + pastedText + currentValue.substring(end);
            
            // Deƒüeri ayarla
            this.value = newValue;
            
            // Cursor pozisyonunu ayarla
            const newCursorPos = start + pastedText.length;
            this.setSelectionRange(newCursorPos, newCursorPos);
            
            // Input event'ini tetikle (form validation i√ßin)
            this.dispatchEvent(new Event('input', { bubbles: true }));
          });
        }
      });
    }

    function initMainMap(){
      if(mainMap) return;
      
      const mapEl = $('#mainMap');
      if(!mapEl) {
        console.error('Main map container not found');
        return;
      }
      
      try {
        mainMap = L.map('mainMap').setView([39.9334, 32.8597], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(mainMap);
        loadMapMarkers();
      } catch(err) {
        console.error('Error initializing main map:', err);
      }
    }

    async function loadMapMarkers(){
      if(!mainMap) return;
      
      // Mevcut marker'larƒ± temizle
      mainMapMarkers.forEach(m => mainMap.removeLayer(m));
      mainMapMarkers = [];

      // T√ºm aktif ilanlarƒ± getir
      const offers = await req('/service-offers/');
      const requests = await req('/service-requests/');

      // Offer marker'larƒ± (mavi)
      offers.forEach(item => {
        if(item.latitude && item.longitude) {
          const marker = L.marker([parseFloat(item.latitude), parseFloat(item.longitude)], {
            icon: L.divIcon({
              className: 'custom-marker offer-marker',
              html: '<div style="background:#667eea;width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></div>',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          }).addTo(mainMap);
          marker.on('click', () => openDetailSidebar(item, 'offer'));
          mainMapMarkers.push(marker);
        }
      });

      // Request marker'larƒ± (ye≈üil)
      requests.forEach(item => {
        if(item.latitude && item.longitude) {
          const marker = L.marker([parseFloat(item.latitude), parseFloat(item.longitude)], {
            icon: L.divIcon({
              className: 'custom-marker request-marker',
              html: '<div style="background:#10b981;width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></div>',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          }).addTo(mainMap);
          marker.on('click', () => openDetailSidebar(item, 'request'));
          mainMapMarkers.push(marker);
        }
      });
    }
    
    // Haritayƒ± yenile (marker'larƒ± g√ºncelle)
    function updateMapMarkers() {
      if(mainMap) {
        loadMapMarkers();
      }
    }
    
    window.updateMapMarkers = updateMapMarkers;

    function openDetailSidebar(item, type) {
      currentDetailItem = {item, type};
      const body = $('#detailSidebarBody');
      // user_info kontrol√º
      if(!item.user_info || !item.user_info.username) {
        console.error('Invalid item data:', item);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Invalid listing data',
          confirmButtonColor: '#3085d6'
        });
        return;
      }
      const isOwn = item.user_info.username === USER.username;
      
      // Badge HTML
      const badgeClass = type === 'offer' ? 'offer' : 'request';
      const badgeText = type === 'offer' ? 'OFFER' : 'REQUEST';
      const onlineBadge = item.is_online ? '<span class="detail-online-badge" style="display:inline-flex;align-items:center;gap:6px;background:#3b82f6;color:#fff;padding:6px 12px;border-radius:99px;font-size:12px;font-weight:700;margin-left:8px"><i class="fas fa-globe"></i> Online / Remote</span>' : '';
      
      // Resim HTML - sadece resim varsa g√∂ster
      const imageHtml = item.image_url ? 
        `<div class="detail-image"><img src="${item.image_url}" alt="${item.title}"></div>` : '';
      
      body.innerHTML = `
        <span class="detail-badge ${badgeClass}">${badgeText}</span>${onlineBadge}
        ${imageHtml}
        <h2 class="detail-title">${item.title}</h2>
        <div class="detail-meta">
          <div class="detail-meta-item"><span>üë§</span> <a href="/profile/${item.user_info.username}/" style="color:#667eea;text-decoration:none;font-weight:700">${item.user_info.username}</a></div>
          <div class="detail-meta-item"><span>‚è±Ô∏è</span> <span>${item.duration}h</span></div>
          <div class="detail-meta-item"><span>üìÇ</span> <span>${item.category}</span></div>
          ${type === 'offer' && item.capacity ? `<div class="detail-meta-item"><span>üë•</span> <span>${item.capacity} ${item.capacity === 1 ? 'spot' : 'spots'} available</span></div>` : ''}
          <div class="detail-meta-item"><span>üìÖ</span> <span>${formatDate(item.created_at)}</span></div>
        </div>
        <div class="detail-description">${item.description}</div>
        ${item.address ? `<div class="detail-address">üìç ${item.address}</div>` : ''}
        ${isOwn && type === 'offer' && item.pending_interactions && item.pending_interactions.length > 0 ? `
          <div style="margin-top:20px;padding:16px;background:#f9fafb;border-radius:12px">
            <h3 style="font-size:16px;font-weight:700;margin-bottom:12px;color:#1f2937">Pending Requests (${item.pending_interactions.length})</h3>
            ${item.pending_interactions.map(p => `
              <div style="background:#fff;padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid #e5e7eb">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <div style="display:flex;align-items:center;gap:8px">
                    <div style="width:32px;height:32px;border-radius:50%;background:#667eea;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px">${(p.sender_username || 'U')[0].toUpperCase()}</div>
                    <a href="/profile/${p.sender_username}/" style="color:#667eea;text-decoration:none;font-weight:700;font-size:14px">${p.sender_username}</a>
                  </div>
                  <div style="display:flex;gap:6px">
                    <button onclick="acceptRequestFromDetail(${p.id})" style="padding:6px 12px;border-radius:6px;border:0;background:#10b981;color:#fff;font-size:12px;font-weight:700;cursor:pointer">Accept</button>
                    <button onclick="declineRequestFromDetail(${p.id})" style="padding:6px 12px;border-radius:6px;border:0;background:#ef4444;color:#fff;font-size:12px;font-weight:700;cursor:pointer">Decline</button>
                  </div>
                </div>
                ${p.message ? `<div style="font-size:13px;color:#4b5563;margin-top:8px;padding-top:8px;border-top:1px solid #e5e7eb">${(p.message || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : ''}
              </div>
            `).join('')}
          </div>
        ` : ''}
        ${!isOwn ? `
          <div class="detail-actions">
            <button class="detail-btn primary" onclick="startChatFromDetail(${item.id}, '${type}')">Contact</button>
            <button class="detail-btn danger" onclick="blockUser('${item.user_info.username}')" style="background:#fee2e2;color:#dc2626">
              <i class="fas fa-ban"></i> Block User
            </button>
            <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
          </div>
        ` : `
          <div class="detail-actions">
            <button class="detail-btn danger" onclick="deleteListingFromDetail(${item.id}, '${type}')">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
            <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
          </div>
        `}
      `;
      $('#detailSidebar').classList.add('open');
    }

    function closeDetailSidebar() {
      $('#detailSidebar').classList.remove('open');
      currentDetailItem = null;
    }
    
    async function acceptRequestFromDetail(interactionId) {
      try {
        const r = await req(`/interaction/${interactionId}/accept/`, 'POST');
        if(r.status || r.status === 'accepted') {
          Swal.fire({
            icon: 'success',
            title: 'Accepted!',
            text: 'Request has been accepted',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          // Sidebar'ƒ± yenile
          if(currentDetailItem && currentDetailItem.item && currentDetailItem.item.id) {
            try {
              const endpoint = currentDetailItem.type === 'offer' ? `/service-offers/${currentDetailItem.item.id}/` : `/service-requests/${currentDetailItem.item.id}/`;
              const item = await req(endpoint);
              if(item && item.user_info && item.user_info.username) {
                openDetailSidebar(item, currentDetailItem.type);
              } else {
                // Listing bulunamadƒ± veya eksik veri, sidebar'ƒ± kapat
                closeDetailSidebar();
              }
            } catch(loadErr) {
              // Listing bulunamadƒ±, sidebar'ƒ± kapat
              console.error('Error reloading listing:', loadErr);
              closeDetailSidebar();
            }
          }
          // Listeleri yenile
          if(currentListingType) {
            await fetchListings(currentListingType);
          }
          // Pending requests listesini de yenile
          if(CURRENT_INBOX_SUB === 'pending') {
            fetchPendingRequests();
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.error || 'Failed to accept request',
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to accept request',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    async function declineRequestFromDetail(interactionId) {
      try {
        const r = await req(`/interaction/${interactionId}/decline/`, 'POST');
        if(r.status || r.status === 'declined') {
          Swal.fire({
            icon: 'success',
            title: 'Declined',
            text: 'Request has been declined',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          // Sidebar'ƒ± yenile
          if(currentDetailItem && currentDetailItem.item && currentDetailItem.item.id) {
            try {
              const endpoint = currentDetailItem.type === 'offer' ? `/service-offers/${currentDetailItem.item.id}/` : `/service-requests/${currentDetailItem.item.id}/`;
              const item = await req(endpoint);
              if(item && item.user_info && item.user_info.username) {
                openDetailSidebar(item, currentDetailItem.type);
              } else {
                // Listing bulunamadƒ± veya eksik veri, sidebar'ƒ± kapat
                closeDetailSidebar();
              }
            } catch(loadErr) {
              // Listing bulunamadƒ±, sidebar'ƒ± kapat
              console.error('Error reloading listing:', loadErr);
              closeDetailSidebar();
            }
          }
          // Listeleri yenile
          if(currentListingType) {
            await fetchListings(currentListingType);
          }
          // Pending requests listesini de yenile
          if(CURRENT_INBOX_SUB === 'pending') {
            fetchPendingRequests();
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.error || 'Failed to decline request',
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to decline request',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    window.closeDetailSidebar = closeDetailSidebar;

    function startChatFromDetail(id, type) {
      closeDetailSidebar();
      startChat(id, type);
    }
    
    // Detail sidebar'dan silme
    async function deleteListingFromDetail(id, type) {
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
      });
      
      if(!result.isConfirmed) {
        return;
      }
      
      try {
        const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
        const deleteResult = await req(endpoint, 'DELETE');
        
        // DELETE ba≈üarƒ±lƒ± olabilir (204 No Content veya success response)
        // Hata kontrol√º
        if(deleteResult && deleteResult.error) {
          await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: deleteResult.error,
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        
        // Ba≈üarƒ±lƒ± mesajƒ± g√∂ster
        Swal.fire({
          icon: 'success',
          title: 'Deleted!',
          text: 'Listing deleted successfully!',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        
        // myListingsData'dan silinen ilanƒ± kaldƒ±r
        myListingsData = myListingsData.filter(item => !(item.id === id && item.type === type));
        
        // Detail sidebar'ƒ± kapat
        closeDetailSidebar();
        
        // Eƒüer profil sayfasƒ±ndaysak, sayfayƒ± yenile
        if(window.location.pathname.includes('/profile/')) {
          window.location.reload();
          return;
        }
        
        // Listeyi yenile (await ile)
        await fetchMyListings();
        
        // Ana sayfadaki listeyi de yenile
        if(currentListingType) {
          await fetchListings(currentListingType);
        }
        // Haritayƒ± da yenile
        if(window.mainMap) {
          updateMapMarkers();
        }
      } catch(err) {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Unknown error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    window.deleteListingFromDetail = deleteListingFromDetail;

    $('#headerProfileBtn').onclick = e => { 
      e.stopPropagation(); 
      $('#profileMenu').classList.toggle('show');
    };
    document.onclick = e => { if(!e.target.closest('.actions')) $('#profileMenu').classList.remove('show'); };
    $('#viewProfileBtn').onclick = () => { 
      if(USER && USER.username) {
        window.location.href = `/profile/${USER.username}/`;
      }
    };
    $('#logoutBtn').onclick = () => { 
      localStorage.clear(); 
      TOKEN = null;
      USER = {};
      ACTIVE_CHAT_ID = null;
      LAST_RENDER_KEY = '';
      if(POLLER) {
        clearInterval(POLLER);
        POLLER = null;
      }
      // T√ºm sidebar'larƒ± kapat
      $('#chatSheet').classList.remove('open');
      $('#detailSidebar').classList.remove('open');
      $('#listingSheet').classList.remove('open');
      $('#notificationsDropdown').classList.remove('show');
      $('#reviewModal').classList.remove('open');
      // ƒ∞√ßerikleri temizle
      $('#gridView').innerHTML = '';
      $('#inboxContainer').innerHTML = '';
      $('#msgArea').innerHTML = '';
      $('#actionBar').style.display = 'none';
      // Auth modal'ƒ± a√ß
      $('#authModal').classList.add('open');
      // Navbar'ƒ± g√ºncelle - profil butonunu gizle
      const profileBtn = document.querySelector('.profile-btn');
      const profileMenu = document.querySelector('.profile-menu');
      if(profileBtn) profileBtn.style.display = 'none';
      if(profileMenu) profileMenu.style.display = 'none';
    };

    $('#tabLogin').onclick = () => { $('#loginForm').classList.remove('hidden'); $('#signupForm').classList.add('hidden'); $('#tabLogin').classList.add('active'); $('#tabSignup').classList.remove('active'); };
    $('#tabSignup').onclick = () => { $('#signupForm').classList.remove('hidden'); $('#loginForm').classList.add('hidden'); $('#tabSignup').classList.add('active'); $('#tabLogin').classList.remove('active'); };

    document.querySelectorAll('.tab[data-view]').forEach(b => b.onclick = () => loadView(b.dataset.view));

    function loadView(view){
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.view===view));
      if(view === 'inbox') {
        $('#gridView').classList.add('hidden');
        $('#forumContainer').classList.add('hidden');
        $('#adminContainer').classList.add('hidden');
        $('#inboxContainer').classList.remove('hidden');
        $('#searchContainer').style.display = 'none';
        loadInboxSub('chats');
      } else if(view === 'forum') {
        $('#gridView').classList.add('hidden');
        $('#inboxContainer').classList.add('hidden');
        $('#adminContainer').classList.add('hidden');
        $('#forumContainer').classList.remove('hidden');
        $('#searchContainer').style.display = 'none';
        fetchForumTopics();
      } else if(view === 'admin') {
        // Check if user is admin before loading admin panel
        if(!USER.is_superuser && !USER.is_staff) {
          toast('Access denied. Admin privileges required.');
          loadView('all');
          return;
        }
        $('#gridView').classList.add('hidden');
        $('#inboxContainer').classList.add('hidden');
        $('#forumContainer').classList.add('hidden');
        $('#adminContainer').classList.remove('hidden');
        $('#searchContainer').style.display = 'none';
        loadAdminDashboard();
      } else {
        $('#gridView').classList.remove('hidden');
        $('#inboxContainer').classList.add('hidden');
        $('#forumContainer').classList.add('hidden');
        $('#adminContainer').classList.add('hidden');
        $('#searchContainer').style.display = 'block';
        // Arama kutusunu sƒ±fƒ±rla
        $('#searchInput').value = '';
        fetchListings(view);
      }
    }

    window.loadInboxSub = function(sub){
        CURRENT_INBOX_SUB = sub;
        // T√ºm sekmeleri deaktif et
        document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
        // ƒ∞lgili sekmeyi aktif et
        document.querySelectorAll('.sub-tab').forEach(t => {
            const tabText = t.innerText.toLowerCase();
            if((sub === 'chats' && tabText.includes('chat')) || 
               (sub === 'pending' && tabText.includes('pending')) || 
               (sub === 'listings' && tabText.includes('listing'))) {
                t.classList.add('active');
            }
        });
        if(sub==='chats') fetchChats();
        else if(sub==='pending') fetchPendingRequests();
        else if(sub==='listings') fetchMyListings();
    }

    async function fetchForumTopics(){
      try {
        const topics = await req('/forum-topics/').catch(() => []);
        const forumView = $('#forumView');
        
        if(!Array.isArray(topics) || topics.length === 0) {
          forumView.innerHTML = `
            <div style="margin-bottom:24px">
              <button class="action-btn" onclick="openForumCreate()" style="width:100%;max-width:400px;background:var(--primary);color:#fff;font-weight:700;padding:14px 24px;border-radius:12px;border:0;cursor:pointer;transition:transform .2s;box-shadow:0 4px 12px rgba(102,126,234,0.3);font-size:15px">
                ‚ûï Create New Topic
              </button>
            </div>
            <div style="text-align:center;padding:60px 20px;background:#fff;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.05)">
              <div style="font-size:48px;margin-bottom:16px">üí¨</div>
              <h3 style="font-size:24px;font-weight:800;margin-bottom:12px;color:#1f2937">No Topics Yet</h3>
              <p style="color:#6b7280;margin-bottom:24px">Be the first to start a discussion!</p>
            </div>
          `;
          return;
        }
        
        const categoryLabels = {
          'general': 'General',
          'group_request': 'Group Request',
          'event': 'Event',
          'help': 'Help'
        };
        
        forumView.innerHTML = `
          <div style="margin-bottom:24px">
            <button class="action-btn" onclick="openForumCreate()" style="width:100%;max-width:400px;background:var(--primary);color:#fff;font-weight:700;padding:14px 24px;border-radius:12px;border:0;cursor:pointer;transition:transform .2s;box-shadow:0 4px 12px rgba(102,126,234,0.3);font-size:15px">
              ‚ûï Create New Topic
            </button>
          </div>
          <div class="inbox-list">
            ${topics.map(topic => {
              const cat = topic.category || 'general';
              const catLabel = categoryLabels[cat] || cat;
              const commentCount = topic.comment_count || 0;
              const authorInitial = (topic.author_username || 'U')[0].toUpperCase();
              
              return `
              <div class="inbox-item" onclick="openForumTopic(${topic.id})">
                <div class="inbox-icon" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;font-weight:800;font-size:18px">
                  ${authorInitial}
                </div>
                <div class="inbox-info" style="flex:1">
                  <div class="inbox-title" style="font-size:18px;font-weight:800;color:#1f2937;margin-bottom:6px">${topic.title || 'Untitled'}</div>
                  <div style="font-size:13px;color:#666;margin-bottom:8px;line-height:1.5">
                    ${(topic.content || '').replace(/\n/g, ' ').substring(0, 100)}${(topic.content || '').length > 100 ? '...' : ''}
                  </div>
                  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;font-size:12px;color:#6b7280">
                    <span>üë§ <a href="/profile/${topic.author_username || 'unknown'}/" style="color:#667eea;text-decoration:none;font-weight:700" onclick="event.stopPropagation()">${topic.author_username || 'Unknown'}</a></span>
                    <span>‚Ä¢</span>
                    <span>${formatDate(topic.created_at)}</span>
                    <span>‚Ä¢</span>
                    <span style="font-size:11px;font-weight:700;padding:3px 8px;border-radius:99px;background:#f3f4f6;color:#6b7280;text-transform:uppercase">${catLabel}</span>
                    <span>‚Ä¢</span>
                    <span>üí¨ ${commentCount} ${commentCount === 1 ? 'comment' : 'comments'}</span>
                  </div>
                </div>
              </div>
            `;
            }).join('')}
          </div>
        `;
      } catch(err) {
        console.error('Error fetching forum topics:', err);
        $('#forumView').innerHTML = `
          <div style="text-align:center;padding:60px 20px;background:#fff;border-radius:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05)">
            <div style="font-size:48px;margin-bottom:16px">üí¨</div>
            <h3 style="font-size:24px;font-weight:800;margin-bottom:12px;color:#1f2937">Forum</h3>
            <p style="color:#6b7280">Loading topics...</p>
          </div>
        `;
      }
    }

    function openForumCreate(){
      Swal.fire({
        title: 'Create Forum Topic',
        html: `
          <input id="forumTitle" class="swal2-input" placeholder="Topic Title">
          <select id="forumCategory" class="swal2-input" style="margin-top:10px">
            <option value="general">General</option>
            <option value="group_request">Group Request</option>
            <option value="event">Event</option>
            <option value="help">Help</option>
          </select>
          <textarea id="forumContent" class="swal2-textarea" placeholder="Topic Content" style="margin-top:10px;min-height:150px"></textarea>
        `,
        showCancelButton: true,
        confirmButtonText: 'Create',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#667eea',
        preConfirm: () => {
          const title = document.getElementById('forumTitle').value.trim();
          const content = document.getElementById('forumContent').value.trim();
          const category = document.getElementById('forumCategory').value;
          if(!title || !content) {
            Swal.showValidationMessage('Please fill in all fields');
            return false;
          }
          return {title, content, category};
        }
      }).then(async (result) => {
        if(result.isConfirmed) {
          try {
            const response = await req('/forum-topics/', 'POST', result.value);
            if(response.id) {
              Swal.fire({
                icon: 'success',
                title: 'Topic Created!',
                timer: 2000,
                showConfirmButton: false,
                position: 'top-end',
                toast: true
              });
              fetchForumTopics();
            }
          } catch(err) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: err.message || 'Failed to create topic',
              confirmButtonColor: '#3085d6'
            });
          }
        }
      });
    }

    async function openForumTopic(topicId){
      try {
        const topic = await req(`/forum-topics/${topicId}/`);
        const comments = await req(`/forum-topics/${topicId}/comments/`).catch(() => []);
        
        const commentsHtml = Array.isArray(comments) && comments.length > 0 ? comments.map(c => `
          <div style="background:#f9fafb;padding:16px;border-radius:12px;margin-bottom:12px;border-left:4px solid #667eea">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700;color:#1f2937">üë§ ${c.author_username || 'Unknown'}</div>
              <div style="font-size:12px;color:#6b7280">${formatDate(c.created_at)}</div>
            </div>
            <div style="color:#4b5563;line-height:1.6;white-space:pre-wrap">${(c.content || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          </div>
        `).join('') : '<p style="color:#6b7280;text-align:center;padding:20px">No comments yet</p>';
        
        Swal.fire({
          title: topic.title || 'Forum Topic',
          html: `
            <div style="text-align:left;max-height:60vh;overflow-y:auto">
              <div style="background:#f0f9ff;padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid #667eea">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                  <div style="font-weight:700;color:#1f2937">üë§ ${topic.author_username || 'Unknown'}</div>
                  <div style="font-size:12px;color:#6b7280">${formatDate(topic.created_at)}</div>
                </div>
                <div style="color:#4b5563;line-height:1.6;white-space:pre-wrap">${(topic.content || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
              </div>
              <div style="margin-bottom:16px">
                <h4 style="font-weight:700;margin-bottom:12px;color:#1f2937">Comments (${Array.isArray(comments) ? comments.length : 0})</h4>
                ${commentsHtml}
              </div>
              <div style="margin-top:20px">
                <textarea id="newComment" placeholder="Write a comment..." style="width:100%;padding:12px;border-radius:8px;border:2px solid #e5e7eb;min-height:100px;font-family:inherit;resize:vertical"></textarea>
                <button onclick="submitForumComment(${topicId})" style="width:100%;margin-top:12px;padding:12px;border-radius:8px;border:0;background:var(--primary);color:#fff;font-weight:700;cursor:pointer">Post Comment</button>
              </div>
            </div>
          `,
          width: '700px',
          showConfirmButton: true,
          confirmButtonText: 'Close',
          confirmButtonColor: '#667eea'
        });
      } catch(err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to load topic',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    async function submitForumComment(topicId){
      const content = document.getElementById('newComment')?.value.trim();
      if(!content) {
        Swal.fire({
          icon: 'warning',
          title: 'Required',
          text: 'Please write a comment',
          confirmButtonColor: '#3085d6',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        return;
      }
      
      try {
        await req(`/forum-topics/${topicId}/comments/`, 'POST', {content});
        Swal.fire({
          icon: 'success',
          title: 'Comment Posted!',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        openForumTopic(topicId);
      } catch(err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to post comment',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    window.submitForumComment = submitForumComment;
    window.openForumCreate = openForumCreate;


    // Tarih formatlama fonksiyonu
    function formatDate(dateString) {
      if(!dateString) return '';
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if(diffMins < 1) return 'Just now';
      if(diffMins < 60) return `${diffMins}m ago`;
      if(diffHours < 24) return `${diffHours}h ago`;
      if(diffDays < 7) return `${diffDays}d ago`;
      
      // Daha eski tarihler i√ßin tam format
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined }) + 
             ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    // Arama fonksiyonu
    function filterListings(searchTerm) {
      const searchLower = searchTerm.toLowerCase();
      if(!searchTerm || searchTerm.trim() === '') {
        // Arama terimi yoksa t√ºm ilanlarƒ± g√∂ster
        renderListings(allListings);
        return;
      }
      
      // allListings bo≈üsa, √∂nce fetch et
      if(!allListings || allListings.length === 0) {
        const type = currentListingType || 'all';
        fetchListings(type);
        return;
      }
      
      const term = searchTerm.toLowerCase().trim();
      const filtered = allListings.filter(item => {
        // Ba≈ülƒ±kta ara
        if(item.title && item.title.toLowerCase().includes(term)) return true;
        // A√ßƒ±klamada ara
        if(item.description && item.description.toLowerCase().includes(term)) return true;
        // Kullanƒ±cƒ± adƒ±nda ara
        if(item.user_info && item.user_info.username && item.user_info.username.toLowerCase().includes(term)) return true;
        // Konumda ara
        if(item.address && item.address.toLowerCase().includes(term)) return true;
        // Kategoride ara
        if(item.category && item.category.toLowerCase().includes(term)) return true;
        // Tags'de ara
        if(item.tags && Array.isArray(item.tags)) {
          for(const tag of item.tags) {
            if(tag && tag.toLowerCase().includes(term)) return true;
          }
        }
        return false;
      });
      
      renderListings(filtered);
    }
    
    // Listeleri render et
    function renderListings(listings) {
      const gridEl = $('#gridView');
      
      if(!listings || listings.length === 0) {
        gridEl.innerHTML = '<div style="padding:20px;color:#fff;text-align:center;grid-column:1/-1">No listings found.</div>';
        return;
      }
      
      // currentListingType'ƒ± tekil forma √ßevir (offers -> offer, requests -> request, all -> item._type kullan)
      let singularType = 'offer';
      if(currentListingType === 'offers') {
        singularType = 'offer';
      } else if(currentListingType === 'requests') {
        singularType = 'request';
      }
      // all durumunda item._type kullanƒ±lacak
      
      gridEl.innerHTML = listings.map((i, idx)=> {
        // Eƒüer all view'ƒ±ndaysak, item'ƒ±n _type'ƒ±nƒ± kullan
        const itemType = currentListingType === 'all' ? (i._type || 'offer') : singularType;
        const buttonType = currentListingType === 'all' ? (i._type === 'request' ? 'requests' : 'offers') : currentListingType;
        
        // Badge HTML
        const badgeText = itemType === 'offer' ? 'OFFER' : 'REQUEST';
        const badgeClass = itemType === 'offer' ? 'offer' : 'request';
        const onlineBadge = i.is_online ? '<span style="font-size:9px;font-weight:800;background:#3b82f6;color:#fff;padding:4px 8px;border-radius:99px;display:inline-flex;align-items:center;gap:4px;margin-left:8px"><i class="fas fa-globe"></i> Online / Remote</span>' : '';
        
        // Spot bilgisi (sadece offer i√ßin ve capacity varsa)
        const capacity = i.capacity || 1;
        const acceptedCount = i.accepted_count || 0;
        const spotsHtml = itemType === 'offer' && capacity > 1 ? `
          <div style="margin-top:8px;margin-bottom:8px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;font-size:12px;font-weight:700;color:#4b5563">
              <span>üë• Spots</span>
              <span>${acceptedCount}/${capacity}</span>
            </div>
            <div style="width:100%;height:8px;background:#e5e7eb;border-radius:99px;overflow:hidden">
              <div style="width:${(acceptedCount / capacity) * 100}%;height:100%;background:${acceptedCount >= capacity ? '#10b981' : '#667eea'};transition:width .3s;border-radius:99px"></div>
            </div>
          </div>
        ` : '';
        
        return `
        <div class="card" data-item-id="${i.id}" data-item-type="${itemType}" data-item-index="${idx}" style="cursor:pointer;position:relative">
          <div class="card-header-row">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <span class="card-type-badge ${badgeClass}" style="${itemType === 'offer' ? 'background:#667eea;color:#fff' : 'background:#10b981;color:#fff'}">${badgeText}</span>
              ${onlineBadge}
            </div>
            <span class="card-cat">${i.category}</span>
          </div>
          ${spotsHtml}
          <h3>${i.title}</h3>
          <p>${i.description}</p>
          <div class="card-meta">
            <div class="user-tag"><div class="u-avatar">${i.user_info.username[0].toUpperCase()}</div><a href="/profile/${i.user_info.username}/" style="color:inherit;text-decoration:none;font-weight:700">${i.user_info.username}</a></div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
              <div>‚è±Ô∏è ${i.duration}h</div>
              <div style="font-size:11px;color:#999;font-weight:500">${formatDate(i.created_at)}</div>
            </div>
          </div>
          ${getButtonHtml(i, buttonType)}
        </div>`;
      }).join('');
      
      // Her karta click event ekle
      gridEl.querySelectorAll('.card').forEach(card => {
        card.onclick = function(e) {
          // Eƒüer butona tƒ±klandƒ±ysa, butonun i≈ülevini √ßalƒ±≈ütƒ±r (sidebar a√ßma)
          if(e.target.closest('.action-btn')) {
            return; // Butonun kendi onclick'i √ßalƒ±≈üsƒ±n
          }
          const itemId = parseInt(this.dataset.itemId);
          const itemType = this.dataset.itemType; // Bu artƒ±k 'offer' veya 'request' olacak
          const itemIndex = parseInt(this.dataset.itemIndex);
          const item = listings[itemIndex];
          if(item) {
            openDetailSidebar(item, itemType);
          }
        };
      });
    }

    async function req(ep, m='GET', b, isFormData=false){
      try{
        const headers = {'Authorization':`Bearer ${TOKEN}`};
        if(!isFormData && m !== 'DELETE') headers['Content-Type'] = 'application/json';
        
        const fetchOptions = {
          method: m,
          headers: headers
        };
        
        // DELETE i√ßin body g√∂nderme
        if(m !== 'DELETE' && b) {
          fetchOptions.body = isFormData ? b : JSON.stringify(b);
        }
        
        const r = await fetch(API+ep, fetchOptions);
        if(r.status===401){ localStorage.clear(); location.reload(); }
        // DELETE i√ßin bo≈ü response olabilir
        if(r.status === 204 || (m === 'DELETE' && r.status === 200)) {
          return {success: true};

        }
        const data = await r.json();
        return data;
      }catch(err){ 
        console.error('Request failed:', err);
        return {error: err.message || 'Request failed'}; 
      }
    }

    async function fetchProfile(){ 
      const d=await req('/profile/'); 
      if(d) { 
        $('#balanceDisplay').innerText=d.balance+'h'; 
        USER_BALANCE = d.balance; 
      }
      // Fetch user details to check admin status
      try {
        const userData = await req('/user/');
        if(userData) {
          USER.is_superuser = userData.is_superuser || false;
          USER.is_staff = userData.is_staff || false;
          // Update admin panel link visibility
          const adminTab = document.querySelector('.tab[data-view="admin"]');
          if(adminTab) {
            adminTab.style.display = (USER.is_superuser || USER.is_staff) ? 'block' : 'none';
          }
        }
      } catch(e) {
        console.error('Error fetching user data:', e);
      }
    }
    async function checkNotifications(){ 
      const d=await req('/notifications/count/'); 
      $('#notifBadge').innerText=d.count; 
      $('#notifBadge').classList.toggle('show', d.count>0); 
    }
    
    // Bildirim dropdown fonksiyonlarƒ±
    $('#notifBtn').onclick = async function(e) {
      e.stopPropagation();
      const dropdown = $('#notificationsDropdown');
      const wasOpen = dropdown.classList.contains('show');
      dropdown.classList.toggle('show');
      
      if(dropdown.classList.contains('show') && !wasOpen) {
        // ƒ∞lk a√ßƒ±lƒ±≈üta bildirimleri y√ºkle ve okundu olarak i≈üaretle
        await loadNotifications();
        // T√ºm okunmamƒ±≈ü bildirimleri okundu olarak i≈üaretle
        await req('/notifications/mark-read/', 'POST');
        // Sayƒ±yƒ± g√ºncelle
        await checkNotifications();
      }
    };
    
    // Dƒ±≈üarƒ± tƒ±klandƒ±ƒüƒ±nda kapat
    document.addEventListener('click', function(e) {
      if(!e.target.closest('#notifBtn') && !e.target.closest('#notificationsDropdown')) {
        $('#notificationsDropdown').classList.remove('show');
      }
    });
    
    function closeNotifications() {
      $('#notificationsDropdown').classList.remove('show');
    }
    
    window.closeNotifications = closeNotifications;
    
    // Bildirim t√ºr√ºne g√∂re ikon ve renk belirleme
    function getNotificationIcon(status, type) {
      // type field'ƒ±nƒ± √∂ncelikli olarak kullan
      if(type === 'message') {
        return { icon: 'fa-comment', class: 'message' };
      } else if(type === 'interaction_accepted' || status === 'accepted') {
        return { icon: 'fa-check-circle', class: 'accepted' };
      } else if(type === 'completed' || status === 'completed') {
        return { icon: 'fa-clock', class: 'time-credit' };
      } else if(type === 'date_proposed') {
        return { icon: 'fa-calendar', class: 'message' };
      } else if(type === 'date_rejected') {
        return { icon: 'fa-times-circle', class: 'warning' };
      } else if(type === 'date_accepted') {
        return { icon: 'fa-check-circle', class: 'accepted' };
      } else if(type === 'scheduled') {
        return { icon: 'fa-calendar-check', class: 'accepted' };
      } else if(status === 'pending') {
        return { icon: 'fa-comment', class: 'message' };
      } else if(status === 'declined' || status === 'cancelled') {
        return { icon: 'fa-exclamation-triangle', class: 'warning' };
      } else {
        return { icon: 'fa-bell', class: 'message' };
      }
    }
    
    // Bildirim ba≈ülƒ±ƒüƒ± olu≈ütur
    function getNotificationTitle(notification) {
      const type = notification.type || 'message';
      
      if(type === 'message') {
        return 'New Message';
      } else if(type === 'interaction_accepted') {
        return 'Request Accepted';
      } else if(type === 'date_proposed') {
        return 'Date Proposed';
      } else if(type === 'date_rejected') {
        return 'Date Rejected';
      } else if(type === 'date_accepted') {
        return 'Date Accepted';
      } else if(type === 'scheduled') {
        return 'Scheduled';
      } else if(type === 'completed') {
        return 'Transaction Completed';
      } else {
        return 'Notification';
      }
    }
    
    // Bildirim mesajƒ± olu≈ütur
    function getNotificationMessage(notification) {
      // notification.message field'ƒ± direkt kullanƒ±labilir
      if(notification.message) {
        return notification.message;
      }
      
      const type = notification.type || 'message';
      const listingTitle = notification.title || 'Listing';
      
      if(type === 'message') {
        return 'You have a new message';
      } else if(type === 'interaction_accepted') {
        return `Your request for "${listingTitle}" has been accepted`;
      } else if(type === 'date_proposed') {
        return 'A date has been proposed for your transaction';
      } else if(type === 'date_rejected') {
        return 'Your proposed date was rejected';
      } else if(type === 'date_accepted') {
        return 'Your proposed date was accepted';
      } else if(type === 'scheduled') {
        return 'Transaction has been scheduled';
      } else if(type === 'completed') {
        return `Transaction for "${listingTitle}" has been completed`;
      } else {
        return 'You have a new notification';
      }
    }
    
    // Bildirimleri y√ºkle
    async function loadNotifications() {
      const data = await req('/notifications/list/');
      // API direkt array d√∂nd√ºr√ºyor, data.notifications deƒüil
      const notifications = Array.isArray(data) ? data : (data.notifications || []);
      const body = $('#notificationsBody');
      
      if(notifications.length === 0) {
        body.innerHTML = '<div class="notif-empty"><i class="fas fa-bell-slash" style="font-size:32px;margin-bottom:12px;opacity:0.3"></i><div>No notifications</div></div>';
        return;
      }
      
      body.innerHTML = notifications.map(notif => {
        const iconInfo = getNotificationIcon(notif.status || '', notif.type || 'message');
        const isUnread = !notif.is_read; // is_read field'ƒ±nƒ± kullan
        const title = getNotificationTitle(notif);
        const message = getNotificationMessage(notif);
        const date = formatDate(notif.created_at);
        const interactionId = notif.interaction_id || null;
        
        return `
          <div class="notif-card ${isUnread ? 'unread' : ''}" onclick="handleNotificationClick(${interactionId}, '${notif.type || 'message'}')">
            <div class="notif-icon-box ${iconInfo.class}">
              <i class="fas ${iconInfo.icon}"></i>
            </div>
            <div class="notif-content">
              <div class="notif-header-row">
                <div class="notif-title">${title}</div>
                <div class="notif-date">${date}</div>
              </div>
              <div class="notif-message">${message}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Bildirime tƒ±klandƒ±ƒüƒ±nda
    function handleNotificationClick(interactionId, type) {
      closeNotifications();
      
      // interaction_id null ise inbox'a y√∂nlendir
      if(!interactionId || interactionId === 'null') {
        loadView('inbox');
        return;
      }
      
      // Mesaj veya etkile≈üim bildirimleri i√ßin chat'i a√ß
      if(type === 'message' || type === 'interaction_accepted' || type === 'date_proposed' || type === 'date_rejected' || type === 'date_accepted' || type === 'scheduled') {
        openChat(interactionId);
      } else {
        loadView('inbox');
      }
    }
    
    window.handleNotificationClick = handleNotificationClick;

    async function fetchListings(type){
      currentListingType = type;
      
      let d = [];
      
      // Eƒüer "all" ise hem offer hem request getir
      if(type === 'all') {
        try {
          const [offers, requests] = await Promise.all([
            req('/service-offers/'),
            req('/service-requests/')
          ]);
          
          const offersList = Array.isArray(offers) ? offers : [];
          const requestsList = Array.isArray(requests) ? requests : [];
          
          // Her iki listeye de type ekle
          offersList.forEach(item => item._type = 'offer');
          requestsList.forEach(item => item._type = 'request');
          
          // Birle≈ütir ve created_at'e g√∂re sƒ±rala (en yeniden en eskiye)
          d = [...offersList, ...requestsList].sort((a, b) => {
            const dateA = new Date(a.created_at || 0);
            const dateB = new Date(b.created_at || 0);
            return dateB - dateA; // B√ºy√ºkten k√º√ß√ºƒüe (en yeni √∂nce)
          });
          
          console.log('ALL view - Offers:', offersList.length, 'Requests:', requestsList.length, 'Total:', d.length);
        } catch(err) {
          console.error('Error fetching all listings:', err);
          d = [];
        }
      } else {
        d = await req(type==='offers'?'/service-offers/':'/service-requests/');
        // Backend'den zaten sƒ±ralƒ± geliyor ama emin olmak i√ßin tekrar sƒ±rala
        if(Array.isArray(d)) {
          d = d.sort((a, b) => {
            const dateA = new Date(a.created_at || 0);
            const dateB = new Date(b.created_at || 0);
            return dateB - dateA; // B√ºy√ºkten k√º√ß√ºƒüe (en yeni √∂nce)
          });
        }
      }
      
      // T√ºm ilanlarƒ± sakla (arama i√ßin) - eƒüer d bir array deƒüilse bo≈ü array kullan
      if(Array.isArray(d)) {
        allListings = d;
      } else {
        allListings = [];
      }
      listingsData = d;
      
      // Arama kutusunu kontrol et
      const searchInput = $('#searchInput');
      const searchTerm = searchInput ? searchInput.value.trim() : '';
      
      // Her zaman render et - arama terimi varsa filtrele, yoksa t√ºm√ºn√º g√∂ster
      if(searchTerm && searchTerm !== '') {
        filterListings(searchTerm);
      } else {
        // T√ºm ilanlarƒ± g√∂ster - allListings'i direkt kullan
        console.log('Rendering listings:', allListings.length, 'Type:', type);
        renderListings(allListings);
      }
      
      // Harita marker'larƒ±nƒ± g√ºncelle
      if(mainMap) loadMapMarkers();
    }
    
    // Arama kutusu event handler
    $('#searchInput').oninput = function() {
      filterListings(this.value);
    };
    
    // Enter tu≈üu ile arama
    $('#searchInput').onkeypress = function(e) {
      if(e.key === 'Enter') {
        e.preventDefault();
        filterListings(this.value);
      }
    };

    function getButtonHtml(item, type){
        if(item.user_info.username === USER.username) return ''; 
        if(type === 'offers'){
            if(USER_BALANCE < item.duration) return `<button class="action-btn disabled" disabled>Insufficient Balance</button>`;
            return `<button class="action-btn" onclick="startChat(${item.id}, 'offer')">Contact / Request</button>`;
        } 
        return `<button class="action-btn" onclick="startChat(${item.id}, 'request')">Offer Help</button>`;
    }

    async function startChat(id, type){
      const result = await Swal.fire({
        title: 'Start conversation?',
        text: 'Send a message to start chatting',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, start!',
        cancelButtonText: 'Cancel'
      });
      
      if(result.isConfirmed){
        const r = await req('/interaction/create/', 'POST', {id, type, message:'Hi!'});
        if(r.success){ 
          Swal.fire({
            icon: 'success',
            title: 'Sent!',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          loadView('inbox'); 
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.error || 'Error',
            confirmButtonColor: '#3085d6'
          });
        }
      }
    }

    async function fetchChats(){
      const d = await req('/interactions/');
      // Grup chat'leri tekille≈ütir (aynƒ± offer_id'ye sahip olanlarƒ± birle≈ütir)
      const seenGroupChats = new Set();
      const processedChats = [];
      
      for(const i of d) {
        if(i.is_group_chat && i.offer_id) {
          const groupKey = `group_${i.offer_id}`;
          if(!seenGroupChats.has(groupKey)) {
            seenGroupChats.add(groupKey);
            processedChats.push(i);
          }
        } else {
          processedChats.push(i);
        }
      }
      
      $('#inboxContent').innerHTML = processedChats.map(i=>{
        const isGroup = i.is_group_chat && i.group_participants > 1;
        const otherUser = i.sender_username===USER.username ? i.receiver_username : i.sender_username;
        const listingId = i.offer_id || i.request_id;
        const listingType = i.type || (i.offer_id ? 'offer' : 'request');
        const viewListingBtn = listingId ? `
          <button onclick="event.stopPropagation(); openListingFromInbox(${listingId}, '${listingType}')" style="padding:6px 12px;border-radius:8px;border:0;background:#667eea;color:#fff;font-size:12px;font-weight:700;cursor:pointer;margin-top:8px">
            üìã View Listing Details
          </button>
        ` : '';
        
        const groupBadge = isGroup ? `<span style="font-size:11px;font-weight:700;padding:2px 6px;border-radius:4px;background:#fef3c7;color:#d97706;margin-left:4px">üë• Group (${i.group_participants})</span>` : '';
        
        return `
        <div class="inbox-item" style="position:relative">
          <div class="inbox-item-content" onclick="openChat(${i.id})" style="flex:1;display:flex;gap:16px;align-items:center;cursor:pointer">
          <div class="inbox-icon">${isGroup ? 'üë•' : (i.sender_username===USER.username?'üì§':'üì•')}</div>
            <div class="inbox-info" style="flex:1">
              <div class="inbox-title">${i.title || 'Untitled'}${groupBadge}</div>
              <div style="display:flex;align-items:center;gap:8px;margin-top:4px;flex-wrap:wrap">
                <span class="status-badge st-${i.status.toLowerCase()}">${i.status.replace('_',' ')}</span>
                ${i.duration ? `<span style="font-size:11px;color:#666">‚è±Ô∏è ${i.duration}h</span>` : ''}
                ${listingType ? `<span style="font-size:11px;color:#666;text-transform:uppercase">${listingType}</span>` : ''}
              </div>
              ${viewListingBtn}
            </div>
            <div style="font-size:13px;color:#666;text-align:right">
              ${isGroup ? `<div>Group Chat</div><div style="font-size:11px;color:#999">${i.group_participants} participants</div>` : `<div>With:</div><a href="/profile/${otherUser}/" style="color:#667eea;text-decoration:none;font-weight:700" onclick="event.stopPropagation()">${otherUser}</a>`}
            </div>
          </div>
          <button class="delete-listing-btn" onclick="event.stopPropagation(); deleteConversation(${i.id})" title="Delete conversation" style="margin-left:8px">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>`;
      }).join('') || '<div style="padding:20px;text-align:center;color:#eee">No conversations.</div>';
    }
    
    async function openListingFromInbox(listingId, listingType) {
      try {
        const endpoint = listingType === 'offer' ? `/service-offers/${listingId}/` : `/service-requests/${listingId}/`;
        const item = await req(endpoint);
        
        // 404 veya bo≈ü response kontrol√º
        if (!item || item.detail) {
          Swal.fire({
            icon: 'warning',
            title: 'Listing Not Found',
            text: 'This listing may have been deleted or is no longer available.',
            confirmButtonColor: '#3085d6'
          });
          // Chats listesini yenile (silinen listing'i kaldƒ±rmak i√ßin)
          if(CURRENT_INBOX_SUB === 'chats') {
            fetchChats();
          }
          return;
        }
        
        // user_info kontrol√º
        if (!item.user_info || !item.user_info.username) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Invalid listing data',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        
        // openDetailSidebar fonksiyonunu √ßaƒüƒ±r
        openDetailSidebar(item, listingType);
      } catch(err) {
        console.error('Error loading listing detail from inbox:', err);
        // 404 hatasƒ± kontrol√º
        if(err.message && (err.message.includes('404') || err.message.includes('Not Found'))) {
          Swal.fire({
            icon: 'warning',
            title: 'Listing Not Found',
            text: 'This listing may have been deleted or is no longer available.',
            confirmButtonColor: '#3085d6'
          });
          // Chats listesini yenile
          if(CURRENT_INBOX_SUB === 'chats') {
            fetchChats();
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Could not load listing details',
            confirmButtonColor: '#3085d6'
          });
        }
      }
    }
    
    // Pending requests'ten ilan detayƒ±nƒ± a√ßma fonksiyonu
    async function openListingFromPending(id, type) {
      try {
        const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
        const item = await req(endpoint);
        
        // 404 veya bo≈ü response kontrol√º
        if (!item || item.detail) {
          Swal.fire({
            icon: 'warning',
            title: 'Listing Not Found',
            text: 'This listing may have been deleted or is no longer available.',
            confirmButtonColor: '#3085d6'
          });
          // Pending requests listesini yenile (silinen listing'i kaldƒ±rmak i√ßin)
          if(CURRENT_INBOX_SUB === 'pending') {
            fetchPendingRequests();
          }
          return;
        }
        
        // user_info kontrol√º
        if (!item.user_info || !item.user_info.username) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Invalid listing data',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        
        // openDetailSidebar fonksiyonunu √ßaƒüƒ±r
        openDetailSidebar(item, type);
      } catch (error) {
        console.error('Error loading listing detail from pending:', error);
        // 404 hatasƒ± kontrol√º
        if(error.message && (error.message.includes('404') || error.message.includes('Not Found'))) {
          Swal.fire({
            icon: 'warning',
            title: 'Listing Not Found',
            text: 'This listing may have been deleted or is no longer available.',
            confirmButtonColor: '#3085d6'
          });
          // Pending requests listesini yenile
          if(CURRENT_INBOX_SUB === 'pending') {
            fetchPendingRequests();
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error loading listing details',
            confirmButtonColor: '#3085d6'
          });
        }
      }
    }
    
    // Pending requests'ten accept fonksiyonu
    async function acceptRequestFromPending(interactionId) {
      try {
        const r = await req(`/interaction/${interactionId}/accept/`, 'POST');
        if(r.status || r.status === 'accepted') {
          Swal.fire({
            icon: 'success',
            title: 'Accepted!',
            text: 'Request has been accepted',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          // Pending requests listesini yenile
          fetchPendingRequests();
          // Chats listesini de yenile (yeni chat a√ßƒ±lmƒ±≈ü olabilir)
          if(CURRENT_INBOX_SUB === 'chats') {
            fetchChats();
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.error || 'Failed to accept request',
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to accept request',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    // Pending requests'ten decline fonksiyonu
    async function declineRequestFromPending(interactionId) {
      try {
        const r = await req(`/interaction/${interactionId}/decline/`, 'POST');
        if(r.status || r.status === 'declined') {
          Swal.fire({
            icon: 'success',
            title: 'Declined',
            text: 'Request has been declined',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          // Pending requests listesini yenile
          fetchPendingRequests();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.error || 'Failed to decline request',
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to decline request',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    async function deleteConversation(interactionId) {
      const result = await Swal.fire({
        title: 'Delete Conversation?',
        text: 'This conversation will be deleted. This action cannot be undone.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      });
      
      if(result.isConfirmed) {
        const r = await req(`/interaction/${interactionId}/delete/`, 'POST');
        if(r.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: 'Conversation has been deleted',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          fetchChats();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.message || 'Failed to delete conversation',
            confirmButtonColor: '#3085d6'
          });
        }
      }
    }
    
    window.deleteConversation = deleteConversation;

    // My listings verilerini sakla
    let myListingsData = [];

    async function fetchPendingRequests(){
        try {
            const d = await req('/pending-requests/');
            if(!Array.isArray(d) || d.length === 0) {
                $('#inboxContent').innerHTML = '<div style="padding:20px;text-align:center;color:#eee">No pending requests.</div>';
                return;
            }
            
            $('#inboxContent').innerHTML = d.map(p => {
                const badgeClass = p.listing_type === 'offer' ? 'offer' : 'request';
                const badgeText = p.listing_type === 'offer' ? 'OFFER' : 'REQUEST';
                return `
                <div class="inbox-item" style="position:relative">
                    <div class="inbox-item-content" style="flex:1;display:flex;gap:16px;align-items:center">
                        <div class="inbox-icon" style="background:#fef3c7;color:#d97706">‚è≥</div>
                        <div class="inbox-info" style="flex:1">
                            ${p.listing_title && p.listing_title !== 'Hi' ? `<div class="inbox-title" style="font-weight:700;color:#1f2937">${p.listing_title}</div>` : ''}
                            <div style="display:flex;align-items:center;gap:8px;margin-top:6px;flex-wrap:wrap">
                                <span class="status-badge st-pending" style="background:#fef3c7;color:#d97706;font-weight:700">PENDING</span>
                                <span style="font-size:12px;color:#666">‚è±Ô∏è ${p.listing_duration}h</span>
                                <span style="font-size:12px;font-weight:700;padding:2px 6px;border-radius:4px;background:${p.listing_type === 'offer' ? '#e0e7ff' : '#d1fae5'};color:${p.listing_type === 'offer' ? '#667eea' : '#059669'}">${badgeText}</span>
                            </div>
                            <div style="margin-top:8px;font-size:13px;color:#4b5563">
                                <span style="font-weight:600">Request from:</span> 
                                <a href="/profile/${p.sender_username}/" style="color:#667eea;text-decoration:none;font-weight:700" onclick="event.stopPropagation()">${p.sender_username}</a>
                            </div>
                            ${p.message && p.message.trim() !== 'Hi' && p.message.trim() !== 'Hi!' ? `<div style="margin-top:8px;padding:8px;background:#f9fafb;border-radius:6px;font-size:12px;color:#6b7280;line-height:1.5">${(p.message || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : ''}
                            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
                                <button onclick="event.stopPropagation(); openListingFromPending(${p.listing_id}, '${p.listing_type}')" style="padding:8px 16px;border-radius:8px;border:0;background:#667eea;color:#fff;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px">
                                    üìã View Listing Details
                                </button>
                                <button onclick="event.stopPropagation(); acceptRequestFromPending(${p.interaction_id})" style="padding:8px 16px;border-radius:8px;border:0;background:#10b981;color:#fff;font-size:12px;font-weight:700;cursor:pointer">
                                    ‚úì Accept
                                </button>
                                <button onclick="event.stopPropagation(); declineRequestFromPending(${p.interaction_id})" style="padding:8px 16px;border-radius:8px;border:0;background:#ef4444;color:#fff;font-size:12px;font-weight:700;cursor:pointer">
                                    ‚úó Decline
                                </button>
                            </div>
                        </div>
                        <div style="font-size:12px;color:#9ca3af;text-align:right">
                            ${formatDate(p.created_at)}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        } catch(err) {
            console.error('Error fetching pending requests:', err);
            $('#inboxContent').innerHTML = '<div style="padding:20px;text-align:center;color:#eee">Error loading pending requests.</div>';
        }
    }

    async function fetchMyListings(){
        const d = await req('/my-listings/');
        myListingsData = d; // Veriyi sakla
        $('#inboxContent').innerHTML = d.map(i=>`
            <div class="inbox-item" style="cursor:pointer;position:relative" onclick="openMyListingDetail(${i.id}, '${i.type}')">
                <div class="inbox-icon" style="background:#f3f4f6">üìù</div>
                <div class="inbox-info" style="flex:1"><div class="inbox-title">${i.title}</div><div style="font-size:13px;color:#666">${i.type.toUpperCase()} ‚Ä¢ ${i.duration}h</div></div>
                <button class="delete-listing-btn" onclick="event.stopPropagation(); deleteListing(${i.id}, '${i.type}')" title="Delete listing">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>`).join('') || '<div style="padding:20px;text-align:center;color:#eee">You have no listings.</div>';
    }
    
    // My Listings'ten detay a√ßma
    function openMyListingDetail(id, type) {
      // √ñnce saklanan veriden bul
      const item = myListingsData.find(i => i.id === id && i.type === type);
      
      if(item) {
        // Veriyi openDetailSidebar formatƒ±na √ßevir
        const detailItem = {
          id: item.id,
          title: item.title,
          description: item.description || '',
          category: item.category || '',
          duration: item.duration,
          latitude: item.latitude,
          longitude: item.longitude,
          address: item.address || '',
          image_url: item.image_url || null,
          created_at: item.created_at,
          user_info: {
            id: item.user_info?.id || USER.id,
            username: item.user_info?.username || USER.username
          }
        };
        openDetailSidebar(detailItem, type);
      } else {
        // Eƒüer saklanan veride yoksa API'den √ßek (fallback)
        (async () => {
          try {
            const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
            const apiItem = await req(endpoint);
            if(apiItem && apiItem.id) {
              openDetailSidebar(apiItem, type);
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Could not load listing details',
                confirmButtonColor: '#3085d6'
              });
            }
          } catch(err) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: err.message || 'Unknown error occurred',
              confirmButtonColor: '#3085d6'
            });
          }
        })();
      }
    }
    
    window.openMyListingDetail = openMyListingDetail;
    
    // ƒ∞lan silme fonksiyonu
    async function deleteListing(id, type) {
        const result = await Swal.fire({
          title: 'Are you sure?',
          text: "You won't be able to revert this!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'Cancel'
        });
        
        if(!result.isConfirmed) {
            return;
        }
        
        try {
            const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
            const deleteResult = await req(endpoint, 'DELETE');
            
            // DELETE ba≈üarƒ±lƒ± olabilir (204 No Content veya success response)
            // Hata kontrol√º
            if(deleteResult && deleteResult.error) {
                await Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: deleteResult.error,
                  confirmButtonColor: '#3085d6'
                });
                return;
            }
            
            // Ba≈üarƒ±lƒ± mesajƒ± g√∂ster
            Swal.fire({
              icon: 'success',
              title: 'Deleted!',
              text: 'Listing deleted successfully!',
              timer: 2000,
              showConfirmButton: false,
              position: 'top-end',
              toast: true
            });
            
            // myListingsData'dan silinen ilanƒ± kaldƒ±r
            myListingsData = myListingsData.filter(item => !(item.id === id && item.type === type));
            
            // Listeyi yenile
            await fetchMyListings();
            
            // Eƒüer detail sidebar a√ßƒ±ksa ve silinen ilan g√∂steriliyorsa kapat
            if(currentDetailItem && currentDetailItem.item.id === id && currentDetailItem.type === type) {
                closeDetailSidebar();
            }
            
            // Ana sayfadaki listeyi de yenile
            if(currentListingType) {
                await fetchListings(currentListingType);
            }
            // Haritayƒ± da yenile
            if(window.mainMap) {
                updateMapMarkers();
            }
        } catch(err) {
            await Swal.fire({
              icon: 'error',
              title: 'Error',
              text: err.message || 'Unknown error occurred',
              confirmButtonColor: '#3085d6'
            });
        }
    }
    
    window.deleteListing = deleteListing;

    async function openChat(id){ 
        ACTIVE_CHAT_ID=id; LAST_RENDER_KEY=""; 
        $('#chatSheet').classList.add('open'); 
        if(POLLER) clearInterval(POLLER);
        loadChatMessages();
        POLLER = setInterval(loadChatMessages, 3000);
    }

    window.closeSheet = id => { 
      $('#'+id).classList.remove('open'); 
      if(id==='chatSheet'){ 
        ACTIVE_CHAT_ID=null; 
        clearInterval(POLLER); 
        checkNotifications(); 
      } else if(id==='listingSheet') {
        // Harita ve marker'ƒ± temizle
        if(locationMap) {
          locationMap.remove();
          locationMap = null;
          locationMarker = null;
        }
        // Form alanlarƒ±nƒ± temizle
        $('#inpLat').value = '';
        $('#inpLng').value = '';
        $('#inpAddress').value = '';
        $('#locationSearch').value = '';
        $('#locationMap').innerHTML = '';
      }
    };

    async function loadChatMessages(){
      if(!ACTIVE_CHAT_ID) return;
      const all = await req('/interactions/');
      const chat = all.find(x => x.id === ACTIVE_CHAT_ID);
      if(!chat) return;
      
      const isGroupChat = chat.is_group_chat && chat.group_participants > 1;
      const key = chat.status + (chat.appointment_date||'') + chat.is_completed_by_provider + chat.date_proposed_by_username + (isGroupChat ? '_group' : '');
      if(key!==LAST_RENDER_KEY) { updateBar(chat); LAST_RENDER_KEY=key; }
      
      // Chat ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle - grup chat ise provider ve t√ºm √ºyeleri g√∂ster
      const chatHeader = document.querySelector('#chatSheet .sheet-head h3');
      if(chatHeader && isGroupChat) {
        // Grup chat: T√ºm √ºyeleri bul ve g√∂ster
        const offerId = chat.offer_id || (chat.type === 'offer' ? chat.id : null);
        if(offerId) {
          const allGroupChats = all.filter(c => {
            const cOfferId = c.offer_id || (c.type === 'offer' ? c.id : null);
            return c.is_group_chat && cOfferId === offerId;
          });
          
          const participants = new Set();
          
          // Provider'ƒ± bul (offer'ƒ±n sahibi) - chat objesinden veya fetch ederek
          if(chat.receiver_username && chat.type === 'offer') {
            // Receiver provider olabilir
            participants.add(chat.receiver_username);
          }
          
          // T√ºm kabul edilen √ºyeleri ekle
          allGroupChats.forEach(c => {
            if(c.sender_username) participants.add(c.sender_username);
            if(c.receiver_username) participants.add(c.receiver_username);
          });
          
          // Provider'ƒ± bulmak i√ßin offer'ƒ± fetch et
          try {
            const offer = await req(`/service-offers/${offerId}/`);
            if(offer && offer.user_info && offer.user_info.username) {
              participants.add(offer.user_info.username);
            }
          } catch(e) {
            // Offer fetch edilemezse devam et
          }
          
          const participantsList = Array.from(participants).join(', ');
          chatHeader.textContent = `üë• Group Chat (${participants.size}): ${participantsList}`;
        } else {
          chatHeader.textContent = 'üë• Group Chat';
        }
      } else if(chatHeader && !isGroupChat) {
        // Normal 1-1 chat
        const otherUser = chat.sender_username === USER.username ? chat.receiver_username : chat.sender_username;
        chatHeader.textContent = `Chat with ${otherUser}`;
      }
      
      const msgs = await req(`/interaction/${ACTIVE_CHAT_ID}/messages/`);
      const area = $('#msgArea');
      
      // Completion card'larƒ± tekille≈ütir (aynƒ± offer_id'ye sahip olanlarƒ± birle≈ütir)
      const seenCompletionCards = new Set();
      const processedMsgs = [];
      
      for(const m of msgs) {
        let content = m.content || '';
        try {
          if(content.trim().startsWith('{') && content.trim().endsWith('}')) {
            const cardData = JSON.parse(content);
            if(cardData.type === 'completion_card' && cardData.offer_id) {
              const cardKey = `completion_${cardData.offer_id}`;
              if(!seenCompletionCards.has(cardKey)) {
                seenCompletionCards.add(cardKey);
                processedMsgs.push(m);
              }
              // Duplicate completion card'ƒ± atla
              continue;
            }
          }
        } catch(e) {
          // JSON parse hatasƒ±, normal mesaj olarak devam et
        }
        processedMsgs.push(m);
      }
      
      // Mesajlarƒ± render et - kompakt ve modern
      area.innerHTML = processedMsgs.map(m => {
        // Completion card kontrol√º
        let content = m.content || '';
        try {
          if(content.trim().startsWith('{') && content.trim().endsWith('}')) {
            const cardData = JSON.parse(content);
            if(cardData.type === 'completion_card' && cardData.offer_id) {
              // Completion card render et
              const participants = cardData.participants || [];
              const confirmed = cardData.confirmed || [];
              const isProvider = chat.receiver_username === USER.username;
              const userConfirmed = confirmed.includes(USER.username);
              
              return `<div style="background:#f0f9ff;border:2px solid #3b82f6;border-radius:12px;padding:16px;margin:12px 0;max-width:85%">
                <div style="font-weight:700;color:#1e40af;margin-bottom:12px;font-size:14px">‚úÖ Service Completed</div>
                <div style="font-size:13px;color:#1f2937;margin-bottom:12px">All participants need to confirm payment:</div>
                <div style="margin-bottom:12px">
                  ${participants.map(p => {
                    const confirmedStatus = confirmed.includes(p);
                    return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px">
                      <span style="font-weight:600;color:#4b5563">${p}</span>
                      ${confirmedStatus ? '<span style="color:#10b981;font-weight:700">‚úì Paid</span>' : '<span style="color:#ef4444;font-weight:700">‚è≥ Pending</span>'}
                    </div>`;
                  }).join('')}
                </div>
                ${!isProvider && !userConfirmed ? `
                  <button onclick="confirmGroupCompletion(${cardData.offer_id})" style="width:100%;padding:10px;border-radius:8px;border:0;background:#10b981;color:#fff;font-weight:700;cursor:pointer;font-size:13px">
                    üí≥ Pay (${chat.duration || 0}h)
                  </button>
                ` : isProvider ? `
                  <div style="text-align:center;color:#6b7280;font-size:12px;font-style:italic">Waiting for all participants to pay...</div>
                ` : `
                  <div style="text-align:center;color:#10b981;font-size:12px;font-weight:700">‚úì You have paid</div>
                `}
              </div>`;
            }
          }
        } catch(e) {
          // JSON parse hatasƒ±, normal mesaj olarak devam et
        }
        
        const isMe = m.sender_username === USER.username;
        const time = new Date(m.timestamp || Date.now()).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
        content = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // Grup chat'te g√∂nderen adƒ±nƒ± her zaman g√∂ster (kendimiz deƒüilse)
        const showSender = isGroupChat && !isMe && m.sender_username;
        
        return `<div class="chat-bubble ${isMe ? 'me' : 'them'}" style="${isGroupChat ? 'max-width:75%' : ''}">
          ${showSender ? `<div class="chat-bubble-sender">${m.sender_username}</div>` : ''}
          <div style="white-space:pre-wrap">${content}</div>
          <div class="chat-bubble-time">${time}</div>
        </div>`;
      }).join('');
      
      area.scrollTop = area.scrollHeight;
    }

    $('#msgForm').onsubmit = async e => {
      e.preventDefault(); const inp = $('#msgInput'); const val = inp.value.trim(); if(!val) return;
      await req(`/interaction/${ACTIVE_CHAT_ID}/messages/`, 'POST', {content: val});
      inp.value = ''; loadChatMessages();
    };

    function updateBar(d){
      const imSender = d.sender_username === USER.username; 
      const bar = $('#actionBar');
      let html = ''; let title = '';

      if(d.status==='pending'){
        title = "New Request";
        if(d.receiver_username === USER.username) html = `<span>Please check the listing details to accept or decline.</span>`;
        else { title="Request Sent"; html = `Waiting for provider response...`; }
      }
      else if(d.status==='accepted'){
        title = "Request Accepted";
        const isProvider = (d.type === 'offer' && d.receiver_username === USER.username) || (d.type === 'request' && d.sender_username === USER.username);
        const isGroupChat = d.is_group_chat && d.group_participants > 1;
        const isConsumer = !isProvider;
        
        // Provider i√ßin mark complete butonu
        if(isProvider && !d.is_completed_by_provider) {
          if(d.type === 'offer' && (d.offer_capacity && d.offer_capacity > 1 || isGroupChat)) {
            // Grup offer - sadece t√ºm spotlar dolduƒüunda mark complete g√∂ster
            const groupParticipants = d.group_participants || 0;
            const offerCapacity = d.offer_capacity || 1;
            if(groupParticipants >= offerCapacity) {
              html = `<span>Mark as complete when service is done:</span> <button class="ab-btn green" onclick="act('complete')">Mark Complete</button>`;
            } else {
              html = `<span>Waiting for more participants (${groupParticipants}/${offerCapacity} spots filled).</span>`;
            }
          } else {
            // 1-1 offer veya request
            html = `<span>Mark as complete when service is done:</span> <button class="ab-btn green" onclick="act('complete')">Mark Complete</button>`;
          }
        } 
        // Consumer i√ßin pay butonu (complete edildiyse)
        else if(isConsumer && d.is_completed_by_provider && !d.is_confirmed_by_receiver) {
          if(d.type === 'offer' && (d.offer_capacity && d.offer_capacity > 1 || isGroupChat)) {
            // Grup offer - completion card'da pay butonu var, burada sadece mesaj
            html = `<span>Service completed. Please confirm payment in the chat.</span>`;
          } else {
            // 1-1 offer veya request - direkt pay butonu
            html = `<span>Service completed. Please confirm payment:</span> <button class="ab-btn green" onclick="act('confirm')">Pay (${d.duration || 0}h)</button>`;
          }
        }
        // Provider i√ßin waiting mesajƒ±
        else if(isProvider && d.is_completed_by_provider) {
          if(d.type === 'offer' && (d.offer_capacity && d.offer_capacity > 1 || isGroupChat)) {
            html = `<span>Service completed. Waiting for all participants to confirm payment.</span>`;
          } else {
            html = `<span>Service completed. Waiting for payment confirmation.</span>`;
          }
        }
        // Consumer i√ßin completed mesajƒ±
        else if(isConsumer && d.is_completed_by_provider && d.is_confirmed_by_receiver) {
          html = `<span>‚úì Payment confirmed. Transaction completed.</span>`;
        }
        // Hi√ßbir durum uymuyorsa bo≈ü
        else {
          html = ``;
        }
      }
      else if(d.status==='date_proposed'){
        // Schedule a date kaldƒ±rƒ±ldƒ±, accepted durumuna y√∂nlendir
        title = "Request Accepted";
        const isProvider = (d.type === 'offer' && d.receiver_username === USER.username) || (d.type === 'request' && d.sender_username === USER.username);
        const isGroupChat = d.is_group_chat && d.group_participants > 1;
        const isConsumer = !isProvider;
        
        // Provider i√ßin mark complete butonu
        if(isProvider && !d.is_completed_by_provider) {
          html = `<span>Mark as complete when service is done:</span> <button class="ab-btn green" onclick="act('complete')">Mark Complete</button>`;
        } 
        // Consumer i√ßin pay butonu (complete edildiyse)
        else if(isConsumer && d.is_completed_by_provider && !d.is_confirmed_by_receiver) {
          if(d.type === 'offer' && (d.offer_capacity && d.offer_capacity > 1 || isGroupChat)) {
            html = `<span>Service completed. Please confirm payment in the chat.</span>`;
          } else {
            html = `<span>Service completed. Please confirm payment:</span> <button class="ab-btn green" onclick="act('confirm')">Pay (${d.duration || 0}h)</button>`;
          }
        }
        // Provider i√ßin waiting mesajƒ±
        else if(isProvider && d.is_completed_by_provider) {
          if(d.type === 'offer' && (d.offer_capacity && d.offer_capacity > 1 || isGroupChat)) {
            html = `<span>Service completed. Waiting for all participants to confirm payment.</span>`;
          } else {
            html = `<span>Service completed. Waiting for payment confirmation.</span>`;
          }
        }
        // Consumer i√ßin completed mesajƒ±
        else if(isConsumer && d.is_completed_by_provider && d.is_confirmed_by_receiver) {
          html = `<span>‚úì Payment confirmed. Transaction completed.</span>`;
        }
        // Hi√ßbir durum uymuyorsa bo≈ü
        else {
          html = ``;
        }
      }
      else if(d.status==='scheduled' || d.status==='date_proposed'){
        // Schedule a date kaldƒ±rƒ±ldƒ±, accepted durumuna y√∂nlendir
        title = "Request Accepted";
        const isProvider = (d.type === 'offer' && d.receiver_username === USER.username) || (d.type === 'request' && d.sender_username === USER.username);
        const isGroupChat = d.is_group_chat && d.group_participants > 1;
        const isConsumer = !isProvider;
        
        // Provider i√ßin mark complete butonu
        if(isProvider && !d.is_completed_by_provider) {
          html = `<span>Mark as complete when service is done:</span> <button class="ab-btn green" onclick="act('complete')">Mark Complete</button>`;
        } 
        // Consumer i√ßin pay butonu (complete edildiyse)
        else if(isConsumer && d.is_completed_by_provider && !d.is_confirmed_by_receiver) {
          if(d.type === 'offer' && (d.offer_capacity && d.offer_capacity > 1 || isGroupChat)) {
            html = `<span>Service completed. Please confirm payment in the chat.</span>`;
          } else {
            html = `<span>Service completed. Please confirm payment:</span> <button class="ab-btn green" onclick="act('confirm')">Pay (${d.duration || 0}h)</button>`;
          }
        }
        // Provider i√ßin waiting mesajƒ±
        else if(isProvider && d.is_completed_by_provider) {
          if(d.type === 'offer' && (d.offer_capacity && d.offer_capacity > 1 || isGroupChat)) {
            html = `<span>Service completed. Waiting for all participants to confirm payment.</span>`;
          } else {
            html = `<span>Service completed. Waiting for payment confirmation.</span>`;
          }
        }
        // Consumer i√ßin completed mesajƒ±
        else if(isConsumer && d.is_completed_by_provider && d.is_confirmed_by_receiver) {
          html = `<span>‚úì Payment confirmed. Transaction completed.</span>`;
        }
        // Hi√ßbir durum uymuyorsa bo≈ü
        else {
          html = ``;
        }
      }
      else if(d.status==='completed'){ 
        title = "Completed"; 
        html = `Transaction successful.`;
        
        // Her iki taraf da birbirine review verebilir
        // Kar≈üƒ± tarafƒ± belirle
        const otherUser = d.sender_username === USER.username ? d.receiver_username : d.sender_username;
        const listingType = d.type || 'offer';
        const listingId = d.offer_id || d.request_id || null;
        
        // Review kontrol√º yap (asenkron) - her iki taraf da review verebilir
        if(listingId && otherUser) {
          checkReviewAndShowButton(otherUser, listingType, listingId, d.id).then(reviewExists => {
            let finalHtml = html;
            if(!reviewExists) {
              finalHtml += `<div style="margin-top:12px"><button class="ab-btn blue" onclick="openReviewModal('${otherUser}', '${listingType}', ${listingId}, ${d.id})">‚≠ê Leave a Review</button></div>`;
            } else {
              finalHtml += `<div style="margin-top:12px;color:#10b981;font-size:14px">‚úì You reviewed this user</div>`;
            }
            bar.innerHTML = `<div class="ab-header"><span class="ab-title">${title}</span> <span class="status-badge st-${d.status}">${d.status.replace('_',' ')}</span></div>` + (finalHtml ? `<div class="ab-content ${d.status==='completed'?'success':''}">${finalHtml}</div>` : '');
            bar.style.display = 'flex';
          });
        } else {
          // listingId yoksa direkt g√∂ster
          bar.innerHTML = `<div class="ab-header"><span class="ab-title">${title}</span> <span class="status-badge st-${d.status}">${d.status.replace('_',' ')}</span></div>` + (html ? `<div class="ab-content ${d.status==='completed'?'success':''}">${html}</div>` : '');
          bar.style.display = 'flex';
        }
        return; // Asenkron i≈ülem yapƒ±ldƒ±ƒüƒ± i√ßin buradan √ßƒ±k
      }

      bar.innerHTML = `<div class="ab-header"><span class="ab-title">${title}</span> <span class="status-badge st-${d.status}">${d.status.replace('_',' ')}</span></div>` + (html ? `<div class="ab-content ${d.status==='completed'?'success':''}">${html}</div>` : '');
      bar.style.display = 'flex';
    }

    async function act(a){
      let p={}; 
      if(a==='schedule'){ 
        const v=$('#dp').value; 
        if(!v){
          await Swal.fire({
            icon: 'warning',
            title: 'Date Required',
            text: 'Please select a date',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        p={date:v}; 
      }
      const r = await req(`/interaction/${ACTIVE_CHAT_ID}/${a}/`, 'POST', p);
      if(r.status || r.status === 'negotiating'){ 
        Swal.fire({
          icon: 'success',
          title: a === 'reject_date' ? 'Date Rejected' : 'Updated!',
          text: a === 'reject_date' ? 'Please propose a new date' : 'Action completed',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        LAST_RENDER_KEY=""; 
        loadChatMessages(); 
        fetchProfile(); 
      } else {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: r.error || 'An error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    // Grup chat completion confirmation
    async function confirmGroupCompletion(offerId) {
      try {
        // Kullanƒ±cƒ±nƒ±n bu offer'a sahip interaction'ƒ±nƒ± bul
        const all = await req('/interactions/');
        const userInteraction = all.find(i => 
          i.offer_id === offerId && 
          (i.sender_username === USER.username || i.receiver_username === USER.username) &&
          i.status === 'accepted'
        );
        
        if(!userInteraction) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Interaction not found',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        
        // Confirm action'ƒ±nƒ± √ßaƒüƒ±r
        const r = await req(`/interaction/${userInteraction.id}/confirm/`, 'POST');
        
        if(r.status === 'completed') {
          Swal.fire({
            icon: 'success',
            title: 'Payment Confirmed!',
            text: 'All participants confirmed. Transaction completed!',
            timer: 3000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
        } else if(r.status === 'waiting_others') {
          Swal.fire({
            icon: 'info',
            title: 'Payment Confirmed',
            text: r.message || 'Waiting for other participants to confirm.',
            timer: 3000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.error || 'Failed to confirm payment',
            confirmButtonColor: '#3085d6'
          });
        }
        
        LAST_RENDER_KEY = "";
        loadChatMessages();
        fetchProfile();
      } catch(err) {
        console.error('Error confirming group completion:', err);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Failed to confirm payment',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    window.confirmGroupCompletion = confirmGroupCompletion;

    // Harita deƒüi≈ükenleri
    let locationMap = null;
    let locationMarker = null;
    let geocoder = null;
    let mainMap = null;
    let mainMapMarkers = [];
    let currentDetailItem = null;
    
    // Resim y√ºkleme deƒüi≈ükenleri
    let selectedImageFile = null;
    
    // Tag deƒüi≈ükenleri
    let selectedTags = [];
    let tagSearchTimeout = null;

    $('#btnOffer').onclick = () => openSheet('offer');
    $('#btnRequest').onclick = () => openSheet('request');
    
    function openSheet(type){ 
      $('#listingSheet').classList.add('open'); 
      $('#listingType').value = type;
      // Capacity field'ƒ±nƒ± sadece offer i√ßin g√∂ster
      if(type === 'offer') {
        $('#capacityField').style.display = 'block';
      } else {
        $('#capacityField').style.display = 'none';
      }
      // Category'yi sƒ±fƒ±rla ve custom category field'ƒ±nƒ± gizle
      $('#inpCat').value = '';
      $('#customCategoryField').style.display = 'none';
      $('#inpCustomCat').value = '';
      $('#inpCustomCat').required = false;
      // Category change event listener'ƒ± ekle
      $('#inpCat').onchange = function() {
        if(this.value === 'Other') {
          $('#customCategoryField').style.display = 'block';
          $('#inpCustomCat').required = true;
        } else {
          $('#customCategoryField').style.display = 'none';
          $('#inpCustomCat').required = false;
          $('#inpCustomCat').value = '';
        }
      };
      // Tags'ƒ± sƒ±fƒ±rla
      selectedTags = [];
      $('#selectedTags').innerHTML = '';
      $('#tagSearchInput').value = '';
      $('#tagSuggestions').style.display = 'none';
      // Resim y√ºkleme alanƒ±nƒ± sƒ±fƒ±rla
      removeImage();
      // is_online checkbox'ƒ±nƒ± sƒ±fƒ±rla
      $('#inpIsOnline').checked = false;
      toggleLocationField();
      // Haritayƒ± ba≈ülat - sidebar a√ßƒ±ldƒ±ktan sonra biraz bekle
      setTimeout(() => {
        if(!$('#inpIsOnline').checked) {
          initLocationMap();
          // Harita ba≈ülatƒ±ldƒ±ktan sonra invalidateSize √ßaƒüƒ±r (g√∂r√ºn√ºrl√ºk deƒüi≈ütiƒüi i√ßin)
          if(locationMap) {
            setTimeout(() => locationMap.invalidateSize(), 200);
          }
        }
      }, 150);
    }

    // Resim y√ºkleme fonksiyonlarƒ±
    function handleImageFile(file) {
      if(!file || !file.type.startsWith('image/')) {
        Swal.fire({
          icon: 'warning',
          title: 'Invalid File',
          text: 'Please select an image file',
          confirmButtonColor: '#3085d6',
          timer: 3000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true
        });
        return;
      }
      
      selectedImageFile = file;
      const reader = new FileReader();
      reader.onload = function(e) {
        $('#imagePreview').src = e.target.result;
        $('#imagePreview').classList.add('show');
        $('#imagePlaceholder').style.display = 'none';
        $('#imageRemoveBtn').style.display = 'flex';
        $('#imageUploadArea').classList.add('has-image');
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      selectedImageFile = null;
      $('#imagePreview').src = '';
      $('#imagePreview').classList.remove('show');
      $('#imagePlaceholder').style.display = 'block';
      $('#imageRemoveBtn').style.display = 'none';
      $('#imageUploadArea').classList.remove('has-image');
      $('#imageFileInput').value = '';
    }

    window.removeImage = removeImage;

    // Copy/Paste event handler
    document.addEventListener('paste', function(e) {
      const activeElement = document.activeElement;
      if(activeElement && (activeElement.id === 'imageUploadArea' || activeElement.closest('#listingSheet'))) {
        e.preventDefault();
        const items = e.clipboardData.items;
        for(let i = 0; i < items.length; i++) {
          if(items[i].type.indexOf('image') !== -1) {
            const file = items[i].getAsFile();
            handleImageFile(file);
            break;
          }
        }
      }
    });

    // Image upload area click handler
    $('#imageUploadArea').onclick = function(e) {
      if(e.target !== $('#imageRemoveBtn')) {
        $('#imageFileInput').click();
      }
    };

    // File input change handler
    $('#imageFileInput').onchange = function(e) {
      if(e.target.files && e.target.files[0]) {
        handleImageFile(e.target.files[0]);
      }
    };

    // is_online checkbox handler - haritayƒ± gizle/g√∂ster
    function toggleLocationField() {
      const isOnline = $('#inpIsOnline').checked;
      const locationField = $('#locationField');
      const locationMapEl = $('#locationMap');
      
      if(isOnline) {
        locationField.style.display = 'none';
        // Haritayƒ± temizle
        if(locationMapEl) {
          locationMapEl.innerHTML = '';
        }
        if(locationMap) {
          try {
            locationMap.remove();
          } catch(e) {
            console.warn('Error removing map:', e);
          }
          locationMap = null;
          locationMarker = null;
        }
      } else {
        locationField.style.display = 'block';
        // Haritayƒ± yeniden ba≈ülat
        setTimeout(() => {
          if(!locationMap) {
            initLocationMap();
          }
        }, 100);
      }
    }
    
    $('#inpIsOnline').onchange = toggleLocationField;

    function initLocationMap(){
      const mapEl = $('#locationMap');
      if(!mapEl) {
        console.error('Location map container not found');
        return;
      }
      
      // Eƒüer harita zaten ba≈ülatƒ±lmƒ±≈üsa, √∂nce temizle
      if(locationMap) {
        try {
          locationMap.remove();
        } catch(e) {
          console.warn('Error removing old map:', e);
        }
        locationMap = null;
        locationMarker = null;
      }
      
      // Container'ƒ±n innerHTML'ini temizle (eƒüer √∂nceki harita kalƒ±ntƒ±larƒ± varsa)
      if(mapEl.innerHTML.trim()) {
        mapEl.innerHTML = '';
      }
      
      try {
        // Haritayƒ± ba≈ülat (T√ºrkiye merkezli)
        locationMap = L.map('locationMap').setView([39.9334, 32.8597], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(locationMap);

        // Marker olu≈ütur
        locationMarker = L.marker([39.9334, 32.8597], {draggable: true}).addTo(locationMap);
        
        // Marker s√ºr√ºklendiƒüinde
        locationMarker.on('dragend', function(e) {
          const pos = e.target.getLatLng();
          updateLocationFields(pos.lat, pos.lng);
          reverseGeocode(pos.lat, pos.lng);
        });

        // Haritaya tƒ±klandƒ±ƒüƒ±nda
        locationMap.on('click', function(e) {
          locationMarker.setLatLng(e.latlng);
          updateLocationFields(e.latlng.lat, e.latlng.lng);
          reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        // Adres arama (iyile≈ütirilmi≈ü geocoding - Nominatim kullanarak)
        let searchTimeout = null;
        $('#locationSearch').oninput = async function() {
          const query = this.value.trim();
          const resultsDiv = $('#searchResults');
          
          // √ñnceki timeout'u iptal et
          if(searchTimeout) clearTimeout(searchTimeout);
          
          if(!query || query.length < 2) {
            resultsDiv.style.display = 'none';
            return;
          }
          
          // Debounce - 300ms bekle
          searchTimeout = setTimeout(async () => {
            try {
              // ƒ∞stanbul b√∂lgesine √∂ncelik ver (t√ºm d√ºnyadan sonu√ßlar)
              const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&viewbox=28.5,41.0,29.2,41.2&bounded=0&addressdetails=1`;
              const response = await fetch(url, {
                headers: {
                  'User-Agent': 'TimeBank App'
                }
              });
              const data = await response.json();
              
              if(data.length > 0) {
                // Sonu√ßlarƒ± g√∂ster
                resultsDiv.innerHTML = data.map((item, idx) => `
                  <div class="search-result-item" onclick="selectSearchResult(${parseFloat(item.lat)}, ${parseFloat(item.lon)}, '${item.display_name.replace(/'/g, "\\'")}')">
                    <div class="search-result-title">${item.display_name.split(',')[0]}</div>
                    <div class="search-result-details">${item.display_name}</div>
                  </div>
                `).join('');
                resultsDiv.style.display = 'block';
              } else {
                resultsDiv.innerHTML = '<div class="search-result-item" style="cursor:default;color:#999">No results found</div>';
                resultsDiv.style.display = 'block';
              }
            } catch(err) {
              console.error('Search error:', err);
              resultsDiv.style.display = 'none';
            }
          }, 300);
        };
        
        // Enter tu≈üu ile ilk sonucu se√ß
        $('#locationSearch').onkeypress = async function(e) {
          if(e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim();
            if(!query) return;
            
            const resultsDiv = $('#searchResults');
            const firstResult = resultsDiv.querySelector('.search-result-item');
            if(firstResult && !firstResult.textContent.includes('No results')) {
              firstResult.click();
            } else {
              // Eƒüer sonu√ß yoksa, direkt arama yap
              try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&viewbox=28.5,41.0,29.2,41.2&bounded=0`;
                const response = await fetch(url, {
                  headers: {
                    'User-Agent': 'TimeBank App'
                  }
                });
                const data = await response.json();
                if(data.length > 0) {
                  selectSearchResult(parseFloat(data[0].lat), parseFloat(data[0].lon), data[0].display_name);
                } else {
                  Swal.fire({
                    icon: 'warning',
                    title: 'Location Not Found',
                    text: 'Please try a different search term',
                    confirmButtonColor: '#3085d6',
                    timer: 3000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                  });
                }
              } catch(err) {
                Swal.fire({
                  icon: 'error',
                  title: 'Search Error',
                  text: 'An error occurred while searching',
                  confirmButtonColor: '#3085d6',
                  timer: 3000,
                  showConfirmButton: false,
                  position: 'top-end',
                  toast: true
                });
              }
            }
          }
        };
        
        // Sonu√ß se√ßme fonksiyonu
        window.selectSearchResult = function(lat, lng, address) {
          locationMap.setView([lat, lng], 13);
          locationMarker.setLatLng([lat, lng]);
          updateLocationFields(lat, lng);
          $('#inpAddress').value = address;
          $('#locationSearch').value = address.split(',')[0]; // Sadece ilk kƒ±smƒ± g√∂ster
          $('#searchResults').style.display = 'none';
        };
        
        // Dƒ±≈üarƒ± tƒ±klandƒ±ƒüƒ±nda sonu√ßlarƒ± gizle
        document.addEventListener('click', function(e) {
          if(!e.target.closest('.search-container-relative')) {
            $('#searchResults').style.display = 'none';
          }
        });
      } catch(err) {
        console.error('Error initializing location map:', err);
        Swal.fire({
          icon: 'error',
          title: 'Map Error',
          text: 'Failed to load map. Please refresh the page.',
          confirmButtonColor: '#3085d6'
        });
      }
    }

    function updateLocationFields(lat, lng) {
      $('#inpLat').value = lat;
      $('#inpLng').value = lng;
    }

    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        if(data.display_name) {
          $('#inpAddress').value = data.display_name;
        }
      } catch(err) {
        console.error('Geocoding error:', err);
      }
    }

    $('#listingForm').onsubmit = async e => {
      e.preventDefault();
      const t=$('#listingType').value;
      
      // Latitude ve longitude'u parse et - ge√ßersizse null g√∂nder
      // DecimalField i√ßin string olarak g√∂nder (max_digits=9, decimal_places=6)
      // Bu y√ºzden 6 ondalƒ±k basamaƒüa yuvarlamalƒ±yƒ±z
      const latVal = $('#inpLat').value.trim();
      const lngVal = $('#inpLng').value.trim();
      
      function roundTo6Decimals(val) {
        if(!val || isNaN(parseFloat(val))) return null;
        return parseFloat(val).toFixed(6);
      }
      
      const latitude = roundTo6Decimals(latVal);
      const longitude = roundTo6Decimals(lngVal);
      
      // FormData kullan (resim varsa)
      const formData = new FormData();
      formData.append('title', $('#inpTitle').value);
      // Category: "Other" se√ßilmi≈üse custom category'yi kullan
      const selectedCategory = $('#inpCat').value;
      if(!selectedCategory || selectedCategory === '') {
        Swal.fire({
          icon: 'error',
          title: 'Category Required',
          text: 'Please select a category',
          confirmButtonColor: '#3085d6'
        });
        return;
      }
      const categoryValue = selectedCategory === 'Other' ? $('#inpCustomCat').value.trim() : selectedCategory;
      if(!categoryValue || (selectedCategory === 'Other' && !$('#inpCustomCat').value.trim())) {
        Swal.fire({
          icon: 'error',
          title: 'Category Required',
          text: selectedCategory === 'Other' ? 'Please enter a custom category' : 'Please select a category',
          confirmButtonColor: '#3085d6'
        });
        return;
      }
      formData.append('category', categoryValue);
      formData.append('duration', parseInt($('#inpDur').value));
      formData.append('description', $('#inpDesc').value);
      
      // Capacity sadece offer i√ßin ekle
      if(t === 'offer') {
        const capacity = parseInt($('#inpCapacity').value) || 1;
        formData.append('capacity', capacity);
      }
      
      // is_online kontrol√º
      const isOnline = $('#inpIsOnline').checked;
      formData.append('is_online', isOnline ? 'true' : 'false');
      
      // Sadece offline ise konum bilgilerini ekle
      if(!isOnline) {
        if(latitude !== null) formData.append('latitude', latitude);
        if(longitude !== null) formData.append('longitude', longitude);
        const addr = $('#inpAddress').value.trim();
        if(addr) formData.append('address', addr);
      }
      
      // Resim varsa ekle
      if(selectedImageFile) {
        formData.append('image', selectedImageFile);
      }
      
      // Tags ekle (JSON string olarak)
      if(selectedTags.length > 0) {
        formData.append('tags', JSON.stringify(selectedTags));
      }
      
      console.log('Sending data with FormData');
      
      try {
        const r = await req(t==='offer'?'/service-offers/':'/service-requests/','POST',formData, true);
        console.log('Response:', r);
        
        if(r && r.id){ 
          Swal.fire({
            icon: 'success',
            title: 'Listing Created!',
            timer: 3000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          closeSheet('listingSheet'); 
          e.target.reset(); 
          removeImage();
          locationMap = null; 
          locationMarker = null; 
          $('#locationMap').innerHTML = ''; 
          loadView(t+'s'); 
        } else {
          // Django REST Framework hata formatƒ±nƒ± parse et
          let errorMsg = 'Error creating listing';
          if(r) {
            if(r.detail) errorMsg = r.detail;
            else if(r.error) errorMsg = r.error;
            else if(r.non_field_errors) errorMsg = r.non_field_errors.join(', ');
            else if(typeof r === 'object') {
              const fieldErrors = Object.keys(r).map(key => `${key}: ${Array.isArray(r[key]) ? r[key].join(', ') : r[key]}`).join('; ');
              if(fieldErrors) errorMsg = fieldErrors;
            }
          }
          console.error('Error response:', r);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: errorMsg,
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        console.error('Request error:', err);
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: err.message || 'Network error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    };

    async function blockUser(username) {
      const result = await Swal.fire({
        title: 'Block User?',
        text: `Are you sure you want to block ${username}? You won't see their listings or messages.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, block!',
        cancelButtonText: 'Cancel'
      });
      
      if(result.isConfirmed) {
        const r = await req(`/block/${username}/`, 'POST');
        if(r.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: 'Blocked!',
            text: `${username} has been blocked`,
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          setTimeout(() => location.reload(), 1000);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: r.message || 'Failed to block user',
            confirmButtonColor: '#3085d6'
          });
        }
      }
    }
    
    window.blockUser = blockUser;
    
    // Review Modal ve Fonksiyonlarƒ±
    let currentReviewData = null;
    
    function openReviewModal(targetUsername, listingType, listingId, interactionId) {
      currentReviewData = {
        targetUsername,
        listingType,
        listingId,
        interactionId
      };
      $('#reviewModal').classList.add('open');
      $('#reviewRating').value = '0';
      $('#reviewComment').value = '';
      updateStars(0);
      // Yƒ±ldƒ±z rating'i ba≈ülat
      setTimeout(() => {
        const stars = document.querySelectorAll('#reviewModal .star');
        stars.forEach(star => {
          star.onclick = function() {
            const rating = parseInt(this.dataset.rating);
            $('#reviewRating').value = rating;
            updateStars(rating);
          };
          star.onmouseenter = function() {
            const rating = parseInt(this.dataset.rating);
            updateStars(rating);
          };
        });
        const starRating = document.getElementById('starRating');
        if(starRating) {
          starRating.onmouseleave = function() {
            const currentRating = parseInt($('#reviewRating').value) || 0;
            updateStars(currentRating);
          };
        }
      }, 100);
    }
    
    function closeReviewModal() {
      $('#reviewModal').classList.remove('open');
      currentReviewData = null;
    }
    
    window.closeReviewModal = closeReviewModal;
    
    // Yƒ±ldƒ±z rating sistemi - initStarRating fonksiyonu ile ba≈ülatƒ±lacak
    
    function updateStars(rating) {
      document.querySelectorAll('.star').forEach((star, index) => {
        if(index < rating) {
          star.style.color = '#fbbf24'; // Altƒ±n sarƒ±sƒ±
        } else {
          star.style.color = '#e5e7eb'; // Gri
        }
      });
    }
    
    async function checkReviewAndShowButton(targetUsername, listingType, listingId, interactionId) {
      if(!listingId) return false;
      try {
        const result = await req(`/review/check/${listingType}/${listingId}/`);
        return result.exists || false;
      } catch(err) {
        console.error('Review check error:', err);
        return false;
      }
    }
    
    let isSubmittingReview = false;
    
    async function submitReview() {
      if(!currentReviewData) return;
      
      // √áoklu tƒ±klamayƒ± engelle
      if(isSubmittingReview) return;
      isSubmittingReview = true;
      
      const rating = parseInt($('#reviewRating').value);
      if(!rating || rating < 1 || rating > 5) {
        isSubmittingReview = false;
        Swal.fire({
          icon: 'warning',
          title: 'Rating Required',
          text: 'Please select a rating (1-5 stars)',
          confirmButtonColor: '#3085d6'
        });
        return;
      }
      
      const comment = $('#reviewComment').value.trim();
      
      try {
        const reviewData = {
          rating: rating,
          comment: comment,
          target_username: currentReviewData.targetUsername
        };
        
        // Listing ID'yi ekle
        if(currentReviewData.listingType === 'offer') {
          reviewData.offer_id = currentReviewData.listingId;
        } else {
          reviewData.request_id = currentReviewData.listingId;
        }
        
        const result = await req(`/profile/${currentReviewData.targetUsername}/add-review/`, 'POST', reviewData);
        
        if(result.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: 'Thank You!',
            text: 'Your review has been submitted successfully.',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          
          closeReviewModal();
          
          // Action bar'ƒ± yenile - review submit edildikten sonra butonun kalkmasƒ± i√ßin
          if(ACTIVE_CHAT_ID) {
            try {
              // Chat bilgisini al ve action bar'ƒ± g√ºncelle
              const currentChat = await req(`/interactions/${ACTIVE_CHAT_ID}/`);
              if(currentChat) {
                updateBar(currentChat);
              }
              loadChatMessages();
            } catch(err) {
              console.error('Error updating action bar after review:', err);
              loadChatMessages();
            }
          }
          isSubmittingReview = false;
        } else {
          isSubmittingReview = false;
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Failed to submit review',
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        isSubmittingReview = false;
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Unknown error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    window.openReviewModal = openReviewModal;
    window.submitReview = submitReview;
    
    // Sayfa y√ºklendiƒüinde yƒ±ldƒ±z rating'i ba≈ülat
    function initStarRating() {
      const stars = document.querySelectorAll('.star');
      if(stars.length === 0) return;
      
      stars.forEach(star => {
        star.onclick = function() {
          const rating = parseInt(this.dataset.rating);
          $('#reviewRating').value = rating;
          updateStars(rating);
        };
        
        star.onmouseenter = function() {
          const rating = parseInt(this.dataset.rating);
          updateStars(rating);
        };
      });
      
      const starRating = document.getElementById('starRating');
      if(starRating) {
        starRating.onmouseleave = function() {
          const currentRating = parseInt($('#reviewRating').value) || 0;
          updateStars(currentRating);
        };
      }
    }
    
    function updateStars(rating) {
      document.querySelectorAll('.star').forEach((star, index) => {
        if(index < rating) {
          star.style.color = '#fbbf24'; // Altƒ±n sarƒ±sƒ±
        } else {
          star.style.color = '#e5e7eb'; // Gri
        }
      });
    }
    
    async function checkReviewAndShowButton(targetUsername, listingType, listingId, interactionId) {
      if(!listingId) return false;
      try {
        const result = await req(`/review/check/${listingType}/${listingId}/`);
        return result.exists || false;
      } catch(err) {
        console.error('Review check error:', err);
        return false;
      }
    }
    
    async function submitReview() {
      if(!currentReviewData) return;
      
      const rating = parseInt($('#reviewRating').value);
      if(!rating || rating < 1 || rating > 5) {
        Swal.fire({
          icon: 'warning',
          title: 'Rating Required',
          text: 'Please select a rating (1-5 stars)',
          confirmButtonColor: '#3085d6'
        });
        return;
      }
      
      const comment = $('#reviewComment').value.trim();
      
      try {
        const reviewData = {
          rating: rating,
          comment: comment,
          target_username: currentReviewData.targetUsername
        };
        
        // Listing ID'yi ekle
        if(currentReviewData.listingType === 'offer') {
          reviewData.offer_id = currentReviewData.listingId;
        } else {
          reviewData.request_id = currentReviewData.listingId;
        }
        
        const result = await req(`/profile/${currentReviewData.targetUsername}/add-review/`, 'POST', reviewData);
        
        if(result.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: 'Thank You!',
            text: 'Your review has been submitted successfully.',
            timer: 2000,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
          });
          
          closeReviewModal();
          
          // Action bar'ƒ± yenile
          if(ACTIVE_CHAT_ID) {
            loadChatMessages();
          }
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message || 'Failed to submit review',
            confirmButtonColor: '#3085d6'
          });
        }
      } catch(err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Unknown error occurred',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    
    // Admin Dashboard Functions
    async function loadAdminDashboard() {
      const adminView = $('#adminView');
      adminView.innerHTML = '<div style="padding:20px;text-align:center">Loading admin dashboard...</div>';
      
      try {
        // Fetch dashboard stats
        const stats = await req('/admin/dashboard-stats/');
        
        // Fetch all listings
        const [offers, requests] = await Promise.all([
          req('/service-offers/').catch(() => []),
          req('/service-requests/').catch(() => [])
        ]);
        
        // Fetch all forum topics
        const topics = await req('/forum-topics/').catch(() => []);
        
        // Combine all listings
        const allListings = [
          ...(offers || []).map(o => ({...o, type: 'offer', listing_type: 'offer'})),
          ...(requests || []).map(r => ({...r, type: 'request', listing_type: 'request'}))
        ].sort((a, b) => {
          // Sort by created_at descending (newest first)
          const dateA = new Date(a.created_at);
          const dateB = new Date(b.created_at);
          return dateB - dateA;
        });
        
        // Use actual count from listings tab instead of stats
        const actualActiveListings = allListings.length;
        
        adminView.innerHTML = `
          <div style="max-width:1400px;margin:0 auto;padding:24px">
            <h1 style="font-size:32px;font-weight:900;margin-bottom:32px;color:#1f2937">üëë Admin Control Center</h1>
            
            <!-- Overview Cards -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:32px">
              <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
                <div style="font-size:14px;color:#6b7280;margin-bottom:8px;font-weight:600">Total Users</div>
                <div style="font-size:36px;font-weight:800;color:#1f2937">${stats.total_users || 0}</div>
              </div>
              <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
                <div style="font-size:14px;color:#6b7280;margin-bottom:8px;font-weight:600">New Users (7 days)</div>
                <div style="font-size:36px;font-weight:800;color:#10b981">${stats.new_users_last_7_days || 0}</div>
              </div>
              <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
                <div style="font-size:14px;color:#6b7280;margin-bottom:8px;font-weight:600">Active Listings</div>
                <div style="font-size:36px;font-weight:800;color:#667eea">${actualActiveListings}</div>
              </div>
              <div style="background:#fff;padding:24px;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
                <div style="font-size:14px;color:#6b7280;margin-bottom:8px;font-weight:600">Forum Topics</div>
                <div style="font-size:36px;font-weight:800;color:#f59e0b">${stats.total_forum_topics || 0}</div>
              </div>
            </div>
            
            <!-- Management Tabs -->
            <div style="background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden">
              <div style="display:flex;border-bottom:2px solid #e5e7eb;background:#f9fafb">
                <button class="admin-tab-btn active" onclick="showAdminTab('listings')" style="flex:1;padding:16px;border:0;background:transparent;font-weight:700;cursor:pointer;border-bottom:3px solid #667eea">Listings</button>
                <button class="admin-tab-btn" onclick="showAdminTab('forum')" style="flex:1;padding:16px;border:0;background:transparent;font-weight:700;cursor:pointer">Forum Topics</button>
              </div>
              
              <!-- Listings Tab -->
              <div id="adminTabListings" class="admin-tab-content" style="padding:24px">
                <div style="overflow-x:auto">
                  <table style="width:100%;border-collapse:collapse">
                    <thead>
                      <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb">
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Title</th>
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Owner</th>
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Type</th>
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Date</th>
                        <th style="padding:12px;text-align:center;font-weight:700;color:#1f2937">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${allListings.length === 0 ? `
                        <tr>
                          <td colspan="5" style="padding:40px;text-align:center;color:#6b7280">No listings found</td>
                        </tr>
                      ` : allListings.map(listing => `
                        <tr style="border-bottom:1px solid #e5e7eb">
                          <td style="padding:12px;font-weight:600;color:#1f2937">${listing.title || 'Untitled'}</td>
                          <td style="padding:12px;color:#4b5563">${listing.user_info?.username || 'Unknown'}</td>
                          <td style="padding:12px">
                            <span style="padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700;background:${listing.type === 'offer' ? '#667eea' : '#10b981'};color:#fff">
                              ${listing.type === 'offer' ? 'OFFER' : 'REQUEST'}
                            </span>
                          </td>
                          <td style="padding:12px;color:#6b7280;font-size:14px">${formatDate(listing.created_at)}</td>
                          <td style="padding:12px;text-align:center">
                            <button onclick="deleteAdminListing(${listing.id}, '${listing.type}')" style="padding:6px 12px;background:#ef4444;color:#fff;border:0;border-radius:6px;font-weight:700;cursor:pointer;font-size:12px">Delete</button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Forum Tab -->
              <div id="adminTabForum" class="admin-tab-content" style="display:none;padding:24px">
                <div style="overflow-x:auto">
                  <table style="width:100%;border-collapse:collapse">
                    <thead>
                      <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb">
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Title</th>
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Author</th>
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Category</th>
                        <th style="padding:12px;text-align:left;font-weight:700;color:#1f2937">Date</th>
                        <th style="padding:12px;text-align:center;font-weight:700;color:#1f2937">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${topics.length === 0 ? `
                        <tr>
                          <td colspan="5" style="padding:40px;text-align:center;color:#6b7280">No forum topics found</td>
                        </tr>
                      ` : topics.map(topic => `
                        <tr style="border-bottom:1px solid #e5e7eb">
                          <td style="padding:12px;font-weight:600;color:#1f2937">${topic.title || 'Untitled'}</td>
                          <td style="padding:12px;color:#4b5563">${topic.author_username || 'Unknown'}</td>
                          <td style="padding:12px">
                            <span style="padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700;background:#f3f4f6;color:#6b7280;text-transform:uppercase">
                              ${topic.category || 'general'}
                            </span>
                          </td>
                          <td style="padding:12px;color:#6b7280;font-size:14px">${formatDate(topic.created_at)}</td>
                          <td style="padding:12px;text-align:center">
                            <button onclick="deleteAdminTopic(${topic.id})" style="padding:6px 12px;background:#ef4444;color:#fff;border:0;border-radius:6px;font-weight:700;cursor:pointer;font-size:12px">Delete</button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
      } catch(err) {
        adminView.innerHTML = `
          <div style="padding:40px;text-align:center">
            <div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>
            <h3 style="font-size:24px;font-weight:800;margin-bottom:12px;color:#1f2937">Access Denied</h3>
            <p style="color:#6b7280">You don't have permission to access the admin dashboard.</p>
          </div>
        `;
      }
    }
    
    function showAdminTab(tab) {
      document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.admin-tab-content').forEach(content => content.style.display = 'none');
      
      if(tab === 'listings') {
        document.querySelector('.admin-tab-btn[onclick*="listings"]').classList.add('active');
        $('#adminTabListings').style.display = 'block';
      } else if(tab === 'forum') {
        document.querySelector('.admin-tab-btn[onclick*="forum"]').classList.add('active');
        $('#adminTabForum').style.display = 'block';
      }
    }
    
    async function deleteAdminListing(id, type) {
      if(!window.confirm('Are you sure you want to delete this listing? This action cannot be undone.')) {
        return;
      }
      
      try {
        const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
        const result = await req(endpoint, 'DELETE');
        
        if(result && result.error) {
          toast('Error: ' + result.error);
        } else {
          toast('Listing deleted successfully');
          loadAdminDashboard();
        }
      } catch(err) {
        toast('Error deleting listing: ' + err.message);
      }
    }
    
    async function deleteAdminTopic(id) {
      if(!window.confirm('Are you sure you want to delete this forum topic? This action cannot be undone.')) {
        return;
      }
      
      try {
        const result = await req(`/forum-topics/${id}/`, 'DELETE');
        
        if(result && result.error) {
          toast('Error: ' + result.error);
        } else {
          toast('Forum topic deleted successfully');
          loadAdminDashboard();
        }
      } catch(err) {
        toast('Error deleting topic: ' + err.message);
      }
    }
    
    window.loadAdminDashboard = loadAdminDashboard;
    window.showAdminTab = showAdminTab;
    window.deleteAdminListing = deleteAdminListing;
    window.deleteAdminTopic = deleteAdminTopic;
    
    // Tag search functionality
    function displayTagSuggestions(tags) {
      const suggestionsEl = $('#tagSuggestions');
      if(!tags || tags.length === 0) {
        suggestionsEl.style.display = 'none';
        return;
      }
      
      suggestionsEl.innerHTML = tags.map(tag => {
        const escapedTag = tag.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `<div class="tag-suggestion" onclick="selectTag('${escapedTag}')" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #e5e7eb;transition:background .2s" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#fff'">${tag}</div>`;
      }).join('');
      suggestionsEl.style.display = 'block';
    }
    
    window.selectTag = function(tag) {
      if(!selectedTags.includes(tag)) {
        selectedTags.push(tag);
        renderSelectedTags();
      }
      $('#tagSearchInput').value = '';
      $('#tagSuggestions').style.display = 'none';
    };
    
    window.removeTag = function(tag) {
      selectedTags = selectedTags.filter(t => t !== tag);
      renderSelectedTags();
    };
    
    function renderSelectedTags() {
      const container = $('#selectedTags');
      if(selectedTags.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = selectedTags.map(tag => {
        const escapedTag = tag.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `<span class="tag-chip" style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:#667eea;color:#fff;border-radius:20px;font-size:13px;font-weight:600">
          ${tag}
          <button type="button" onclick="removeTag('${escapedTag}')" style="background:none;border:none;color:#fff;cursor:pointer;font-size:16px;line-height:1;padding:0;width:18px;height:18px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">√ó</button>
        </span>`;
      }).join('');
    }
    
    // Initialize tag search input handler
    setTimeout(() => {
      const tagSearchInput = $('#tagSearchInput');
      if(tagSearchInput) {
        tagSearchInput.oninput = function() {
          const query = this.value.trim();
          clearTimeout(tagSearchTimeout);
          
          if(query.length < 2) {
            $('#tagSuggestions').style.display = 'none';
            return;
          }
          
          tagSearchTimeout = setTimeout(async () => {
            try {
              const result = await req(`/wikidata/tags/?q=${encodeURIComponent(query)}`);
              if(result && result.tags && Array.isArray(result.tags)) {
                displayTagSuggestions(result.tags);
              }
            } catch(err) {
              console.error('Error fetching tags:', err);
            }
          }, 300);
        };
      }
      
      // Close suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if(!e.target.closest('#tagSearchInput') && !e.target.closest('#tagSuggestions')) {
          $('#tagSuggestions').style.display = 'none';
        }
      });
    }, 100);
  </script>
</body>
</html>
