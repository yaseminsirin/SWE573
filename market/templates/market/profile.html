<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ profile_user.username }}'s Profile | HIVE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);min-height:100vh;padding:20px;font-family:'Segoe UI',sans-serif}
    .container{max-width:1000px;margin:0 auto}
    .profile-header{background:#fff;border-radius:20px;padding:32px;box-shadow:0 10px 40px rgba(0,0,0,0.15);margin-bottom:24px}
    .profile-header-content{display:flex;gap:24px;align-items:center;flex-wrap:wrap}
    .avatar{width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-size:42px;font-weight:800;flex-shrink:0}
    .profile-info{flex:1}
    .username{font-size:32px;font-weight:800;color:#1f2937;margin-bottom:8px}
    .profile-stats{display:flex;gap:24px;margin-top:16px;flex-wrap:wrap}
    .stat-item{display:flex;flex-direction:column;gap:4px}
    .stat-value{font-size:24px;font-weight:800;color:#667eea}
    .stat-label{font-size:14px;color:#6b7280}
    .section{background:#fff;border-radius:20px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:24px}
    .section-title{font-size:24px;font-weight:800;color:#1f2937;margin-bottom:20px}
    .tabs{display:flex;gap:8px;margin-bottom:24px;border-bottom:2px solid #e5e7eb;padding-bottom:0}
    .tab-btn{padding:12px 24px;border:0;background:transparent;font-weight:700;color:#6b7280;cursor:pointer;font-size:15px;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;position:relative}
    .tab-btn:hover{color:#667eea}
    .tab-btn.active{color:#667eea;border-bottom-color:#667eea}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .review-tab-content{display:none}
    .review-tab-content.active{display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:20px}
    .card{background:#f9fafb;border-radius:16px;padding:20px;border:1px solid #e5e7eb;transition:transform .2s;cursor:pointer}
    .card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.1)}
    .card-title{font-size:18px;font-weight:800;color:#1f2937;margin-bottom:8px}
    .card-meta{display:flex;gap:12px;font-size:13px;color:#6b7280;margin-top:12px;flex-wrap:wrap}
    .completed-badge{background:#10b981;color:#fff;font-size:11px;font-weight:700;padding:4px 10px;border-radius:99px;display:inline-block;margin-top:8px}
    .review-item{background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid #667eea}
    .review-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .review-author{font-weight:700;color:#1f2937}
    .review-rating{color:#fbbf24;font-size:18px}
    .review-comment{color:#4b5563;line-height:1.6;margin-top:8px}
    .back-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:#fff;border-radius:12px;text-decoration:none;color:#667eea;font-weight:700;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1);transition:transform .2s}
    .back-btn:hover{transform:translateY(-2px)}
    .empty-state{text-align:center;padding:60px 20px;color:#6b7280}
    .empty-state-icon{font-size:64px;margin-bottom:16px;opacity:0.5}
    .detail-sidebar{position:fixed !important;top:0 !important;right:-100%;width:100%;max-width:420px;height:100vh !important;background:#fff;z-index:99999 !important;transition:right .3s;box-shadow:-10px 0 60px rgba(0,0,0,0.2);display:flex;flex-direction:column;overflow-y:auto;padding-top:0 !important}
    .detail-sidebar.open{right:0}
    .detail-sidebar-header{padding:20px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;background:#fff;position:sticky;top:0;z-index:10}
    .detail-sidebar-body{padding:20px;flex:1}
    .detail-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:800;text-transform:uppercase;margin-bottom:12px;letter-spacing:0.5px}
    .detail-badge.offer{background:#667eea;color:#fff}
    .detail-badge.request{background:#10b981;color:#fff}
    .detail-image{width:100%;height:200px;object-fit:cover;border-radius:12px;margin-bottom:16px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#999;font-size:14px}
    .detail-image img{width:100%;height:100%;object-fit:cover;border-radius:12px}
    .detail-title{font-size:24px;font-weight:800;margin-bottom:8px;color:#1f2937}
    .detail-meta{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .detail-meta-item{display:flex;align-items:center;gap:6px;font-size:14px;color:#666}
    .detail-description{color:#4b5563;line-height:1.6;margin-bottom:20px;font-size:15px}
    .detail-address{background:#f9fafb;padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;color:#666}
    .detail-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
    .detail-btn{flex:1;padding:12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;font-size:14px;transition:transform .2s;display:flex;align-items:center;justify-content:center;gap:8px;min-width:120px}
    .detail-btn:hover{transform:translateY(-2px)}
    .detail-btn.primary{background:#667eea;color:#fff}
    .detail-btn.secondary{background:#f3f4f6;color:#333}
    .detail-btn.danger{background:#fee2e2;color:#dc2626}
    .detail-btn.danger:hover{background:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <a href="/" class="back-btn">
      <i class="fas fa-arrow-left"></i> Back to Home
    </a>
    
    <div class="profile-header">
      <div class="profile-header-content">
        <div class="avatar">{{ profile_user.username|first|upper }}</div>
        <div class="profile-info">
          <h1 class="username">{{ profile_user.username }}</h1>
          {% if profile.bio %}
            <p style="color:#4b5563;margin-top:8px;line-height:1.6">{{ profile.bio }}</p>
          {% endif %}
          {% if profile.location %}
            <p style="color:#6b7280;margin-top:8px;font-size:14px">üìç {{ profile.location }}</p>
          {% endif %}
          <div class="profile-stats">
            <div class="stat-item">
              <span class="stat-value">‚≠ê {{ average_rating|floatformat:1 }}</span>
              <span class="stat-label">Average Rating</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">üìã {{ active_count }}</span>
              <span class="stat-label">Active Listings</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">‚úÖ {{ completed_count }}</span>
              <span class="stat-label">Completed</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">üí¨ {{ total_reviews_count }}</span>
              <span class="stat-label">Reviews</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Services & Listings</h2>
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('active', this)">
          üìã Active Listings <span style="background:#e0e7ff;color:#667eea;padding:2px 8px;border-radius:99px;font-size:12px;margin-left:6px">{{ active_count }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('completed', this)">
          ‚úÖ Completed Services <span style="background:#d1fae5;color:#059669;padding:2px 8px;border-radius:99px;font-size:12px;margin-left:6px">{{ completed_count }}</span>
        </button>
        <button class="tab-btn" onclick="showTab('reviews', this)">
          üí¨ Reviews <span style="background:#fef3c7;color:#d97706;padding:2px 8px;border-radius:99px;font-size:12px;margin-left:6px">{{ total_reviews_count }}</span>
        </button>
      </div>
      
      <!-- Active Listings Tab -->
      <div id="tab-active" class="tab-content active">
        {% if active_listings %}
          <div class="grid">
            {% for listing in active_listings %}
              <div class="card" 
                   onclick="openListingDetailFromTemplate({{ listing.id }}, '{{ listing.type }}')"
                   data-listing-id="{{ listing.id }}"
                   data-listing-type="{{ listing.type }}"
                   data-listing-title="{{ listing.title|escapejs }}"
                   data-listing-description="{{ listing.description|escapejs }}"
                   data-listing-category="{{ listing.category|escapejs }}"
                   data-listing-duration="{{ listing.duration }}"
                   data-listing-created="{{ listing.created_at|date:'c' }}"
                   data-listing-online="{{ listing.is_online|yesno:'true,false' }}"
                   data-listing-image="{{ listing.image_url|default:'' }}"
                   data-listing-address="{{ listing.address|escapejs }}"
                   data-listing-user="{{ listing.user_username|escapejs }}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                  <span style="font-size:10px;font-weight:800;padding:4px 10px;border-radius:99px;text-transform:uppercase;background:{% if listing.type == 'offer' %}#667eea{% else %}#10b981{% endif %};color:#fff">
                    {{ listing.type|upper }}
                  </span>
                  {% if listing.is_online %}
                    <span style="font-size:9px;font-weight:800;padding:4px 8px;border-radius:99px;background:#3b82f6;color:#fff">
                      üåê Online
                    </span>
                  {% endif %}
                </div>
                <h3 class="card-title">{{ listing.title }}</h3>
                <p style="color:#4b5563;font-size:14px;line-height:1.5;margin-bottom:12px">{{ listing.description|truncatewords:20 }}</p>
                <div class="card-meta">
                  <span>‚è±Ô∏è {{ listing.duration }}h</span>
                  <span>üìÇ {{ listing.category }}</span>
                  <span>üìÖ {{ listing.created_at|date:"M d, Y" }}</span>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>No active listings</p>
          </div>
        {% endif %}
      </div>
      
      <!-- Completed Services Tab -->
      <div id="tab-completed" class="tab-content">
        {% if completed_services %}
          <div class="grid">
            {% for service in completed_services %}
              <div class="card" style="position:relative">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                  <span style="font-size:10px;font-weight:800;padding:4px 10px;border-radius:99px;text-transform:uppercase;background:{% if service.type == 'offer' %}#667eea{% else %}#10b981{% endif %};color:#fff">
                    {{ service.type|upper }}
                  </span>
                  {% if service.is_online %}
                    <span style="font-size:9px;font-weight:800;padding:4px 8px;border-radius:99px;background:#3b82f6;color:#fff">
                      üåê Online
                    </span>
                  {% endif %}
                </div>
                <h3 class="card-title">{{ service.title }}</h3>
                <p style="color:#4b5563;font-size:14px;line-height:1.5;margin-bottom:12px">{{ service.description|truncatewords:20 }}</p>
                <div class="card-meta">
                  <span>‚è±Ô∏è {{ service.duration }}h</span>
                  <span>üìÇ {{ service.category }}</span>
                </div>
                <div class="completed-badge">‚úÖ Completed on {{ service.completed_at|date:"M d, Y" }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">‚úÖ</div>
            <p>No completed services yet</p>
          </div>
        {% endif %}
      </div>
      
      <!-- Reviews Tab -->
      <div id="tab-reviews" class="tab-content">
        <!-- Reviews Statistics -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;margin-bottom:32px">
          <!-- Provider Stats -->
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;padding:24px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.2)">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
              <div style="width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">üë®‚Äçüíº</div>
              <div>
                <div style="font-size:14px;opacity:0.9;font-weight:600">As Service Provider</div>
                <div style="font-size:28px;font-weight:800;margin-top:4px">{{ provider_count }}</div>
              </div>
            </div>
            {% if provider_count > 0 %}
              <div style="display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.2)">
                <span style="font-size:20px;color:#fbbf24">‚òÖ</span>
                <span style="font-size:18px;font-weight:700">{{ provider_avg }}</span>
                <span style="font-size:13px;opacity:0.8">average rating</span>
              </div>
            {% else %}
              <div style="font-size:13px;opacity:0.8;margin-top:8px">No reviews yet</div>
            {% endif %}
          </div>
          
          <!-- Consumer Stats -->
          <div style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:16px;padding:24px;color:#fff;box-shadow:0 4px 12px rgba(16,185,129,0.2)">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
              <div style="width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">üë•</div>
              <div>
                <div style="font-size:14px;opacity:0.9;font-weight:600">As Participant</div>
                <div style="font-size:28px;font-weight:800;margin-top:4px">{{ consumer_count }}</div>
              </div>
            </div>
            {% if consumer_count > 0 %}
              <div style="display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.2)">
                <span style="font-size:20px;color:#fbbf24">‚òÖ</span>
                <span style="font-size:18px;font-weight:700">{{ consumer_avg }}</span>
                <span style="font-size:13px;opacity:0.8">average rating</span>
              </div>
            {% else %}
              <div style="font-size:13px;opacity:0.8;margin-top:8px">No reviews yet</div>
            {% endif %}
          </div>
        </div>
        
        <!-- Reviews Section with Tabs -->
        <div style="margin-top:24px">
          <!-- Review Type Tabs -->
          <div class="tabs" style="margin-bottom:24px;border-bottom:2px solid #e5e7eb;padding-bottom:0">
            <button class="tab-btn active" onclick="showReviewTypeTab('provider', this)" style="padding:12px 24px;border:0;background:transparent;font-weight:700;color:#6b7280;cursor:pointer;font-size:15px;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;position:relative">
              üë®‚Äçüíº Service Provider <span style="background:#e0e7ff;color:#667eea;padding:2px 8px;border-radius:99px;font-size:12px;margin-left:6px">{{ provider_count }}</span>
            </button>
            <button class="tab-btn" onclick="showReviewTypeTab('consumer', this)" style="padding:12px 24px;border:0;background:transparent;font-weight:700;color:#6b7280;cursor:pointer;font-size:15px;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;position:relative">
              üë• Participant <span style="background:#d1fae5;color:#10b981;padding:2px 8px;border-radius:99px;font-size:12px;margin-left:6px">{{ consumer_count }}</span>
            </button>
          </div>
          
          <!-- Provider Reviews Tab -->
          <div id="review-type-provider" class="review-type-content active">
            {% if reviews_as_provider %}
              <div style="display:flex;flex-direction:column;gap:16px">
                {% for review in reviews_as_provider %}
                  <div class="review-item" style="background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;transition:all .2s">
                    <div class="review-header" style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;flex-wrap:wrap;gap:12px">
                      <div style="display:flex;align-items:center;gap:12px;flex:1">
                        <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:800;flex-shrink:0">
                          {{ review.reviewer.username|first|upper }}
                        </div>
                        <div>
                          <div style="font-weight:700;color:#1f2937;font-size:16px;margin-bottom:4px">{{ review.reviewer.username }}</div>
                          <div style="font-size:13px;color:#6b7280">{{ review.created_at|date:"M d, Y" }}</div>
                        </div>
                      </div>
                      <span class="review-rating" style="color:#fbbf24;font-size:20px;white-space:nowrap">
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                        {% endfor %}
                      </span>
                    </div>
                    {% if review.comment %}
                      <div class="review-comment" style="color:#4b5563;line-height:1.6;margin-bottom:12px;font-size:14px;padding:12px;background:#f9fafb;border-radius:8px">{{ review.comment }}</div>
                    {% endif %}
                    {% if review.offer or review.service_request %}
                      <div style="display:flex;flex-direction:column;gap:8px;padding:10px;background:#f0f9ff;border-radius:8px;border:1px solid #e0f2fe;margin-top:12px">
                        <div style="display:flex;align-items:center;gap:8px">
                          <span style="font-size:12px;font-weight:700;color:#3b82f6">üìã</span>
                          <span style="font-size:13px;color:#1e40af;font-weight:600">
                            {% if review.offer %}
                              From offer: <strong>{{ review.offer.title|truncatewords:8 }}</strong>
                            {% elif review.service_request %}
                              From request: <strong>{{ review.service_request.title|truncatewords:8 }}</strong>
                            {% endif %}
                          </span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                          <span style="font-size:11px;font-weight:700;color:#fff;background:#667eea;padding:4px 10px;border-radius:99px">As Provider</span>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state" style="padding:60px 20px;text-align:center;background:#f9fafb;border-radius:16px;border:2px dashed #e5e7eb">
                <div class="empty-state-icon" style="font-size:64px;margin-bottom:16px;opacity:0.4">üë®‚Äçüíº</div>
                <h3 style="margin:0 0 8px 0;font-size:20px;font-weight:700;color:#1f2937">No Provider Reviews Yet</h3>
                <p style="margin:0;color:#6b7280;font-size:15px">This user hasn't received any reviews as a service provider yet</p>
              </div>
            {% endif %}
          </div>
          
          <!-- Consumer Reviews Tab -->
          <div id="review-type-consumer" class="review-type-content">
            {% if reviews_as_consumer %}
              <div style="display:flex;flex-direction:column;gap:16px">
                {% for review in reviews_as_consumer %}
                  <div class="review-item" style="background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;transition:all .2s">
                    <div class="review-header" style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;flex-wrap:wrap;gap:12px">
                      <div style="display:flex;align-items:center;gap:12px;flex:1">
                        <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg, #10b981 0%, #059669 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:800;flex-shrink:0">
                          {{ review.reviewer.username|first|upper }}
                        </div>
                        <div>
                          <div style="font-weight:700;color:#1f2937;font-size:16px;margin-bottom:4px">{{ review.reviewer.username }}</div>
                          <div style="font-size:13px;color:#6b7280">{{ review.created_at|date:"M d, Y" }}</div>
                        </div>
                      </div>
                      <span class="review-rating" style="color:#fbbf24;font-size:20px;white-space:nowrap">
                        {% for i in "12345" %}
                          {% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                        {% endfor %}
                      </span>
                    </div>
                    {% if review.comment %}
                      <div class="review-comment" style="color:#4b5563;line-height:1.6;margin-bottom:12px;font-size:14px;padding:12px;background:#f9fafb;border-radius:8px">{{ review.comment }}</div>
                    {% endif %}
                    {% if review.offer or review.service_request %}
                      <div style="display:flex;flex-direction:column;gap:8px;padding:10px;background:#ecfdf5;border-radius:8px;border:1px solid #d1fae5;margin-top:12px">
                        <div style="display:flex;align-items:center;gap:8px">
                          <span style="font-size:12px;font-weight:700;color:#10b981">üìã</span>
                          <span style="font-size:13px;color:#059669;font-weight:600">
                            {% if review.offer %}
                              From offer: <strong>{{ review.offer.title|truncatewords:8 }}</strong>
                            {% elif review.service_request %}
                              From request: <strong>{{ review.service_request.title|truncatewords:8 }}</strong>
                            {% endif %}
                          </span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                          <span style="font-size:11px;font-weight:700;color:#fff;background:#10b981;padding:4px 10px;border-radius:99px">As Consumer</span>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state" style="padding:60px 20px;text-align:center;background:#f9fafb;border-radius:16px;border:2px dashed #e5e7eb">
                <div class="empty-state-icon" style="font-size:64px;margin-bottom:16px;opacity:0.4">üë•</div>
                <h3 style="margin:0 0 8px 0;font-size:20px;font-weight:700;color:#1f2937">No Participant Reviews Yet</h3>
                <p style="margin:0;color:#6b7280;font-size:15px">This user hasn't received any reviews as a participant yet</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- Detail Sidebar -->
  <aside class="detail-sidebar" id="detailSidebar">
    <div class="detail-sidebar-header">
      <h3 style="margin:0;font-size:20px;font-weight:800">Listing Details</h3>
      <button onclick="closeDetailSidebar()" style="border:0;background:none;font-size:24px;cursor:pointer;color:#666">√ó</button>
    </div>
    <div class="detail-sidebar-body" id="detailSidebarBody">
      <!-- ƒ∞√ßerik dinamik olarak doldurulacak -->
    </div>
  </aside>
  
  <script>
    const USER = {{ request.user.id|default:"null" }};
    const USERNAME = "{{ request.user.username|default:'' }}";
    const TOKEN = localStorage.getItem('token') || '';
    
    // API request helper
    async function req(endpoint, method = 'GET', body = null) {
      try {
        const headers = {'Authorization': `Bearer ${TOKEN}`};
        if(method !== 'DELETE') headers['Content-Type'] = 'application/json';
        
        const fetchOptions = {
          method: method,
          headers: headers
        };
        
        // DELETE i√ßin body g√∂nderme
        if(method !== 'DELETE' && body) {
          fetchOptions.body = JSON.stringify(body);
        }
        
        const r = await fetch(`/api${endpoint}`, fetchOptions);
        if(r.status === 401) {
          localStorage.clear();
          window.location.reload();
          return;
        }
        // DELETE i√ßin bo≈ü response olabilir
        if(r.status === 204 || (method === 'DELETE' && r.status === 200)) {
          return {success: true};
        }
        const data = await r.json();
        return data;
      } catch(err) {
        console.error('Request failed:', err);
        return {error: err.message || 'Request failed'};
      }
    }
    
    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    // Open listing detail sidebar from template data
    function openListingDetailFromTemplate(id, type) {
      // Find the card element and get data attributes
      const card = document.querySelector(`[data-listing-id="${id}"][data-listing-type="${type}"]`);
      if (!card) {
        console.error('Listing card not found');
        return;
      }
      
      const listingData = {
        id: parseInt(card.dataset.listingId),
        type: card.dataset.listingType,
        title: card.dataset.listingTitle || '',
        description: card.dataset.listingDescription || '',
        category: card.dataset.listingCategory || '',
        duration: parseInt(card.dataset.listingDuration) || 0,
        created_at: card.dataset.listingCreated || '',
        is_online: card.dataset.listingOnline === 'true',
        image_url: card.dataset.listingImage || '',
        address: card.dataset.listingAddress || '',
        user_username: card.dataset.listingUser || '',
      };
      
      const body = document.getElementById('detailSidebarBody');
      const isOwn = listingData.user_username === USERNAME;
      
      // Badge HTML
      const badgeClass = type === 'offer' ? 'offer' : 'request';
      const badgeText = type === 'offer' ? 'OFFER' : 'REQUEST';
      const onlineBadge = listingData.is_online ? '<span class="detail-online-badge" style="display:inline-flex;align-items:center;gap:6px;background:#3b82f6;color:#fff;padding:6px 12px;border-radius:99px;font-size:12px;font-weight:700;margin-left:8px"><i class="fas fa-globe"></i> Online / Remote</span>' : '';
      
      // Resim HTML
      const imageHtml = listingData.image_url ? 
        `<div class="detail-image"><img src="${listingData.image_url}" alt="${listingData.title || ''}"></div>` : '';
      
      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      body.innerHTML = `
        <span class="detail-badge ${badgeClass}">${badgeText}</span>${onlineBadge}
        ${imageHtml}
        <h2 class="detail-title">${escapeHtml(listingData.title || 'Untitled')}</h2>
        <div class="detail-meta">
          <div class="detail-meta-item"><span>üë§</span> <a href="/profile/${escapeHtml(listingData.user_username || 'unknown')}/" style="color:#667eea;text-decoration:none;font-weight:700">${escapeHtml(listingData.user_username || 'Unknown')}</a></div>
          <div class="detail-meta-item"><span>‚è±Ô∏è</span> <span>${listingData.duration || 0}h</span></div>
          <div class="detail-meta-item"><span>üìÇ</span> <span>${escapeHtml(listingData.category || '')}</span></div>
          <div class="detail-meta-item"><span>üìÖ</span> <span>${listingData.created_at ? formatDate(listingData.created_at) : ''}</span></div>
        </div>
        <div class="detail-description">${escapeHtml(listingData.description || '')}</div>
        ${listingData.address ? `<div class="detail-address">üìç ${escapeHtml(listingData.address)}</div>` : ''}
        ${!isOwn && USER ? `
          <div class="detail-actions">
            <button class="detail-btn primary" onclick="startChatFromDetail(${id}, '${type}')">Contact</button>
            <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
          </div>
        ` : `
          <div class="detail-actions">
            <button class="detail-btn danger" onclick="deleteListingFromDetail(${id}, '${type}')">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
            <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
          </div>
        `}
      `;
      document.getElementById('detailSidebar').classList.add('open');
    }
    
    function closeDetailSidebar() {
      document.getElementById('detailSidebar').classList.remove('open');
    }
    
    async function startChatFromDetail(id, type) {
      closeDetailSidebar();
      // Anasayfaya y√∂nlendir ve chat ba≈ülat
      window.location.href = `/?view=${type}s#listing-${id}`;
    }
    
    async function deleteListingFromDetail(id, type) {
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        zIndex: 99999,
      });
      
      if(!result.isConfirmed) {
        return;
      }
      
      try {
        const endpoint = type === 'offer' ? `/service-offers/${id}/` : `/service-requests/${id}/`;
        const deleteResult = await req(endpoint, 'DELETE');
        
        // DELETE ba≈üarƒ±lƒ± olabilir (204 No Content veya success response)
        // Hata kontrol√º
        if(deleteResult && deleteResult.error) {
          await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: deleteResult.error,
            confirmButtonColor: '#3085d6',
            zIndex: 99999,
          });
          return;
        }
        
        // Ba≈üarƒ±lƒ± mesajƒ± g√∂ster
        Swal.fire({
          icon: 'success',
          title: 'Deleted!',
          text: 'Listing deleted successfully!',
          timer: 2000,
          showConfirmButton: false,
          position: 'top-end',
          toast: true,
          zIndex: 99999,
        });
        
        // Detail sidebar'ƒ± kapat
        closeDetailSidebar();
        
        // Profil sayfasƒ±nƒ± yenile
        window.location.reload();
      } catch(err) {
        await Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Unknown error occurred',
          confirmButtonColor: '#3085d6',
          zIndex: 99999,
        });
      }
    }
    
    window.deleteListingFromDetail = deleteListingFromDetail;
    
    function showTab(tabName, element) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById('tab-' + tabName).classList.add('active');
      if(element) {
        element.classList.add('active');
      }
    }
    
    // Show review sub-tab (Received or Given)
    
    // Open listing detail from review
    async function openListingDetailFromReview(id, type) {
      if(!id || id === 0) return;
      try {
        const endpoint = type === 'offer' ? `/api/service-offers/${id}/` : `/api/service-requests/${id}/`;
        const listingData = await req(endpoint);
        
        if(!listingData || !listingData.id) {
          console.error('Listing not found');
          return;
        }
        
        const body = document.getElementById('detailSidebarBody');
        const isOwn = listingData.user_info && listingData.user_info.username === USERNAME;
        
        // Badge HTML
        const badgeClass = type === 'offer' ? 'offer' : 'request';
        const badgeText = type === 'offer' ? 'OFFER' : 'REQUEST';
        const onlineBadge = listingData.is_online ? '<span class="detail-online-badge" style="display:inline-flex;align-items:center;gap:6px;background:#3b82f6;color:#fff;padding:6px 12px;border-radius:99px;font-size:12px;font-weight:700;margin-left:8px"><i class="fas fa-globe"></i> Online / Remote</span>' : '';
        
        // Resim HTML
        const imageHtml = listingData.image_url ? 
          `<div class="detail-image"><img src="${listingData.image_url}" alt="${listingData.title || ''}"></div>` : '';
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
          if (!text) return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
        
        body.innerHTML = `
          <span class="detail-badge ${badgeClass}">${badgeText}</span>${onlineBadge}
          ${imageHtml}
          <h2 class="detail-title">${escapeHtml(listingData.title || 'Untitled')}</h2>
          <div class="detail-meta">
            <div class="detail-meta-item"><span>üë§</span> <a href="/profile/${escapeHtml(listingData.user_info?.username || 'unknown')}/" style="color:#667eea;text-decoration:none;font-weight:700">${escapeHtml(listingData.user_info?.username || 'Unknown')}</a></div>
            <div class="detail-meta-item"><span>‚è±Ô∏è</span> <span>${listingData.duration || 0}h</span></div>
            <div class="detail-meta-item"><span>üìÇ</span> <span>${escapeHtml(listingData.category || '')}</span></div>
            <div class="detail-meta-item"><span>üìÖ</span> <span>${listingData.created_at ? formatDate(listingData.created_at) : ''}</span></div>
          </div>
          <div class="detail-description">${escapeHtml(listingData.description || '')}</div>
          ${listingData.address ? `<div class="detail-address">üìç ${escapeHtml(listingData.address)}</div>` : ''}
          ${!isOwn && USER ? `
            <div class="detail-actions">
              <button class="detail-btn primary" onclick="startChatFromDetail(${id}, '${type}')">Contact</button>
              <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
            </div>
          ` : `
            <div class="detail-actions">
              <button class="detail-btn secondary" onclick="closeDetailSidebar()">Close</button>
            </div>
          `}
        `;
        document.getElementById('detailSidebar').classList.add('open');
      } catch(err) {
        console.error('Error loading listing:', err);
      }
    }
    
    window.openListingDetailFromReview = openListingDetailFromReview;
    
    // Review type tab switching
    function showReviewTypeTab(tabName, element) {
      // Hide all review type tabs
      document.querySelectorAll('.review-type-content').forEach(tab => {
        tab.classList.remove('active');
      });
      // Remove active class from all review type tab buttons (only the ones in reviews section)
      const reviewTypeTabButtons = document.querySelectorAll('#tab-reviews .tabs .tab-btn');
      reviewTypeTabButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottomColor = 'transparent';
        btn.style.color = '#6b7280';
      });
      
      // Show selected review type tab
      const targetTab = document.getElementById('review-type-' + tabName);
      if(targetTab) {
        targetTab.classList.add('active');
      }
      
      if(element) {
        element.classList.add('active');
        element.style.borderBottomColor = tabName === 'provider' ? '#667eea' : '#10b981';
        element.style.color = '#1f2937';
      }
    }
    
    window.showReviewTypeTab = showReviewTypeTab;
  </script>
  <style>
    .review-type-content {
      display: none;
    }
    .review-type-content.active {
      display: block;
    }
  </style>
</body>
</html>

